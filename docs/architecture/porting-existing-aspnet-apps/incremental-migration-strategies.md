---
title: 增量迁移策略
description: 团队可以采用哪些战略，使他们能够以增量方式将大型应用从 ASP.NET MVC 迁移到 .NET Core？
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 615d2a853b698bfc752c3baf36f31ab2a4f2bab8
ms.sourcegitcommit: b5d2290673e1c91260c9205202dd8b95fbab1a0b
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/01/2021
ms.locfileid: "106122880"
---
# <a name="strategies-for-migrating-incrementally"></a><span data-ttu-id="1193b-103">增量迁移策略</span><span class="sxs-lookup"><span data-stu-id="1193b-103">Strategies for migrating incrementally</span></span>

<span data-ttu-id="1193b-104">迁移任何大型应用程序的最大挑战是确定如何将该过程分解为更小的任务。</span><span class="sxs-lookup"><span data-stu-id="1193b-104">The biggest challenge with migrating any large app is determining how to break the process into smaller tasks.</span></span> <span data-ttu-id="1193b-105">可以应用多个策略来实现此目的，包括将应用分解为水平层，如 UI、数据访问、业务逻辑，或将应用分解为单独的小型应用。</span><span class="sxs-lookup"><span data-stu-id="1193b-105">There are several strategies that can be applied for this purpose, including breaking the app into horizontal layers such as UI, data access, business logic, or breaking up the app into separate, smaller apps.</span></span> <span data-ttu-id="1193b-106">另一种策略是将应用程序的部分或全部升级到最新的 .NET Core 版本。</span><span class="sxs-lookup"><span data-stu-id="1193b-106">Another strategy is to upgrade some or all of the app to different framework versions on the way to a recent .NET Core release.</span></span> <span data-ttu-id="1193b-107">您可以使用的一种方法是迁移应用程序的 [垂直切片](https://deviq.com/practices/vertical-slices) ，而不是尝试一次迁移一个水平层。</span><span class="sxs-lookup"><span data-stu-id="1193b-107">One approach you could use is to migrate [vertical slices](https://deviq.com/practices/vertical-slices) of the app, rather than attempting to migrate one horizontal layer at a time.</span></span> <span data-ttu-id="1193b-108">让我们考虑一下其中每个不同的方法。</span><span class="sxs-lookup"><span data-stu-id="1193b-108">Let's consider each of these different approaches.</span></span>

## <a name="migrating-slice-by-slice"></a><span data-ttu-id="1193b-109">按切片迁移切片</span><span class="sxs-lookup"><span data-stu-id="1193b-109">Migrating slice by slice</span></span>

<span data-ttu-id="1193b-110">一种成功的迁移方法是识别功能的垂直切片，并逐个地将其迁移到目标平台。</span><span class="sxs-lookup"><span data-stu-id="1193b-110">One successful approach to migrating is to identify vertical slices of functionality and migrate them to the target platform one by one.</span></span> <span data-ttu-id="1193b-111">第一步是创建新的 ASP.NET Core 3.1 或5应用。</span><span class="sxs-lookup"><span data-stu-id="1193b-111">The first step is to create a new ASP.NET Core 3.1 or 5 app.</span></span> <span data-ttu-id="1193b-112">接下来，确定将首先迁移的单个页面或 API 终结点。</span><span class="sxs-lookup"><span data-stu-id="1193b-112">Next, identify the individual page or API endpoint that will be migrated first.</span></span> <span data-ttu-id="1193b-113">仅构建必要的功能，以便在 ASP.NET Core 应用程序中支持这一路由。</span><span class="sxs-lookup"><span data-stu-id="1193b-113">Build out just the necessary functionality to support this one route in the ASP.NET Core app.</span></span> <span data-ttu-id="1193b-114">然后，使用 HTTP 重写和/或反向代理开始向新应用程序（而不是 ASP.NET 应用程序）发送这些页或终结点的请求。</span><span class="sxs-lookup"><span data-stu-id="1193b-114">Then use HTTP rewriting and/or a reverse proxy to start sending requests for these pages or endpoints to the new app rather than the ASP.NET app.</span></span> <span data-ttu-id="1193b-115">此方法非常适合 API 项目，但也适用于许多 MVC 应用。</span><span class="sxs-lookup"><span data-stu-id="1193b-115">This approach is well-suited to API projects, but can also work for many MVC apps.</span></span>

<span data-ttu-id="1193b-116">在按切片迁移切片时，会在新项目或解决方案中重新创建单个 API 终结点或请求的路由的整个堆栈。</span><span class="sxs-lookup"><span data-stu-id="1193b-116">When migrating slice by slice, the entire stack of the individual API endpoint or requested route is recreated in the new project or solution.</span></span> <span data-ttu-id="1193b-117">首先，此类切片通常需要完成的工作量最大，因为通常需要创建多个项目，并做出有关数据访问和解决方案组织的决策。</span><span class="sxs-lookup"><span data-stu-id="1193b-117">The very first such slice typically requires the most effort, since it will typically need several projects to be created and decisions to be made about data access and solution organization.</span></span> <span data-ttu-id="1193b-118">第一扇区的功能反映了现有应用的功能之后，就可以对其进行部署，现有应用可以重定向到该应用，也可以直接将其删除。</span><span class="sxs-lookup"><span data-stu-id="1193b-118">Once the first slice's functionality mirrors the existing app's, it can be deployed and the existing app can redirect to it or simply be removed.</span></span> <span data-ttu-id="1193b-119">此方法随后会重复出现，直到整个应用都移植到新的结构。</span><span class="sxs-lookup"><span data-stu-id="1193b-119">This approach is then repeated until the entire app has been ported to the new structure.</span></span>

<span data-ttu-id="1193b-120">有关如何使用 IIS 遵循此策略的一些具体指导 [，请参阅部署方案第5章](deployment-scenarios.md)。</span><span class="sxs-lookup"><span data-stu-id="1193b-120">Some specific guidance on how to follow this strategy using IIS is covered in [Chapter 5, Deployment Scenarios](deployment-scenarios.md).</span></span>

## <a name="migrating-layer-by-layer"></a><span data-ttu-id="1193b-121">按层迁移层</span><span class="sxs-lookup"><span data-stu-id="1193b-121">Migrating layer by layer</span></span>

<span data-ttu-id="1193b-122">考虑迁移大型 ASP.NET 4.5 应用的挑战。</span><span class="sxs-lookup"><span data-stu-id="1193b-122">Consider the challenge of migrating a large ASP.NET 4.5 app.</span></span> <span data-ttu-id="1193b-123">一种方法是将整个应用直接从 .NET Framework 4.5 迁移到 .NET Core 3.1。</span><span class="sxs-lookup"><span data-stu-id="1193b-123">One approach is to migrate the entire app directly from .NET Framework 4.5 to .NET Core 3.1.</span></span> <span data-ttu-id="1193b-124">但是，这种方法需要考虑两个框架和版本之间的每个重大更改，这一点很重要。</span><span class="sxs-lookup"><span data-stu-id="1193b-124">However, this approach needs to account for every breaking change between the two frameworks and versions, which are substantial.</span></span> <span data-ttu-id="1193b-125">一次在一个项目上执行此操作提供一组步进石子，使整个解决方案不需要同时移动。</span><span class="sxs-lookup"><span data-stu-id="1193b-125">Performing this work on one project at a time provides a set of stepping stones so that the entire solution doesn't need to be moved at once.</span></span>

<span data-ttu-id="1193b-126">对 .NET 生态系统的最新补充，有助于在不同的 .NET [.NET Standard](https://dotnet.microsoft.com/platform/dotnet-standard)框架之间实现互操作性。</span><span class="sxs-lookup"><span data-stu-id="1193b-126">One recent addition to the .NET ecosystem that helps with interoperability between different .NET frameworks is [.NET Standard](https://dotnet.microsoft.com/platform/dotnet-standard).</span></span> <span data-ttu-id="1193b-127">.NET Standard 允许根据一组标准 Api 构建库，确保它们可在任何 .NET 应用中使用。</span><span class="sxs-lookup"><span data-stu-id="1193b-127">.NET Standard allows libraries to build against the agreed upon set of common APIs, ensuring they can be used in any .NET app.</span></span> <span data-ttu-id="1193b-128">.NET Standard 2.0 很明显，因为它涵盖大多数 .NET Framework 和 .NET Core 应用使用的大多数基类库功能。</span><span class="sxs-lookup"><span data-stu-id="1193b-128">.NET Standard 2.0 is notable because it covers most base class library functionality used by most .NET Framework and .NET Core apps.</span></span> <span data-ttu-id="1193b-129">遗憾的是，支持 .NET Standard 2.0 的最早版本的 .NET .NET Framework 4.6.1，在 .NET Framework 4.8 中有大量更新，这使其成为初次升级的极具吸引力的选择。</span><span class="sxs-lookup"><span data-stu-id="1193b-129">Unfortunately, the earliest version of .NET with support for .NET Standard 2.0 is .NET Framework 4.6.1, and there are a number of updates in .NET Framework 4.8 that make it a compelling choice for initial upgrades.</span></span>

<span data-ttu-id="1193b-130">逐步升级 .NET Framework 4.5 系统层的一种方法是先将其类库依赖项更新为 .NET Framework 4.8。</span><span class="sxs-lookup"><span data-stu-id="1193b-130">One approach to incrementally upgrade a .NET Framework 4.5 system layer-by-layer is to first update its class library dependencies to .NET Framework 4.8.</span></span> <span data-ttu-id="1193b-131">然后，将这些库修改为 .NET Standard 类库。</span><span class="sxs-lookup"><span data-stu-id="1193b-131">Then, modify these libraries to be .NET Standard class libraries.</span></span> <span data-ttu-id="1193b-132">如有必要，请使用多目标编译和条件编译。</span><span class="sxs-lookup"><span data-stu-id="1193b-132">Use multi-targeting and conditional compilation, if necessary.</span></span> <span data-ttu-id="1193b-133">在应用程序依赖项需要 .NET Framework 且不能轻松直接移植到使用 .NET Standard 和 .NET Core 的方案中，此步骤非常有用。</span><span class="sxs-lookup"><span data-stu-id="1193b-133">This step can be helpful in scenarios where app dependencies require .NET Framework and cannot easily be ported directly to use .NET Standard and .NET Core.</span></span> <span data-ttu-id="1193b-134">由于 ASP.NET Core 2.1 应用可以使用 .NET Framework 库，因此下一步是将应用程序的部分或全部 web 功能迁移到 ASP.NET Core 2.1 (，如 [前一章](choose-net-core-version.md)) 所述。</span><span class="sxs-lookup"><span data-stu-id="1193b-134">Since .NET Framework libraries can be consumed by ASP.NET Core 2.1 apps, the next step is to migrate some or all of the web functionality of the app to ASP.NET Core 2.1 (as described in the [previous chapter](choose-net-core-version.md)).</span></span> <span data-ttu-id="1193b-135">这是一个 "自下而上的" 方法，从低级别类库依赖项开始，到 web 应用入口点工作。</span><span class="sxs-lookup"><span data-stu-id="1193b-135">This is a "bottom up" approach, starting with low level class library dependencies and working up to the web app entry point.</span></span>

<span data-ttu-id="1193b-136">在 ASP.NET Core 2.1 上运行应用程序后，将其迁移到 ASP.NET Core 3.1 隔离相对比较简单。</span><span class="sxs-lookup"><span data-stu-id="1193b-136">Once the app is running on ASP.NET Core 2.1, migrating it to ASP.NET Core 3.1 in isolation is relatively straightforward.</span></span> <span data-ttu-id="1193b-137">此步骤中最可能的难题是更新不兼容的依赖项，以支持 .NET Core 和可能更高版本的 .NET Standard。</span><span class="sxs-lookup"><span data-stu-id="1193b-137">The most likely challenge during this step is updating incompatible dependencies to support .NET Core and possibly higher versions of .NET Standard.</span></span> <span data-ttu-id="1193b-138">对于不依赖于 .NET Framework 库的依赖项的应用程序，无需升级到 ASP.NET Core 2.1。</span><span class="sxs-lookup"><span data-stu-id="1193b-138">For apps that don't have problematic dependencies on .NET Framework-only libraries, there's little reason to upgrade to ASP.NET Core 2.1.</span></span> <span data-ttu-id="1193b-139">直接迁移到 ASP.NET Core 3.1 更有意义，需要更少的工作量。</span><span class="sxs-lookup"><span data-stu-id="1193b-139">Porting directly to ASP.NET Core 3.1 makes more sense and requires less effort.</span></span>

<span data-ttu-id="1193b-140">当应用程序在 .NET Core 3.1 上运行时，迁移到当前的 .NET 5 版本相对较为轻松。</span><span class="sxs-lookup"><span data-stu-id="1193b-140">By the time the app is running on .NET Core 3.1, migrating to the current .NET 5 release is relatively painless.</span></span> <span data-ttu-id="1193b-141">此过程主要涉及更新项目文件的目标框架及其关联的 NuGet 包依赖项。</span><span class="sxs-lookup"><span data-stu-id="1193b-141">The process primarily involves updating the target framework of your project files and their associated NuGet package dependencies.</span></span> <span data-ttu-id="1193b-142">尽管有几项 [重大更改需要考虑](../../core/compatibility/5.0.md)，但大多数应用程序不需要对从 .net Core 3.1 到 .net 5 的重大修改。</span><span class="sxs-lookup"><span data-stu-id="1193b-142">While there are several [breaking changes to consider](../../core/compatibility/5.0.md), most apps don't require significant modifications to move from .NET Core 3.1 to .NET 5.</span></span> <span data-ttu-id="1193b-143">在 [.Net Core 3.1 和 .net 5 之间进行选择](choose-net-core-version.md)的主要决定因素可能是支持。</span><span class="sxs-lookup"><span data-stu-id="1193b-143">The primary deciding factor in [choosing between .NET Core 3.1 and .NET 5 is likely to be support](choose-net-core-version.md).</span></span>

<span data-ttu-id="1193b-144">作为另一种替代方法，另一种替代方法是从 web 应用 (甚至整个解决方案开始) 并使用自动化工具来帮助进行升级。</span><span class="sxs-lookup"><span data-stu-id="1193b-144">Instead of a "bottom up" approach, another alternative is to start with the web app (or even the entire solution) and use an automated tool to assist with the upgrade.</span></span> <span data-ttu-id="1193b-145">[.Net 升级助手工具](https://aka.ms/dotnet-upgrade-assistant)可用于帮助将 .NET Framework 应用升级到 .net Core/.net 5。</span><span class="sxs-lookup"><span data-stu-id="1193b-145">The [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assistant) can be used to help upgrade .NET Framework apps to .NET Core / .NET 5.</span></span> <span data-ttu-id="1193b-146">它自动执行许多与升级应用相关的常见任务，例如修改项目文件格式、设置适当的目标框架、更新 NuGet 依赖关系等。</span><span class="sxs-lookup"><span data-stu-id="1193b-146">It automates many of the common tasks related to upgrading apps, such as modifying project file format, setting appropriate target frameworks, updating NuGet dependencies, and more.</span></span>

<span data-ttu-id="1193b-147">作为另一种替代方法，另一种替代方法是从 web 应用 (甚至整个解决方案开始) 并使用自动化工具来帮助进行升级。</span><span class="sxs-lookup"><span data-stu-id="1193b-147">Instead of a "bottom up" approach, another alternative is to start with the web app (or even the entire solution) and use an automated tool to assist with the upgrade.</span></span> <span data-ttu-id="1193b-148">[.Net 升级助手工具](https://aka.ms/dotnet-upgrade-assistant)可用于帮助将 .NET Framework 应用升级到 .net Core/.net 5。</span><span class="sxs-lookup"><span data-stu-id="1193b-148">The [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assistant) can be used to help upgrade .NET Framework apps to .NET Core / .NET 5.</span></span> <span data-ttu-id="1193b-149">它自动执行许多与升级应用相关的常见任务，例如修改项目文件格式、设置适当的目标框架、更新 NuGet 依赖关系等。</span><span class="sxs-lookup"><span data-stu-id="1193b-149">It automates many of the common tasks related to upgrading apps, such as modifying project file format, setting appropriate target frameworks, updating NuGet dependencies, and more.</span></span>

## <a name="references"></a><span data-ttu-id="1193b-150">参考</span><span class="sxs-lookup"><span data-stu-id="1193b-150">References</span></span>

- [<span data-ttu-id="1193b-151">什么是 .NET Standard？</span><span class="sxs-lookup"><span data-stu-id="1193b-151">What is .NET Standard?</span></span>](https://dotnet.microsoft.com/platform/dotnet-standard)
- [<span data-ttu-id="1193b-152">.NET 5 简介</span><span class="sxs-lookup"><span data-stu-id="1193b-152">Introducing .NET 5</span></span>](https://devblogs.microsoft.com/dotnet/introducing-net-5/)
- [<span data-ttu-id="1193b-153">从 ASP.NET Core 3.1 迁移到5。0</span><span class="sxs-lookup"><span data-stu-id="1193b-153">Migrate from ASP.NET Core 3.1 to 5.0</span></span>](/aspnet/core/migration/31-to-50)
- [<span data-ttu-id="1193b-154">.NET 升级助手工具</span><span class="sxs-lookup"><span data-stu-id="1193b-154">.NET Upgrade Assistant tool</span></span>](https://aka.ms/dotnet-upgrade-assistant)

>[!div class="step-by-step"]
><span data-ttu-id="1193b-155">[上一页](choose-net-core-version.md)
>[下一页](migrate-web-forms.md)</span><span class="sxs-lookup"><span data-stu-id="1193b-155">[Previous](choose-net-core-version.md)
[Next](migrate-web-forms.md)</span></span>

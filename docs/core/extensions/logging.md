---
title: .NET 中的日志记录
author: IEvangelist
description: 了解如何使用由 Microsoft Extension.Logging NuGet 包提供的日志记录框架。
ms.author: dapine
ms.date: 02/19/2021
ms.openlocfilehash: 834331b9e103138012bbe91586d0d5a7c08654ce
ms.sourcegitcommit: bdbf6472de867a0a11aaa5b9384a2506c24f27d2
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/05/2021
ms.locfileid: "102401983"
---
# <a name="logging-in-net"></a><span data-ttu-id="56d04-103">.NET 中的日志记录</span><span class="sxs-lookup"><span data-stu-id="56d04-103">Logging in .NET</span></span>

<span data-ttu-id="56d04-104">.NET 支持适用于各种内置和第三方日志记录提供程序的日志记录 API。</span><span class="sxs-lookup"><span data-stu-id="56d04-104">.NET supports a logging API that works with a variety of built-in and third-party logging providers.</span></span> <span data-ttu-id="56d04-105">本文介绍了如何将日志记录 API 与内置提供程序一起使用。</span><span class="sxs-lookup"><span data-stu-id="56d04-105">This article shows how to use the logging API with built-in providers.</span></span> <span data-ttu-id="56d04-106">本文中提供的大多数代码示例都适用于使用[通用主机](generic-host.md)的 .NET 应用。</span><span class="sxs-lookup"><span data-stu-id="56d04-106">Most of the code examples shown in this article apply to any .NET app that uses the [Generic Host](generic-host.md).</span></span> <span data-ttu-id="56d04-107">对于不使用通用主机的应用，请参阅[非主机控制台应用](#non-host-console-app)。</span><span class="sxs-lookup"><span data-stu-id="56d04-107">For apps that don't use the Generic Host, see [Non-host console app](#non-host-console-app).</span></span>

## <a name="create-logs"></a><span data-ttu-id="56d04-108">创建日志</span><span class="sxs-lookup"><span data-stu-id="56d04-108">Create logs</span></span>

<span data-ttu-id="56d04-109">若要创建日志，请使用[依赖关系注入 (DI)](dependency-injection.md) 中的 <xref:Microsoft.Extensions.Logging.ILogger%601> 对象。</span><span class="sxs-lookup"><span data-stu-id="56d04-109">To create logs, use an <xref:Microsoft.Extensions.Logging.ILogger%601> object from [dependency injection (DI)](dependency-injection.md).</span></span>

<span data-ttu-id="56d04-110">如下示例中：</span><span class="sxs-lookup"><span data-stu-id="56d04-110">The following example:</span></span>

- <span data-ttu-id="56d04-111">创建一个记录器 `ILogger<Worker>`，该记录器使用类型为 `Worker` 的完全限定名称的日志类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-111">Creates a logger, `ILogger<Worker>`, which uses a log *category* of the fully qualified name of the type `Worker`.</span></span> <span data-ttu-id="56d04-112">日志类别是与每个日志关联的字符串。</span><span class="sxs-lookup"><span data-stu-id="56d04-112">The log category is a string that is associated with each log.</span></span>
- <span data-ttu-id="56d04-113">调用 <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogInformation%2A> 以在 `Information` 级别登录。</span><span class="sxs-lookup"><span data-stu-id="56d04-113">Calls <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogInformation%2A> to log at the `Information` level.</span></span> <span data-ttu-id="56d04-114">日志“级别”代表所记录事件的严重程度  。</span><span class="sxs-lookup"><span data-stu-id="56d04-114">The Log *level* indicates the severity of the logged event.</span></span>

:::code language="csharp" source="snippets/configuration/worker-service/Worker.cs" range="9-24" highlight="12":::

<span data-ttu-id="56d04-115">本文稍后部分将更详细地介绍[级别](#log-level)和[类别](#log-category)。</span><span class="sxs-lookup"><span data-stu-id="56d04-115">[Levels](#log-level) and [categories](#log-category) are explained in more detail later in this article.</span></span>

## <a name="configure-logging"></a><span data-ttu-id="56d04-116">配置日志记录</span><span class="sxs-lookup"><span data-stu-id="56d04-116">Configure logging</span></span>

<span data-ttu-id="56d04-117">日志配置通常由 appsettings `{Environment}`.json 文件的 `Logging` 部分提供 。</span><span class="sxs-lookup"><span data-stu-id="56d04-117">Logging configuration is commonly provided by the `Logging` section of *appsettings*.`{Environment}`*.json* files.</span></span> <span data-ttu-id="56d04-118">以下 appsettings.Development.json 文件由 .NET 辅助角色服务模板生成：</span><span class="sxs-lookup"><span data-stu-id="56d04-118">The following *appsettings.Development.json* file is generated by the .NET Worker service templates:</span></span>

:::code language="json" source="snippets/configuration/worker-service/appsettings.Development.json":::

<span data-ttu-id="56d04-119">在上述 JSON 中：</span><span class="sxs-lookup"><span data-stu-id="56d04-119">In the preceding JSON:</span></span>

- <span data-ttu-id="56d04-120">指定了 `"Default"`、`"Microsoft"` 和 `"Microsoft.Hosting.Lifetime"` 类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-120">The `"Default"`, `"Microsoft"`, and `"Microsoft.Hosting.Lifetime"` categories are specified.</span></span>
- <span data-ttu-id="56d04-121">`"Microsoft"` 类别适用于以 `"Microsoft"` 开头的所有类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-121">The `"Microsoft"` category applies to all categories that start with `"Microsoft"`.</span></span>
- <span data-ttu-id="56d04-122">`"Microsoft"` 类别在日志级别 `Warning` 或更高级别记录。</span><span class="sxs-lookup"><span data-stu-id="56d04-122">The `"Microsoft"` category logs at log level `Warning` and higher.</span></span>
- <span data-ttu-id="56d04-123">`"Microsoft.Hosting.Lifetime"` 类别比 `"Microsoft"` 类别更具体，因此 `"Microsoft.Hosting.Lifetime"` 类别在日志级别“Information”和更高级别记录。</span><span class="sxs-lookup"><span data-stu-id="56d04-123">The `"Microsoft.Hosting.Lifetime"` category is more specific than the `"Microsoft"` category, so the `"Microsoft.Hosting.Lifetime"` category logs at log level "Information" and higher.</span></span>
- <span data-ttu-id="56d04-124">未指定特定的日志提供程序，因此 `LogLevel` 适用于所有启用的日志记录提供程序，但 [Windows EventLog](logging-providers.md#windows-eventlog) 除外。</span><span class="sxs-lookup"><span data-stu-id="56d04-124">A specific log provider is not specified, so `LogLevel` applies to all the enabled logging providers except for the [Windows EventLog](logging-providers.md#windows-eventlog).</span></span>

<span data-ttu-id="56d04-125">`Logging` 属性可以具有 <xref:Microsoft.Extensions.Logging.LogLevel> 和日志提供程序属性。</span><span class="sxs-lookup"><span data-stu-id="56d04-125">The `Logging` property can have <xref:Microsoft.Extensions.Logging.LogLevel> and log provider properties.</span></span> <span data-ttu-id="56d04-126">`LogLevel` 指定要针对所选类别进行记录的最低[级别](#log-level)。</span><span class="sxs-lookup"><span data-stu-id="56d04-126">The `LogLevel` specifies the minimum [level](#log-level) to log for selected categories.</span></span> <span data-ttu-id="56d04-127">在前面的 JSON 中，指定了 `Information` 和 `Warning` 日志级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-127">In the preceding JSON, `Information` and `Warning` log levels are specified.</span></span> <span data-ttu-id="56d04-128">`LogLevel` 表示日志的严重性，范围为 0 到 6：</span><span class="sxs-lookup"><span data-stu-id="56d04-128">`LogLevel` indicates the severity of the log and ranges from 0 to 6:</span></span>

<span data-ttu-id="56d04-129">`Trace` = 0、`Debug` = 1、`Information` = 2、`Warning` = 3、`Error` = 4、`Critical` = 5 和 `None` = 6。</span><span class="sxs-lookup"><span data-stu-id="56d04-129">`Trace` = 0, `Debug` = 1, `Information` = 2, `Warning` = 3, `Error` = 4, `Critical` = 5, and `None` = 6.</span></span>

<span data-ttu-id="56d04-130">指定 `LogLevel` 时，将为指定级别和更高级别的消息启用日志记录。</span><span class="sxs-lookup"><span data-stu-id="56d04-130">When a `LogLevel` is specified, logging is enabled for messages at the specified level and higher.</span></span> <span data-ttu-id="56d04-131">在前面的 JSON 中，记录了 `Information` 及更高级别的 `Default` 类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-131">In the preceding JSON, the `Default` category is logged for `Information` and higher.</span></span> <span data-ttu-id="56d04-132">例如，记录了 `Information`、`Warning`、`Error` 和 `Critical` 消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-132">For example, `Information`, `Warning`, `Error`, and `Critical` messages are logged.</span></span> <span data-ttu-id="56d04-133">如果未指定 `LogLevel`，则日志记录默认为 `Information` 级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-133">If no `LogLevel` is specified, logging defaults to the `Information` level.</span></span> <span data-ttu-id="56d04-134">有关详细信息，请参阅[日志级别](#log-level)。</span><span class="sxs-lookup"><span data-stu-id="56d04-134">For more information, see [Log levels](#log-level).</span></span>

<span data-ttu-id="56d04-135">提供程序属性可以指定 `LogLevel` 属性。</span><span class="sxs-lookup"><span data-stu-id="56d04-135">A provider property can specify a `LogLevel` property.</span></span> <span data-ttu-id="56d04-136">提供程序下的 `LogLevel` 指定要为该提供程序记录的级别，并替代非提供程序日志设置。</span><span class="sxs-lookup"><span data-stu-id="56d04-136">`LogLevel` under a provider specifies levels to log for that provider, and overrides the non-provider log settings.</span></span> <span data-ttu-id="56d04-137">请考虑使用以下 appsettings.json 文件：</span><span class="sxs-lookup"><span data-stu-id="56d04-137">Consider the following *appsettings.json* file:</span></span>

:::code language="json" source="snippets/configuration/worker-service/appsettings.Staging.json":::

<span data-ttu-id="56d04-138">`Logging.{ProviderName}.LogLevel` 中的设置将替代 `Logging.LogLevel` 中的设置。</span><span class="sxs-lookup"><span data-stu-id="56d04-138">Settings in `Logging.{ProviderName}.LogLevel` override settings in `Logging.LogLevel`.</span></span> <span data-ttu-id="56d04-139">在前面的 JSON 中，`Debug` 提供程序的默认日志级别设置为 `Information`：</span><span class="sxs-lookup"><span data-stu-id="56d04-139">In the preceding JSON, the `Debug` provider's default log level is set to `Information`:</span></span>

`Logging:Debug:LogLevel:Default:Information`

<span data-ttu-id="56d04-140">前面的设置为每个 `Logging:Debug:` 类别（`Microsoft.Hosting` 除外）指定 `Information` 日志级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-140">The preceding setting specifies the `Information` log level for every `Logging:Debug:` category except `Microsoft.Hosting`.</span></span> <span data-ttu-id="56d04-141">当列出特定类别时，该特定类别将替代默认类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-141">When a specific category is listed, the specific category overrides the default category.</span></span> <span data-ttu-id="56d04-142">在前面的 JSON 中，`Logging:Debug:LogLevel` 类别 `"Microsoft.Hosting"` 和 `"Default"` 替代 `Logging:LogLevel` 中的设置</span><span class="sxs-lookup"><span data-stu-id="56d04-142">In the preceding JSON, the `Logging:Debug:LogLevel` categories `"Microsoft.Hosting"` and `"Default"` override the settings in `Logging:LogLevel`</span></span>

<span data-ttu-id="56d04-143">可以为以下任何一项指定最低日志级别：</span><span class="sxs-lookup"><span data-stu-id="56d04-143">The minimum log level can be specified for any of:</span></span>

- <span data-ttu-id="56d04-144">特定提供程序：例如，`Logging:EventSource:LogLevel:Default:Information`</span><span class="sxs-lookup"><span data-stu-id="56d04-144">Specific providers:  For example, `Logging:EventSource:LogLevel:Default:Information`</span></span>
- <span data-ttu-id="56d04-145">特定类别：例如，`Logging:LogLevel:Microsoft:Warning`</span><span class="sxs-lookup"><span data-stu-id="56d04-145">Specific categories: For example, `Logging:LogLevel:Microsoft:Warning`</span></span>
- <span data-ttu-id="56d04-146">所有提供程序和所有类别：`Logging:LogLevel:Default:Warning`</span><span class="sxs-lookup"><span data-stu-id="56d04-146">All providers and all categories: `Logging:LogLevel:Default:Warning`</span></span>

<span data-ttu-id="56d04-147">低于最低级别的任何日志均不会执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="56d04-147">Any logs below the minimum level are ***not***:</span></span>

- <span data-ttu-id="56d04-148">传递到提供程序。</span><span class="sxs-lookup"><span data-stu-id="56d04-148">Passed to the provider.</span></span>
- <span data-ttu-id="56d04-149">记录或显示。</span><span class="sxs-lookup"><span data-stu-id="56d04-149">Logged or displayed.</span></span>

<span data-ttu-id="56d04-150">要阻止所有日志，请指定 [LogLevel.None](xref:Microsoft.Extensions.Logging.LogLevel)。</span><span class="sxs-lookup"><span data-stu-id="56d04-150">To suppress all logs, specify [LogLevel.None](xref:Microsoft.Extensions.Logging.LogLevel).</span></span> <span data-ttu-id="56d04-151">`LogLevel.None` 的值为 6，该值高于 `LogLevel.Critical` (5)。</span><span class="sxs-lookup"><span data-stu-id="56d04-151">`LogLevel.None` has a value of 6, which is higher than `LogLevel.Critical` (5).</span></span>

<span data-ttu-id="56d04-152">如果提供程序支持[日志作用域](#log-scopes)，则 `IncludeScopes` 将指示是否启用这些域。</span><span class="sxs-lookup"><span data-stu-id="56d04-152">If a provider supports [log scopes](#log-scopes), `IncludeScopes` indicates whether they're enabled.</span></span> <span data-ttu-id="56d04-153">有关详细信息，请参阅[日志范围](#log-scopes)</span><span class="sxs-lookup"><span data-stu-id="56d04-153">For more information, see [log scopes](#log-scopes)</span></span>

<span data-ttu-id="56d04-154">以下 appsettings.json 文件包含所有内置提供程序的设置：</span><span class="sxs-lookup"><span data-stu-id="56d04-154">The following *appsettings.json* file contains settings for all of the built-in providers:</span></span>

:::code language="json" source="snippets/configuration/worker-service/appsettings.Production.json":::

<span data-ttu-id="56d04-155">在上述示例中：</span><span class="sxs-lookup"><span data-stu-id="56d04-155">In the preceding sample:</span></span>

- <span data-ttu-id="56d04-156">类别和级别不是建议的值。</span><span class="sxs-lookup"><span data-stu-id="56d04-156">The categories and levels are not suggested values.</span></span> <span data-ttu-id="56d04-157">提供该示例是为了显示所有默认提供程序。</span><span class="sxs-lookup"><span data-stu-id="56d04-157">The sample is provided to show all the default providers.</span></span>
- <span data-ttu-id="56d04-158">`Logging.{ProviderName}.LogLevel` 中的设置将替代 `Logging.LogLevel` 中的设置。</span><span class="sxs-lookup"><span data-stu-id="56d04-158">Settings in `Logging.{ProviderName}.LogLevel` override settings in `Logging.LogLevel`.</span></span> <span data-ttu-id="56d04-159">例如，`Debug.LogLevel.Default` 中的级别将替代 `LogLevel.Default` 中的级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-159">For example, the level in `Debug.LogLevel.Default` overrides the level in `LogLevel.Default`.</span></span>
- <span data-ttu-id="56d04-160">将使用每个提供程序的别名。</span><span class="sxs-lookup"><span data-stu-id="56d04-160">Each provider's *alias* is used.</span></span> <span data-ttu-id="56d04-161">每个提供程序都定义了一个别名；可在配置中使用该别名来代替完全限定的类型名称  。</span><span class="sxs-lookup"><span data-stu-id="56d04-161">Each provider defines an *alias* that can be used in configuration in place of the fully qualified type name.</span></span> <span data-ttu-id="56d04-162">内置提供程序的别名包括：</span><span class="sxs-lookup"><span data-stu-id="56d04-162">The built-in providers' aliases are:</span></span>
  - <span data-ttu-id="56d04-163">控制台</span><span class="sxs-lookup"><span data-stu-id="56d04-163">Console</span></span>
  - <span data-ttu-id="56d04-164">调试</span><span class="sxs-lookup"><span data-stu-id="56d04-164">Debug</span></span>
  - <span data-ttu-id="56d04-165">EventSource</span><span class="sxs-lookup"><span data-stu-id="56d04-165">EventSource</span></span>
  - <span data-ttu-id="56d04-166">EventLog</span><span class="sxs-lookup"><span data-stu-id="56d04-166">EventLog</span></span>
  - <span data-ttu-id="56d04-167">AzureAppServicesFile</span><span class="sxs-lookup"><span data-stu-id="56d04-167">AzureAppServicesFile</span></span>
  - <span data-ttu-id="56d04-168">AzureAppServicesBlob</span><span class="sxs-lookup"><span data-stu-id="56d04-168">AzureAppServicesBlob</span></span>
  - <span data-ttu-id="56d04-169">ApplicationInsights</span><span class="sxs-lookup"><span data-stu-id="56d04-169">ApplicationInsights</span></span>

### <a name="set-log-level-by-command-line-environment-variables-and-other-configuration"></a><span data-ttu-id="56d04-170">通过命令行、环境变量和其他配置设置日志级别</span><span class="sxs-lookup"><span data-stu-id="56d04-170">Set log level by command line, environment variables, and other configuration</span></span>

<span data-ttu-id="56d04-171">日志级别可以由任何[配置提供程序](configuration-providers.md)设置。</span><span class="sxs-lookup"><span data-stu-id="56d04-171">Log level can be set by any of the [configuration providers](configuration-providers.md).</span></span> <span data-ttu-id="56d04-172">例如，可以创建一个名为 `Logging:LogLevel:Microsoft` 且值为 `Information` 的持久性环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-172">For example, you can create a persisted environment variable named `Logging:LogLevel:Microsoft` with a value of `Information`.</span></span>

## <a name="command-line"></a>[<span data-ttu-id="56d04-173">命令行</span><span class="sxs-lookup"><span data-stu-id="56d04-173">Command Line</span></span>](#tab/command-line)

<span data-ttu-id="56d04-174">在给定日志级别值的情况下，创建并分配持久性环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-174">Create and assign persisted environment variable, given the log level value.</span></span>

```CMD
:: Assigns the env var to the value
setx "Logging__LogLevel__Microsoft" "Information" /M
```

<span data-ttu-id="56d04-175">在命令提示符的新实例中，读取环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-175">In a *new* instance of the **Command Prompt**, read the environment variable.</span></span>

```CMD
:: Prints the env var value
echo %Logging__LogLevel__Microsoft%
```

## <a name="powershell"></a>[<span data-ttu-id="56d04-176">PowerShell</span><span class="sxs-lookup"><span data-stu-id="56d04-176">PowerShell</span></span>](#tab/powershell)

<span data-ttu-id="56d04-177">在给定日志级别值的情况下，创建并分配持久性环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-177">Create and assign persisted environment variable, given the log level value.</span></span>

```powershell
# Assigns the env var to the value
[System.Environment]::SetEnvironmentVariable(
    "Logging__LogLevel__Microsoft", "Information", "Machine")
```

<span data-ttu-id="56d04-178">在 PowerShell 的新实例中，读取环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-178">In a *new* instance of the **PowerShell**, read the environment variable.</span></span>

```powershell
# Prints the env var value
[System.Environment]::GetEnvironmentVariable(
    "Logging__LogLevel__Microsoft", "Machine")
```

## <a name="bash"></a>[<span data-ttu-id="56d04-179">Bash</span><span class="sxs-lookup"><span data-stu-id="56d04-179">Bash</span></span>](#tab/bash)

<span data-ttu-id="56d04-180">在给定日志级别值的情况下，创建并分配持久性环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-180">Create and assign persisted environment variable, given the log level value.</span></span>

```Bash
# Assigns the env var to the value, persists it across sessions
echo export Logging__LogLevel__Microsoft="Information" >> ~/.bashrc && source ~/.bashrc
```

<span data-ttu-id="56d04-181">读取环境变量。</span><span class="sxs-lookup"><span data-stu-id="56d04-181">To read the environment variable.</span></span>

```Bash
# Prints the env var value
echo $Logging__LogLevel__Microsoft

# Or use printenv:
# printenv Logging__LogLevel__Microsoft
```

> [!NOTE]
> <span data-ttu-id="56d04-182">在使用包含 `.`（句点）的名称配置环境变量时，请注意 Stack Exchange 上提出的“导出带有点 (.) 的变量”问题以及相应的 [已接受解答](https://unix.stackexchange.com/a/93533)。</span><span class="sxs-lookup"><span data-stu-id="56d04-182">When configuring environment variables with names that contain `.` (periods), consider the "Exporting a variable with a dot (.) in it" question on **Stack Exchange** and its corresponding [accepted answer](https://unix.stackexchange.com/a/93533).</span></span>

---

<span data-ttu-id="56d04-183">前面的环境设置会在环境中持续存在。</span><span class="sxs-lookup"><span data-stu-id="56d04-183">The preceding environment setting is persisted in the environment.</span></span> <span data-ttu-id="56d04-184">若要在使用通过 .NET 辅助角色服务模板创建的应用时测试这些设置，请在分配环境变量后，在项目目录中使用 `dotnet run` 命令。</span><span class="sxs-lookup"><span data-stu-id="56d04-184">To test the settings when using an app created with the .NET Worker service templates, use the `dotnet run` command in the project directory after the environment variable is assigned.</span></span>

```dotnetcli
dotnet run
```

> [!TIP]
> <span data-ttu-id="56d04-185">设置环境变量后，请重启集成开发环境 (IDE)，以确保新添加的环境变量可用。</span><span class="sxs-lookup"><span data-stu-id="56d04-185">After setting an environment variable, restart your integrated development environment (IDE) to ensure that newly added environment variables are available.</span></span>

<span data-ttu-id="56d04-186">在 [Azure 应用服务](https://azure.microsoft.com/services/app-service/)上，选择“设置”>“配置”页面上的“新应用程序设置” 。</span><span class="sxs-lookup"><span data-stu-id="56d04-186">On [Azure App Service](https://azure.microsoft.com/services/app-service/), select **New application setting** on the **Settings > Configuration** page.</span></span> <span data-ttu-id="56d04-187">Azure 应用服务应用程序设置：</span><span class="sxs-lookup"><span data-stu-id="56d04-187">Azure App Service application settings are:</span></span>

- <span data-ttu-id="56d04-188">已静态加密且通过加密的通道进行传输。</span><span class="sxs-lookup"><span data-stu-id="56d04-188">Encrypted at rest and transmitted over an encrypted channel.</span></span>
- <span data-ttu-id="56d04-189">已作为环境变量公开。</span><span class="sxs-lookup"><span data-stu-id="56d04-189">Exposed as environment variables.</span></span>

<span data-ttu-id="56d04-190">若要详细了解如何使用环境变量设置 .NET 配置值，请参阅[环境变量](configuration-providers.md#environment-variable-configuration-provider)。</span><span class="sxs-lookup"><span data-stu-id="56d04-190">For more information on setting .NET configuration values using environment variables, see [environment variables](configuration-providers.md#environment-variable-configuration-provider).</span></span>

## <a name="how-filtering-rules-are-applied"></a><span data-ttu-id="56d04-191">如何应用筛选规则</span><span class="sxs-lookup"><span data-stu-id="56d04-191">How filtering rules are applied</span></span>

<span data-ttu-id="56d04-192">创建 <xref:Microsoft.Extensions.Logging.ILogger%601> 对象时，<xref:Microsoft.Extensions.Logging.ILoggerFactory> 对象将根据提供程序选择一条规则，将其应用于该记录器。</span><span class="sxs-lookup"><span data-stu-id="56d04-192">When an <xref:Microsoft.Extensions.Logging.ILogger%601> object is created, the <xref:Microsoft.Extensions.Logging.ILoggerFactory> object selects a single rule per provider to apply to that logger.</span></span> <span data-ttu-id="56d04-193">将按所选规则筛选 `ILogger` 实例写入的所有消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-193">All messages written by an `ILogger` instance are filtered based on the selected rules.</span></span> <span data-ttu-id="56d04-194">从可用规则中为每个提供程序和类别对选择最具体的规则。</span><span class="sxs-lookup"><span data-stu-id="56d04-194">The most specific rule for each provider and category pair is selected from the available rules.</span></span>

<span data-ttu-id="56d04-195">在为给定的类别创建 `ILogger` 时，以下算法将用于每个提供程序：</span><span class="sxs-lookup"><span data-stu-id="56d04-195">The following algorithm is used for each provider when an `ILogger` is created for a given category:</span></span>

- <span data-ttu-id="56d04-196">选择匹配提供程序或其别名的所有规则。</span><span class="sxs-lookup"><span data-stu-id="56d04-196">Select all rules that match the provider or its alias.</span></span> <span data-ttu-id="56d04-197">如果找不到任何匹配项，则选择提供程序为空的所有规则。</span><span class="sxs-lookup"><span data-stu-id="56d04-197">If no match is found, select all rules with an empty provider.</span></span>
- <span data-ttu-id="56d04-198">根据上一步的结果，选择具有最长匹配类别前缀的规则。</span><span class="sxs-lookup"><span data-stu-id="56d04-198">From the result of the preceding step, select rules with longest matching category prefix.</span></span> <span data-ttu-id="56d04-199">如果找不到任何匹配项，则选择未指定类别的所有规则。</span><span class="sxs-lookup"><span data-stu-id="56d04-199">If no match is found, select all rules that don't specify a category.</span></span>
- <span data-ttu-id="56d04-200">如果选择了多条规则，则采用最后一条  。</span><span class="sxs-lookup"><span data-stu-id="56d04-200">If multiple rules are selected, take the **last** one.</span></span>
- <span data-ttu-id="56d04-201">如果未选择任何规则，请使用 <xref:Microsoft.Extensions.Logging.LoggingBuilderExtensions.SetMinimumLevel(Microsoft.Extensions.Logging.ILoggingBuilder,Microsoft.Extensions.Logging.LogLevel)?displayProperty=nameWithType> 指定最小日志记录级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-201">If no rules are selected, use <xref:Microsoft.Extensions.Logging.LoggingBuilderExtensions.SetMinimumLevel(Microsoft.Extensions.Logging.ILoggingBuilder,Microsoft.Extensions.Logging.LogLevel)?displayProperty=nameWithType> to specify the minimum logging level.</span></span>

## <a name="log-category"></a><span data-ttu-id="56d04-202">日志类别</span><span class="sxs-lookup"><span data-stu-id="56d04-202">Log category</span></span>

<span data-ttu-id="56d04-203">创建 `ILogger` 对象时，将指定类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-203">When an `ILogger` object is created, a *category* is specified.</span></span> <span data-ttu-id="56d04-204">该类别包含在由此 `ILogger` 实例创建的每条日志消息中。</span><span class="sxs-lookup"><span data-stu-id="56d04-204">That category is included with each log message created by that instance of `ILogger`.</span></span> <span data-ttu-id="56d04-205">类别字符串是任意的，但约定将使用类名称。</span><span class="sxs-lookup"><span data-stu-id="56d04-205">The category string is arbitrary, but the convention is to use the class name.</span></span> <span data-ttu-id="56d04-206">例如，在服务定义类似于以下对象的应用程序中，类别可能为 `"Example.DefaultService"`：</span><span class="sxs-lookup"><span data-stu-id="56d04-206">For example, in an application with a service define like the following object, the category might be `"Example.DefaultService"`:</span></span>

```csharp
namespace Example
{
    public class DefaultService : IService
    {
        private readonly ILogger<DefaultService> _logger;

        public DefaultService(ILogger<DefaultService> logger) =>
            _logger = logger;

        // ...
    }
}
```

<span data-ttu-id="56d04-207">要显式指定类别，请调用 <xref:Microsoft.Extensions.Logging.LoggerFactory.CreateLogger%2A?displayProperty=nameWithType>：</span><span class="sxs-lookup"><span data-stu-id="56d04-207">To explicitly specify the category, call <xref:Microsoft.Extensions.Logging.LoggerFactory.CreateLogger%2A?displayProperty=nameWithType>:</span></span>

```csharp
namespace Example
{
    public class DefaultService : IService
    {
        private readonly ILogger _logger;

        public DefaultService(ILoggerFactory loggerFactory) =>
            _logger = loggerFactory.CreateLogger("CustomCategory");

        // ...
    }
}
```

<span data-ttu-id="56d04-208">在多个类/类型中使用时，使用固定名称调用 `CreateLogger` 很有用，这样可以按类别组织事件。</span><span class="sxs-lookup"><span data-stu-id="56d04-208">Calling `CreateLogger` with a fixed name can be useful when used in multiple classes/types so the events can be organized by category.</span></span>

<span data-ttu-id="56d04-209">`ILogger<T>` 相当于使用 `T` 的完全限定类型名称来调用 `CreateLogger`。</span><span class="sxs-lookup"><span data-stu-id="56d04-209">`ILogger<T>` is equivalent to calling `CreateLogger` with the fully qualified type name of `T`.</span></span>

## <a name="log-level"></a><span data-ttu-id="56d04-210">日志级别</span><span class="sxs-lookup"><span data-stu-id="56d04-210">Log level</span></span>

<span data-ttu-id="56d04-211">下表列出了 <xref:Microsoft.Extensions.Logging.LogLevel> 值、方便的 `Log{LogLevel}` 扩展方法以及建议的用法：</span><span class="sxs-lookup"><span data-stu-id="56d04-211">The following table lists the <xref:Microsoft.Extensions.Logging.LogLevel> values, the convenience `Log{LogLevel}` extension method, and the suggested usage:</span></span>

| <span data-ttu-id="56d04-212">LogLevel</span><span class="sxs-lookup"><span data-stu-id="56d04-212">LogLevel</span></span> | <span data-ttu-id="56d04-213">“值”</span><span class="sxs-lookup"><span data-stu-id="56d04-213">Value</span></span> | <span data-ttu-id="56d04-214">方法</span><span class="sxs-lookup"><span data-stu-id="56d04-214">Method</span></span> | <span data-ttu-id="56d04-215">描述</span><span class="sxs-lookup"><span data-stu-id="56d04-215">Description</span></span> |
|--|--|--|--|
| [<span data-ttu-id="56d04-216">Trace</span><span class="sxs-lookup"><span data-stu-id="56d04-216">Trace</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-217">0</span><span class="sxs-lookup"><span data-stu-id="56d04-217">0</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogTrace%2A> | <span data-ttu-id="56d04-218">包含最详细的消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-218">Contain the most detailed messages.</span></span> <span data-ttu-id="56d04-219">这些消息可能包含敏感的应用数据。</span><span class="sxs-lookup"><span data-stu-id="56d04-219">These messages may contain sensitive app data.</span></span> <span data-ttu-id="56d04-220">这些消息默认情况下处于禁用状态，并且不应在生产中启用。</span><span class="sxs-lookup"><span data-stu-id="56d04-220">These messages are disabled by default and should ***not*** be enabled in production.</span></span> |
| [<span data-ttu-id="56d04-221">调试</span><span class="sxs-lookup"><span data-stu-id="56d04-221">Debug</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-222">1</span><span class="sxs-lookup"><span data-stu-id="56d04-222">1</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogDebug%2A> | <span data-ttu-id="56d04-223">用于调试和开发。</span><span class="sxs-lookup"><span data-stu-id="56d04-223">For debugging and development.</span></span> <span data-ttu-id="56d04-224">由于量大，请在生产中小心使用。</span><span class="sxs-lookup"><span data-stu-id="56d04-224">Use with caution in production due to the high volume.</span></span> |
| [<span data-ttu-id="56d04-225">信息</span><span class="sxs-lookup"><span data-stu-id="56d04-225">Information</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-226">2</span><span class="sxs-lookup"><span data-stu-id="56d04-226">2</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogInformation%2A> | <span data-ttu-id="56d04-227">跟踪应用的常规流。</span><span class="sxs-lookup"><span data-stu-id="56d04-227">Tracks the general flow of the app.</span></span> <span data-ttu-id="56d04-228">可能具有长期值。</span><span class="sxs-lookup"><span data-stu-id="56d04-228">May have long-term value.</span></span> |
| [<span data-ttu-id="56d04-229">警告</span><span class="sxs-lookup"><span data-stu-id="56d04-229">Warning</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-230">3</span><span class="sxs-lookup"><span data-stu-id="56d04-230">3</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogWarning%2A> | <span data-ttu-id="56d04-231">对于异常事件或意外事件。</span><span class="sxs-lookup"><span data-stu-id="56d04-231">For abnormal or unexpected events.</span></span> <span data-ttu-id="56d04-232">通常包括不会导致应用失败的错误或情况。</span><span class="sxs-lookup"><span data-stu-id="56d04-232">Typically includes errors or conditions that don't cause the app to fail.</span></span> |
| [<span data-ttu-id="56d04-233">错误</span><span class="sxs-lookup"><span data-stu-id="56d04-233">Error</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-234">4</span><span class="sxs-lookup"><span data-stu-id="56d04-234">4</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogError%2A> | <span data-ttu-id="56d04-235">表示无法处理的错误和异常。</span><span class="sxs-lookup"><span data-stu-id="56d04-235">For errors and exceptions that cannot be handled.</span></span> <span data-ttu-id="56d04-236">这些消息表示当前操作或请求失败，而不是整个应用失败。</span><span class="sxs-lookup"><span data-stu-id="56d04-236">These messages indicate a failure in the current operation or request, not an app-wide failure.</span></span> |
| [<span data-ttu-id="56d04-237">严重</span><span class="sxs-lookup"><span data-stu-id="56d04-237">Critical</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-238">5</span><span class="sxs-lookup"><span data-stu-id="56d04-238">5</span></span> | <xref:Microsoft.Extensions.Logging.LoggerExtensions.LogCritical%2A> | <span data-ttu-id="56d04-239">需要立即关注的失败。</span><span class="sxs-lookup"><span data-stu-id="56d04-239">For failures that require immediate attention.</span></span> <span data-ttu-id="56d04-240">例如数据丢失、磁盘空间不足。</span><span class="sxs-lookup"><span data-stu-id="56d04-240">Examples: data loss scenarios, out of disk space.</span></span> |
| [<span data-ttu-id="56d04-241">无</span><span class="sxs-lookup"><span data-stu-id="56d04-241">None</span></span>](xref:Microsoft.Extensions.Logging.LogLevel) | <span data-ttu-id="56d04-242">6</span><span class="sxs-lookup"><span data-stu-id="56d04-242">6</span></span> |  | <span data-ttu-id="56d04-243">指定不应写入任何消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-243">Specifies that no messages should be written.</span></span> |

<span data-ttu-id="56d04-244">在上表中，`LogLevel` 按严重性由低到高的顺序列出。</span><span class="sxs-lookup"><span data-stu-id="56d04-244">In the previous table, the `LogLevel` is listed from lowest to highest severity.</span></span>

<span data-ttu-id="56d04-245">[Log](xref:Microsoft.Extensions.Logging.LoggerExtensions) 方法的第一个参数 <xref:Microsoft.Extensions.Logging.LogLevel> 指示日志的严重性。</span><span class="sxs-lookup"><span data-stu-id="56d04-245">The [Log](xref:Microsoft.Extensions.Logging.LoggerExtensions) method's first parameter, <xref:Microsoft.Extensions.Logging.LogLevel>, indicates the severity of the log.</span></span> <span data-ttu-id="56d04-246">大多数开发人员调用 [Log{LogLevel}](xref:Microsoft.Extensions.Logging.LoggerExtensions) 扩展方法，而不调用 `Log(LogLevel, ...)`。</span><span class="sxs-lookup"><span data-stu-id="56d04-246">Rather than calling `Log(LogLevel, ...)`, most developers call the [Log{LogLevel}](xref:Microsoft.Extensions.Logging.LoggerExtensions) extension methods.</span></span> <span data-ttu-id="56d04-247">`Log{LogLevel}` 扩展方法[调用 Log 方法并指定 LogLevel](https://github.com/dotnet/extensions/blob/release/3.1/src/Logging/Logging.Abstractions/src/LoggerExtensions.cs)。</span><span class="sxs-lookup"><span data-stu-id="56d04-247">The `Log{LogLevel}` extension methods [call the Log method and specify the LogLevel](https://github.com/dotnet/extensions/blob/release/3.1/src/Logging/Logging.Abstractions/src/LoggerExtensions.cs).</span></span> <span data-ttu-id="56d04-248">例如，以下两个日志记录调用功能相同，并生成相同的日志：</span><span class="sxs-lookup"><span data-stu-id="56d04-248">For example, the following two logging calls are functionally equivalent and produce the same log:</span></span>

```csharp
public void LogDetails()
{
    var logMessage = "Details for log.";

    _logger.Log(LogLevel.Information, AppLogEvents.Details, logMessage);
    _logger.LogInformation(AppLogEvents.Details, logMessage);
}
```

<span data-ttu-id="56d04-249">`AppLogEvents.Details` 为事件 ID，用常量 <xref:System.Int32> 值隐式表示。</span><span class="sxs-lookup"><span data-stu-id="56d04-249">`AppLogEvents.Details` is the event ID, and is implicitly represented by a constant <xref:System.Int32> value.</span></span> <span data-ttu-id="56d04-250">`AppLogEvents` 是一个公开各种命名的标识符常量并显示在[日志事件 ID](#log-event-id) 部分中的类。</span><span class="sxs-lookup"><span data-stu-id="56d04-250">`AppLogEvents` is a class that exposes various named identifier constants and is displayed in the [Log event ID](#log-event-id) section.</span></span>

<span data-ttu-id="56d04-251">下面的代码会创建 `Information` 和 `Warning` 日志：</span><span class="sxs-lookup"><span data-stu-id="56d04-251">The following code creates `Information` and `Warning` logs:</span></span>

```csharp
public async Task<T> GetAsync<T>(string id)
{
    _logger.LogInformation(AppLogEvents.Read, "Reading value for {Id}", id);

    var result = await _repository.GetAsync(id);
    if (result is null)
    {
        _logger.LogWarning(AppLogEvents.ReadNotFound, "GetAsync({Id}) not found", id);
    }

    return result;
}
```

<span data-ttu-id="56d04-252">在前面的代码中，第一个 `Log{LogLevel}` 参数 `AppLogEvents.Read` 是[日志事件 ID](#log-event-id)。</span><span class="sxs-lookup"><span data-stu-id="56d04-252">In the preceding code, the first `Log{LogLevel}` parameter,`AppLogEvents.Read`, is the [Log event ID](#log-event-id).</span></span> <span data-ttu-id="56d04-253">第二个参数是消息模板，其中的占位符用于填写剩余方法形参提供的实参值。</span><span class="sxs-lookup"><span data-stu-id="56d04-253">The second parameter is a message template with placeholders for argument values provided by the remaining method parameters.</span></span> <span data-ttu-id="56d04-254">稍后将在本文的[消息模板](#log-message-template)部分介绍方法参数。</span><span class="sxs-lookup"><span data-stu-id="56d04-254">The method parameters are explained in the [message template](#log-message-template) section later in this article.</span></span>

<span data-ttu-id="56d04-255">配置适当的日志级别并调用正确的 `Log{LogLevel}` 方法来控制写入特定存储介质的日志输出量。</span><span class="sxs-lookup"><span data-stu-id="56d04-255">Configure the appropriate log level and call the correct `Log{LogLevel}` methods to control how much log output is written to a particular storage medium.</span></span> <span data-ttu-id="56d04-256">例如：</span><span class="sxs-lookup"><span data-stu-id="56d04-256">For example:</span></span>

- <span data-ttu-id="56d04-257">生产中：</span><span class="sxs-lookup"><span data-stu-id="56d04-257">In production:</span></span>
  - <span data-ttu-id="56d04-258">在 `Trace` 或 `Information` 级别记录日志会产生大量详细的日志消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-258">Logging at the `Trace` or `Information` levels produces a high-volume of detailed log messages.</span></span> <span data-ttu-id="56d04-259">为了控制成本且不超过数据存储限制，请将 `Trace` 和 `Information` 级别消息记录到容量大、成本低的数据存储中。</span><span class="sxs-lookup"><span data-stu-id="56d04-259">To control costs and not exceed data storage limits, log `Trace` and `Information` level messages to a high-volume, low-cost data store.</span></span> <span data-ttu-id="56d04-260">考虑将 `Trace` 和 `Information` 限制为特定类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-260">Consider limiting `Trace` and `Information` to specific categories.</span></span>
  - <span data-ttu-id="56d04-261">从 `Warning` 到 `Critical` 级别的日志记录应该很少产生日志消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-261">Logging at `Warning` through `Critical` levels should produce few log messages.</span></span>
    - <span data-ttu-id="56d04-262">成本和存储限制通常不是问题。</span><span class="sxs-lookup"><span data-stu-id="56d04-262">Costs and storage limits usually aren't a concern.</span></span>
    - <span data-ttu-id="56d04-263">很少有日志可以为数据存储选择提供更大的灵活性。</span><span class="sxs-lookup"><span data-stu-id="56d04-263">Few logs allow more flexibility in data store choices.</span></span>
- <span data-ttu-id="56d04-264">在开发过程中：</span><span class="sxs-lookup"><span data-stu-id="56d04-264">In development:</span></span>
  - <span data-ttu-id="56d04-265">设置为 `Warning`。</span><span class="sxs-lookup"><span data-stu-id="56d04-265">Set to `Warning`.</span></span>
  - <span data-ttu-id="56d04-266">在进行故障排除时，添加 `Trace` 或 `Information` 消息。</span><span class="sxs-lookup"><span data-stu-id="56d04-266">Add `Trace` or `Information` messages when troubleshooting.</span></span> <span data-ttu-id="56d04-267">若要限制输出，请仅对正在调查的类别设置 `Trace` 或 `Information`。</span><span class="sxs-lookup"><span data-stu-id="56d04-267">To limit output, set `Trace` or `Information` only for the categories under investigation.</span></span>

<span data-ttu-id="56d04-268">以下 JSON 设置了 `Logging:Console:LogLevel:Microsoft:Information`：</span><span class="sxs-lookup"><span data-stu-id="56d04-268">The following JSON sets `Logging:Console:LogLevel:Microsoft:Information`:</span></span>

:::code language="json" source="snippets/configuration/worker-service/appsettings.MSFT.json":::

## <a name="log-event-id"></a><span data-ttu-id="56d04-269">日志事件 ID</span><span class="sxs-lookup"><span data-stu-id="56d04-269">Log event ID</span></span>

<span data-ttu-id="56d04-270">每个日志可以指定一个事件标识符，<xref:Microsoft.Extensions.Logging.EventId> 是一个具有 `Id` 和可选 `Name` 只读属性的结构。</span><span class="sxs-lookup"><span data-stu-id="56d04-270">Each log can specify an *event identifer*, the <xref:Microsoft.Extensions.Logging.EventId> is a structure with an `Id` and optional `Name` readonly properties.</span></span> <span data-ttu-id="56d04-271">示例源代码使用 `AppLogEvents` 类来定义事件 ID：</span><span class="sxs-lookup"><span data-stu-id="56d04-271">The sample source code uses the `AppLogEvents` class to define event IDs:</span></span>

```csharp
internal static class AppLogEvents
{
    internal const int Create = 1000;
    internal const int Read = 1001;
    internal const int Update = 1002;
    internal const int Delete = 1003;

    internal const int Details = 3000;
    internal const int Error = 3001;

    internal const int ReadNotFound = 4000;
    internal const int UpdateNotFound = 4001;

    // ...
}
```

<span data-ttu-id="56d04-272">事件 ID 与一组事件相关联。</span><span class="sxs-lookup"><span data-stu-id="56d04-272">An event ID associates a set of events.</span></span> <span data-ttu-id="56d04-273">例如，与从存储库读取值相关的所有日志都可能是 `1001`。</span><span class="sxs-lookup"><span data-stu-id="56d04-273">For example, all logs related to reading values from a repository might be `1001`.</span></span>

<span data-ttu-id="56d04-274">日志记录提供程序可将事件 ID 记录在 ID 字段中，记录在日志记录消息中，或者不进行记录。</span><span class="sxs-lookup"><span data-stu-id="56d04-274">The logging provider may log the event ID in an ID field, in the logging message, or not at all.</span></span> <span data-ttu-id="56d04-275">调试提供程序不显示事件 ID。</span><span class="sxs-lookup"><span data-stu-id="56d04-275">The Debug provider doesn't show event IDs.</span></span> <span data-ttu-id="56d04-276">控制台提供程序在类别后的括号中显示事件 ID：</span><span class="sxs-lookup"><span data-stu-id="56d04-276">The console provider shows event IDs in brackets after the category:</span></span>

```console
info: Example.DefaultService.GetAsync[1001]
      Reading value for a1b2c3
warn: Example.DefaultService.GetAsync[4000]
      GetAsync(a1b2c3) not found
```

<span data-ttu-id="56d04-277">一些日志记录提供程序将事件 ID 存储在一个字段中，该字段允许对 ID 进行筛选。</span><span class="sxs-lookup"><span data-stu-id="56d04-277">Some logging providers store the event ID in a field, which allows for filtering on the ID.</span></span>

## <a name="log-message-template"></a><span data-ttu-id="56d04-278">日志消息模板</span><span class="sxs-lookup"><span data-stu-id="56d04-278">Log message template</span></span>

<span data-ttu-id="56d04-279">每个日志 API 都使用一个消息模板。</span><span class="sxs-lookup"><span data-stu-id="56d04-279">Each log API uses a message template.</span></span> <span data-ttu-id="56d04-280">消息模板可包含要填写参数的占位符。</span><span class="sxs-lookup"><span data-stu-id="56d04-280">The message template can contain placeholders for which arguments are provided.</span></span> <span data-ttu-id="56d04-281">请在占位符中使用名称而不是数字。</span><span class="sxs-lookup"><span data-stu-id="56d04-281">Use names for the placeholders, not numbers.</span></span> <span data-ttu-id="56d04-282">占位符的顺序（而非其名称）决定了为其提供值的参数。</span><span class="sxs-lookup"><span data-stu-id="56d04-282">The order of placeholders, not their names, determines which parameters are used to provide their values.</span></span> <span data-ttu-id="56d04-283">在以下代码中，消息模板中的参数名称不按顺序排列：</span><span class="sxs-lookup"><span data-stu-id="56d04-283">In the following code, the parameter names are out of sequence in the message template:</span></span>

```csharp
string p1 = "param1";
string p2 = "param2";
_logger.LogInformation("Parameter values: {p2}, {p1}", p1, p2);
```

<span data-ttu-id="56d04-284">上面的代码按顺序通过参数值创建日志消息：</span><span class="sxs-lookup"><span data-stu-id="56d04-284">The preceding code creates a log message with the parameter values in sequence:</span></span>

```text
Parameter values: param1, param2
```

<span data-ttu-id="56d04-285">此方法允许日志记录提供程序实现[语义或结构化日志记录](https://github.com/NLog/NLog/wiki/How-to-use-structured-logging)。</span><span class="sxs-lookup"><span data-stu-id="56d04-285">This approach allows logging providers to implement [semantic or structured logging](https://github.com/NLog/NLog/wiki/How-to-use-structured-logging).</span></span> <span data-ttu-id="56d04-286">参数本身会传递给日志记录系统，而不仅仅是格式化的消息模板。</span><span class="sxs-lookup"><span data-stu-id="56d04-286">The arguments themselves are passed to the logging system, not just the formatted message template.</span></span> <span data-ttu-id="56d04-287">这使日志记录提供程序可以将参数值存储为字段。</span><span class="sxs-lookup"><span data-stu-id="56d04-287">This enables logging providers to store the parameter values as fields.</span></span> <span data-ttu-id="56d04-288">请考虑使用以下记录器方法：</span><span class="sxs-lookup"><span data-stu-id="56d04-288">Consider the following logger method:</span></span>

```csharp
_logger.LogInformation("Getting item {Id} at {RunTime}", id, DateTime.Now);
```

<span data-ttu-id="56d04-289">例如，登录到 Azure 表存储时：</span><span class="sxs-lookup"><span data-stu-id="56d04-289">For example, when logging to Azure Table Storage:</span></span>

- <span data-ttu-id="56d04-290">每个 Azure 表实体都可以有 `ID` 和 `RunTime` 属性。</span><span class="sxs-lookup"><span data-stu-id="56d04-290">Each Azure Table entity can have `ID` and `RunTime` properties.</span></span>
- <span data-ttu-id="56d04-291">具有属性的表简化了对记录数据的查询。</span><span class="sxs-lookup"><span data-stu-id="56d04-291">Tables with properties simplify queries on logged data.</span></span> <span data-ttu-id="56d04-292">例如，查询可以找到特定 `RunTime` 范围内的所有日志，而不必分析文本消息中的时间。</span><span class="sxs-lookup"><span data-stu-id="56d04-292">For example, a query can find all logs within a particular `RunTime` range without having to parse the time out of the text message.</span></span>

## <a name="log-exceptions"></a><span data-ttu-id="56d04-293">记录异常</span><span class="sxs-lookup"><span data-stu-id="56d04-293">Log exceptions</span></span>

<span data-ttu-id="56d04-294">记录器方法的重载采用异常参数：</span><span class="sxs-lookup"><span data-stu-id="56d04-294">The logger methods have overloads that take an exception parameter:</span></span>

```csharp
public void Test(string id)
{
    try
    {
        if (id == "none")
        {
            throw new Exception("Default Id detected.");
        }
    }
    catch (Exception ex)
    {
        _logger.LogWarning(
            AppLogEvents.Error, ex,
            "Failed to process iteration: {Id}", id)
    }
}
```

<span data-ttu-id="56d04-295">异常日志记录是特定于提供程序的。</span><span class="sxs-lookup"><span data-stu-id="56d04-295">Exception logging is provider-specific.</span></span>

### <a name="default-log-level"></a><span data-ttu-id="56d04-296">默认日志级别</span><span class="sxs-lookup"><span data-stu-id="56d04-296">Default log level</span></span>

<span data-ttu-id="56d04-297">如果未设置默认日志级别，则默认的日志级别值为 `Information`。</span><span class="sxs-lookup"><span data-stu-id="56d04-297">If the default log level is not set, the default log level value is `Information`.</span></span>

<span data-ttu-id="56d04-298">例如，请考虑以下辅助角色服务应用：</span><span class="sxs-lookup"><span data-stu-id="56d04-298">For example, consider the following worker service app:</span></span>

- <span data-ttu-id="56d04-299">使用 .NET 辅助角色模板创建的应用。</span><span class="sxs-lookup"><span data-stu-id="56d04-299">Created with the .NET Worker templates.</span></span>
- <span data-ttu-id="56d04-300">已删除 appsettings.json 和 appsettings.Development.json 或对其进行重命名 。</span><span class="sxs-lookup"><span data-stu-id="56d04-300">*appsettings.json* and *appsettings.Development.json* deleted or renamed.</span></span>

<span data-ttu-id="56d04-301">使用上述设置，导航到隐私或主页会生成许多 `Trace`、`Debug` 和 `Information` 消息，并在类别名称中包含 `Microsoft`。</span><span class="sxs-lookup"><span data-stu-id="56d04-301">With the preceding setup, navigating to the privacy or home page produces many `Trace`, `Debug`, and `Information`  messages with `Microsoft` in the category name.</span></span>

<span data-ttu-id="56d04-302">如果未在配置中设置默认日志级别，以下代码会设置默认日志级别：</span><span class="sxs-lookup"><span data-stu-id="56d04-302">The following code sets the default log level when the default log level is not set in configuration:</span></span>

```csharp
class Program
{
    static Task Main(string[] args) =>
        CreateHostBuilder(args).Build().RunAsync();

    static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureLogging(logging => logging.SetMinimumLevel(LogLevel.Warning));
}
```

### <a name="filter-function"></a><span data-ttu-id="56d04-303">筛选器函数</span><span class="sxs-lookup"><span data-stu-id="56d04-303">Filter function</span></span>

<span data-ttu-id="56d04-304">对配置或代码没有向其分配规则的所有提供程序和类别调用筛选器函数：</span><span class="sxs-lookup"><span data-stu-id="56d04-304">A filter function is invoked for all providers and categories that don't have rules assigned to them by configuration or code:</span></span>

```csharp
class Program
{
    static Task Main(string[] args) =>
        CreateHostBuilder(args).Build().RunAsync();

    static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureLogging(logging =>
                logging.AddFilter((provider, category, logLevel) =>
                {
                    return provider.Contains("ConsoleLoggerProvider")
                        && (category.Contains("Example") || category.Contains("Microsoft"))
                        && logLevel >= LogLevel.Information;
                }));
}
```

<span data-ttu-id="56d04-305">如果类别包含 `Example` 或 `Microsoft`，并且日志级别为 `Information` 或更高级别，以上代码会显示控制台日志。</span><span class="sxs-lookup"><span data-stu-id="56d04-305">The preceding code displays console logs when the category contains `Example` or `Microsoft` and the log level is `Information` or higher.</span></span>

## <a name="log-scopes"></a><span data-ttu-id="56d04-306">日志作用域</span><span class="sxs-lookup"><span data-stu-id="56d04-306">Log scopes</span></span>

 <span data-ttu-id="56d04-307">“作用域”可对一组逻辑操作分组  。</span><span class="sxs-lookup"><span data-stu-id="56d04-307">A *scope* can group a set of logical operations.</span></span> <span data-ttu-id="56d04-308">此分组可用于将相同的数据附加到作为集合的一部分而创建的每个日志。</span><span class="sxs-lookup"><span data-stu-id="56d04-308">This grouping can be used to attach the same data to each log that's created as part of a set.</span></span> <span data-ttu-id="56d04-309">例如，在处理事务期间创建的每个日志都可包括事务 ID。</span><span class="sxs-lookup"><span data-stu-id="56d04-309">For example, every log created as part of processing a transaction can include the transaction ID.</span></span>

<span data-ttu-id="56d04-310">范围：</span><span class="sxs-lookup"><span data-stu-id="56d04-310">A scope:</span></span>

- <span data-ttu-id="56d04-311">是 <xref:Microsoft.Extensions.Logging.ILogger.BeginScope%2A> 方法返回的 <xref:System.IDisposable> 类型。</span><span class="sxs-lookup"><span data-stu-id="56d04-311">Is an <xref:System.IDisposable> type that's returned by the <xref:Microsoft.Extensions.Logging.ILogger.BeginScope%2A> method.</span></span>
- <span data-ttu-id="56d04-312">持续到处置完毕。</span><span class="sxs-lookup"><span data-stu-id="56d04-312">Lasts until it's disposed.</span></span>

<span data-ttu-id="56d04-313">以下提供程序支持范围：</span><span class="sxs-lookup"><span data-stu-id="56d04-313">The following providers support scopes:</span></span>

- `Console`
- [<span data-ttu-id="56d04-314">AzureAppServicesFile 和 AzureAppServicesBlob</span><span class="sxs-lookup"><span data-stu-id="56d04-314">AzureAppServicesFile and AzureAppServicesBlob</span></span>](xref:Microsoft.Extensions.Logging.AzureAppServices.BatchingLoggerOptions.IncludeScopes)

<span data-ttu-id="56d04-315">要使用作用域，请在 `using` 块中包装记录器调用：</span><span class="sxs-lookup"><span data-stu-id="56d04-315">Use a scope by wrapping logger calls in a `using` block:</span></span>

```csharp
public async Task<T> GetAsync<T>(string id)
{
    T result;

    using (_logger.BeginScope("using block message"))
    {
        _logger.LogInformation(
            AppLogEvents.Read, "Reading value for {Id}", id);

        var result = await _repository.GetAsync(id);
        if (result is null)
        {
            _logger.LogWarning(
                AppLogEvents.ReadNotFound, "GetAsync({Id}) not found", id);
        }
    }

    return result;
}
```

<span data-ttu-id="56d04-316">以下 JSON 为控制台提供程序启用范围：</span><span class="sxs-lookup"><span data-stu-id="56d04-316">The following JSON enables scopes for the console provider:</span></span>

:::code language="json" source="snippets/configuration/worker-service/appsettings.IncludeScopes.json" highlight="9":::

<span data-ttu-id="56d04-317">下列代码为控制台提供程序启用作用域：</span><span class="sxs-lookup"><span data-stu-id="56d04-317">The following code enables scopes for the console provider:</span></span>

```csharp
class Program
{
    static Task Main(string[] args) =>
        CreateHostBuilder(args).Build().RunAsync();

    static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureLogging((_, logging) =>
                logging.ClearProviders()
                    .AddConsole(options => options.IncludeScopes = true));
}
```

## <a name="non-host-console-app"></a><span data-ttu-id="56d04-318">非托管控制台应用</span><span class="sxs-lookup"><span data-stu-id="56d04-318">Non-host console app</span></span>

<span data-ttu-id="56d04-319">对于没有[通用主机](generic-host.md)的应用，日志记录代码在[添加提供程序](logging-providers.md#built-in-logging-providers)和[创建记录器](#create-logs)的方式上有所不同。</span><span class="sxs-lookup"><span data-stu-id="56d04-319">Logging code for apps without a [Generic Host](generic-host.md) differs in the way [providers are added](logging-providers.md#built-in-logging-providers) and [loggers are created](#create-logs).</span></span> <span data-ttu-id="56d04-320">在非主机控制台应用中，在创建 `LoggerFactory` 时调用提供程序的 `Add{provider name}` 扩展方法：</span><span class="sxs-lookup"><span data-stu-id="56d04-320">In a non-host console app, call the provider's `Add{provider name}` extension method while creating a `LoggerFactory`:</span></span>

```csharp
class Program
{
    static void Main(string[] args)
    {
        using var loggerFactory = LoggerFactory.Create(builder =>
        {
            builder
                .AddFilter("Microsoft", LogLevel.Warning)
                .AddFilter("System", LogLevel.Warning)
                .AddFilter("LoggingConsoleApp.Program", LogLevel.Debug)
                .AddConsole();
        });

        ILogger logger = loggerFactory.CreateLogger<Program>();
        logger.LogInformation("Example log message");
    }
}
```

<span data-ttu-id="56d04-321">`loggerFactory` 对象用于创建 <xref:Microsoft.Extensions.Logging.ILogger> 实例。</span><span class="sxs-lookup"><span data-stu-id="56d04-321">The `loggerFactory` object is used to create an <xref:Microsoft.Extensions.Logging.ILogger> instance.</span></span>

## <a name="create-logs-in-main"></a><span data-ttu-id="56d04-322">在 Main 中创建日志</span><span class="sxs-lookup"><span data-stu-id="56d04-322">Create logs in Main</span></span>

<span data-ttu-id="56d04-323">以下代码通过在构建主机之后从 DI 获取 `ILogger` 实例来登录 `Main`：</span><span class="sxs-lookup"><span data-stu-id="56d04-323">The following code logs in `Main` by getting an `ILogger` instance from DI after building the host:</span></span>

```csharp
using System;
using System.Threading.Tasks;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

class Program
{
    static Task Main(string[] args)
    {
        IHost host = Host.CreateDefaultBuilder(args).Build();

        var logger = host.Services.GetRequiredService<ILogger<Program>>();
        logger.LogInformation("Host created.");

        return host.RunAsync();
    }
}
```

### <a name="no-asynchronous-logger-methods"></a><span data-ttu-id="56d04-324">没有异步记录器方法</span><span class="sxs-lookup"><span data-stu-id="56d04-324">No asynchronous logger methods</span></span>

<span data-ttu-id="56d04-325">日志记录应该会很快，不值得牺牲性能来使用异步代码。</span><span class="sxs-lookup"><span data-stu-id="56d04-325">Logging should be so fast that it isn't worth the performance cost of asynchronous code.</span></span> <span data-ttu-id="56d04-326">如果日志记录数据存储很慢，请不要直接写入它。</span><span class="sxs-lookup"><span data-stu-id="56d04-326">If a logging data store is slow, don't write to it directly.</span></span> <span data-ttu-id="56d04-327">考虑先将日志消息写入快速存储，然后再将其移至慢速存储。</span><span class="sxs-lookup"><span data-stu-id="56d04-327">Consider writing the log messages to a fast store initially, then moving them to the slow store later.</span></span> <span data-ttu-id="56d04-328">例如，登录到 SQL Server 时，请勿直接使用 `Log` 方法登录，因为 `Log` 方法是同步的。</span><span class="sxs-lookup"><span data-stu-id="56d04-328">For example, when logging to SQL Server, don't do so directly in a `Log` method, since the `Log` methods are synchronous.</span></span> <span data-ttu-id="56d04-329">相反，你会将日志消息同步添加到内存中的队列，并让后台辅助线程从队列中拉出消息，以完成将数据推送到 SQL Server 的异步工作。</span><span class="sxs-lookup"><span data-stu-id="56d04-329">Instead, synchronously add log messages to an in-memory queue and have a background worker pull the messages out of the queue to do the asynchronous work of pushing data to SQL Server.</span></span>

## <a name="change-log-levels-in-a-running-app"></a><span data-ttu-id="56d04-330">更改正在运行的应用中的日志级别</span><span class="sxs-lookup"><span data-stu-id="56d04-330">Change log levels in a running app</span></span>

<span data-ttu-id="56d04-331">不可使用日志记录 API 在应用运行时更改日志记录。</span><span class="sxs-lookup"><span data-stu-id="56d04-331">The Logging API doesn't include a scenario to change log levels while an app is running.</span></span> <span data-ttu-id="56d04-332">但是，一些配置提供程序可重新加载配置，这将对日志记录配置立即产生影响。</span><span class="sxs-lookup"><span data-stu-id="56d04-332">However, some configuration providers are capable of reloading configuration, which takes immediate effect on logging configuration.</span></span> <span data-ttu-id="56d04-333">例如，[文件配置提供程序](configuration-providers.md#file-configuration-provider)默认情况下会重载日志记录配置。</span><span class="sxs-lookup"><span data-stu-id="56d04-333">For example, the [File Configuration Provider](configuration-providers.md#file-configuration-provider) reloads logging configuration by default.</span></span> <span data-ttu-id="56d04-334">如果在应用运行时在代码中更改了配置，则该应用可调用 [IConfigurationRoot.Reload](xref:Microsoft.Extensions.Configuration.IConfigurationRoot.Reload%2A) 来更新应用的日志记录配置。</span><span class="sxs-lookup"><span data-stu-id="56d04-334">If configuration is changed in code while an app is running, the app can call [IConfigurationRoot.Reload](xref:Microsoft.Extensions.Configuration.IConfigurationRoot.Reload%2A) to update the app's logging configuration.</span></span>

## <a name="nuget-packages"></a><span data-ttu-id="56d04-335">NuGet 包</span><span class="sxs-lookup"><span data-stu-id="56d04-335">NuGet packages</span></span>

<span data-ttu-id="56d04-336"><xref:Microsoft.Extensions.Logging.ILogger%601> 和 <xref:Microsoft.Extensions.Logging.ILoggerFactory> 接口和实现都包含在 .NET Core SDK 中。</span><span class="sxs-lookup"><span data-stu-id="56d04-336">The <xref:Microsoft.Extensions.Logging.ILogger%601> and <xref:Microsoft.Extensions.Logging.ILoggerFactory> interfaces and implementations are included in the .NET Core SDK.</span></span> <span data-ttu-id="56d04-337">它们还可以通过以下 NuGet 包获得：</span><span class="sxs-lookup"><span data-stu-id="56d04-337">They are also available in the following NuGet packages:</span></span>

- <span data-ttu-id="56d04-338">这些接口位于 [Microsoft.Extensions.Logging.Abstractions](https://www.nuget.org/packages/Microsoft.Extensions.Logging.Abstractions) 中。</span><span class="sxs-lookup"><span data-stu-id="56d04-338">The interfaces are in [Microsoft.Extensions.Logging.Abstractions](https://www.nuget.org/packages/Microsoft.Extensions.Logging.Abstractions).</span></span>
- <span data-ttu-id="56d04-339">默认实现位于 [Microsoft.Extensions.Logging](https://www.nuget.org/packages/microsoft.extensions.logging) 中。</span><span class="sxs-lookup"><span data-stu-id="56d04-339">The default implementations are in [Microsoft.Extensions.Logging](https://www.nuget.org/packages/microsoft.extensions.logging).</span></span>

## <a name="apply-log-filter-rules-in-code"></a><span data-ttu-id="56d04-340">在代码中应用日志筛选器规则</span><span class="sxs-lookup"><span data-stu-id="56d04-340">Apply log filter rules in code</span></span>

<span data-ttu-id="56d04-341">设置日志筛选器规则的首选方法是使用[配置](configuration.md)。</span><span class="sxs-lookup"><span data-stu-id="56d04-341">The preferred approach for setting log filter rules is by using [Configuration](configuration.md).</span></span>

<span data-ttu-id="56d04-342">下面的示例演示了如何在代码中注册筛选规则：</span><span class="sxs-lookup"><span data-stu-id="56d04-342">The following example shows how to register filter rules in code:</span></span>

```csharp
class Program
{
    static Task Main(string[] args) =>
        CreateHostBuilder(args).Build().RunAsync();

    static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureLogging(logging =>
               logging.AddFilter("System", LogLevel.Debug)
                  .AddFilter<DebugLoggerProvider>("Microsoft", LogLevel.Information)
                  .AddFilter<ConsoleLoggerProvider>("Microsoft", LogLevel.Trace));
}
```

<span data-ttu-id="56d04-343">`logging.AddFilter("System", LogLevel.Debug)` 指定 `System` 类别和日志级别 `Debug`。</span><span class="sxs-lookup"><span data-stu-id="56d04-343">`logging.AddFilter("System", LogLevel.Debug)` specifies the `System` category and log level `Debug`.</span></span> <span data-ttu-id="56d04-344">筛选器将应用于所有提供程序，因为未配置特定的提供程序。</span><span class="sxs-lookup"><span data-stu-id="56d04-344">The filter is applied to all providers because a specific provider was not configured.</span></span>

<span data-ttu-id="56d04-345">`AddFilter<DebugLoggerProvider>("Microsoft", LogLevel.Information)` 指定以下项：</span><span class="sxs-lookup"><span data-stu-id="56d04-345">`AddFilter<DebugLoggerProvider>("Microsoft", LogLevel.Information)` specifies:</span></span>

- <span data-ttu-id="56d04-346">`Debug` 日志记录提供程序。</span><span class="sxs-lookup"><span data-stu-id="56d04-346">The `Debug` logging provider.</span></span>
- <span data-ttu-id="56d04-347">日志级别 `Information` 及更高级别。</span><span class="sxs-lookup"><span data-stu-id="56d04-347">Log level `Information` and higher.</span></span>
- <span data-ttu-id="56d04-348">以 `"Microsoft"` 开头的所有类别。</span><span class="sxs-lookup"><span data-stu-id="56d04-348">All categories starting with `"Microsoft"`.</span></span>

## <a name="see-also"></a><span data-ttu-id="56d04-349">另请参阅</span><span class="sxs-lookup"><span data-stu-id="56d04-349">See also</span></span>

- [<span data-ttu-id="56d04-350">.NET 中的日志记录提供程序</span><span class="sxs-lookup"><span data-stu-id="56d04-350">Logging providers in .NET</span></span>](logging-providers.md)
- [<span data-ttu-id="56d04-351">在 .NET 中实现自定义日志记录提供程序</span><span class="sxs-lookup"><span data-stu-id="56d04-351">Implement a custom logging provider in .NET</span></span>](custom-logging-provider.md)
- [<span data-ttu-id="56d04-352">控制台日志格式设置</span><span class="sxs-lookup"><span data-stu-id="56d04-352">Console log formatting</span></span>](console-log-formatter.md)
- [<span data-ttu-id="56d04-353">.NET 中的高性能日志记录</span><span class="sxs-lookup"><span data-stu-id="56d04-353">High-performance logging in .NET</span></span>](high-performance-logging.md)
- <span data-ttu-id="56d04-354">应在 [github.com/dotnet/extensions](https://github.com/dotnet/extensions/issues) 存储库中创建日志记录 bug</span><span class="sxs-lookup"><span data-stu-id="56d04-354">Logging bugs should be created in the [github.com/dotnet/extensions](https://github.com/dotnet/extensions/issues) repo</span></span>

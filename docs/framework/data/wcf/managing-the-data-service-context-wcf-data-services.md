---
description: '了解更多相关信息：管理数据服务上下文 (WCF Data Services) '
title: 管理数据服务上下文（WCF 数据服务）
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 713136245ae2d7d27010cc527efad83979929761
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99795009"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a><span data-ttu-id="99396-103">管理数据服务上下文（WCF 数据服务）</span><span class="sxs-lookup"><span data-stu-id="99396-103">Managing the Data Service Context (WCF Data Services)</span></span>

[!INCLUDE [wcf-deprecated](~/includes/wcf-deprecated.md)]

<span data-ttu-id="99396-104"><xref:System.Data.Services.Client.DataServiceContext> 类封装针对指定数据服务支持的操作。</span><span class="sxs-lookup"><span data-stu-id="99396-104">The <xref:System.Data.Services.Client.DataServiceContext> class encapsulates operations that are supported against a specified data service.</span></span> <span data-ttu-id="99396-105">尽管 OData 服务是无状态的，但上下文不是。</span><span class="sxs-lookup"><span data-stu-id="99396-105">Although OData services are stateless, the context is not.</span></span> <span data-ttu-id="99396-106">因此，你可以使用 <xref:System.Data.Services.Client.DataServiceContext> 类在与数据服务之间的交互之间维护客户端的状态，以支持更改管理等功能。</span><span class="sxs-lookup"><span data-stu-id="99396-106">Therefore, you can use the <xref:System.Data.Services.Client.DataServiceContext> class to maintain state on the client between interactions with the data service in order to support features such as change management.</span></span> <span data-ttu-id="99396-107">该类还对更改的标识和跟踪进行管理。</span><span class="sxs-lookup"><span data-stu-id="99396-107">This class also manages identities and tracks changes.</span></span>  
  
## <a name="merge-options-and-identity-resolution"></a><span data-ttu-id="99396-108">合并选项和标识解析</span><span class="sxs-lookup"><span data-stu-id="99396-108">Merge Options and Identity Resolution</span></span>  

 <span data-ttu-id="99396-109">当执行 <xref:System.Data.Services.Client.DataServiceQuery%601> 时，响应源中的实体将具体化为对象。</span><span class="sxs-lookup"><span data-stu-id="99396-109">When a <xref:System.Data.Services.Client.DataServiceQuery%601> is executed, the entities in the response feed are materialized into objects.</span></span> <span data-ttu-id="99396-110">有关详细信息，请参阅 [对象具体化](object-materialization-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="99396-110">For more information, see [Object Materialization](object-materialization-wcf-data-services.md).</span></span> <span data-ttu-id="99396-111">将响应消息中的项具体化为对象所采用的方式将基于标识解析，并且依赖于执行查询时所依据的合并选项。</span><span class="sxs-lookup"><span data-stu-id="99396-111">The way in which entries in a response message are materialized into objects is performed based on identity resolution and depends on the merge option under which the query was executed.</span></span> <span data-ttu-id="99396-112">在单个的范围内执行多个查询或加载请求时 <xref:System.Data.Services.Client.DataServiceContext> ，WCF Data Services 客户端只跟踪具有特定键值的对象的单个实例。</span><span class="sxs-lookup"><span data-stu-id="99396-112">When multiple queries or load requests are executed in the scope of a single <xref:System.Data.Services.Client.DataServiceContext>, the WCF Data Services client only tracks a single instance of an object that has a specific key value.</span></span> <span data-ttu-id="99396-113">用于执行标识解析的此键唯一地标识一个实体。</span><span class="sxs-lookup"><span data-stu-id="99396-113">This key, which is used to perform identity resolution, uniquely identifies an entity.</span></span>  
  
 <span data-ttu-id="99396-114">默认情况下，客户端只针对 <xref:System.Data.Services.Client.DataServiceContext> 尚未跟踪的实体，将响应源中的项具体化为对象。</span><span class="sxs-lookup"><span data-stu-id="99396-114">By default, the client only materializes an entry in the response feed into an object for entities that are not already being tracked by the <xref:System.Data.Services.Client.DataServiceContext>.</span></span> <span data-ttu-id="99396-115">这意味着不会覆盖缓存中已存在的对象更改。</span><span class="sxs-lookup"><span data-stu-id="99396-115">This means that changes to objects already in the cache are not overwritten.</span></span> <span data-ttu-id="99396-116">此行为通过为查询和加载操作指定 <xref:System.Data.Services.Client.MergeOption> 值进行控制。</span><span class="sxs-lookup"><span data-stu-id="99396-116">This behavior is controlled by specifying a <xref:System.Data.Services.Client.MergeOption> value for queries and load operations.</span></span> <span data-ttu-id="99396-117">通过设置 <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> 的 <xref:System.Data.Services.Client.DataServiceContext> 属性可指定此选项。</span><span class="sxs-lookup"><span data-stu-id="99396-117">This option is specified by setting the <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> property on the <xref:System.Data.Services.Client.DataServiceContext>.</span></span> <span data-ttu-id="99396-118">默认的合并选项值为 <xref:System.Data.Services.Client.MergeOption.AppendOnly>。</span><span class="sxs-lookup"><span data-stu-id="99396-118">The default merge option value is <xref:System.Data.Services.Client.MergeOption.AppendOnly>.</span></span> <span data-ttu-id="99396-119">这样将只为尚未进行跟踪的实体具体化对象，这意味着不会覆盖现有对象。</span><span class="sxs-lookup"><span data-stu-id="99396-119">This only materializes objects for entities that are not already being tracked, which means that existing objects are not overwritten.</span></span> <span data-ttu-id="99396-120">防止数据服务中的更新覆盖客户端上的对象更改的另一种方式是指定 <xref:System.Data.Services.Client.MergeOption.PreserveChanges>。</span><span class="sxs-lookup"><span data-stu-id="99396-120">Another way to prevent changes to objects on the client from being overwritten by updates from the data service is to specify <xref:System.Data.Services.Client.MergeOption.PreserveChanges>.</span></span> <span data-ttu-id="99396-121">当指定 <xref:System.Data.Services.Client.MergeOption.OverwriteChanges> 时，客户端上对象的值将替换为响应源中对应项的最新值，即使已对这些对象进行了更改也是如此。</span><span class="sxs-lookup"><span data-stu-id="99396-121">When you specify <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, values of objects on the client are replaced by the latest values from the entries in the response feed, even if changes have already been made to these objects.</span></span> <span data-ttu-id="99396-122">当使用 <xref:System.Data.Services.Client.MergeOption.NoTracking> 合并选项时，<xref:System.Data.Services.Client.DataServiceContext> 无法将对客户端对象所做的更改发送到数据服务。</span><span class="sxs-lookup"><span data-stu-id="99396-122">When a <xref:System.Data.Services.Client.MergeOption.NoTracking> merge option is used, the <xref:System.Data.Services.Client.DataServiceContext> cannot send changes made on client objects to the data service.</span></span> <span data-ttu-id="99396-123">使用此选项时，将始终用数据服务中的值覆盖更改。</span><span class="sxs-lookup"><span data-stu-id="99396-123">With this option, changes are always overwritten with values from the data service.</span></span>  
  
## <a name="managing-concurrency"></a><span data-ttu-id="99396-124">管理并发</span><span class="sxs-lookup"><span data-stu-id="99396-124">Managing Concurrency</span></span>  

 <span data-ttu-id="99396-125">OData 支持开放式并发，使数据服务能够检测更新冲突。</span><span class="sxs-lookup"><span data-stu-id="99396-125">OData supports optimistic concurrency that enables the data service to detect update conflicts.</span></span> <span data-ttu-id="99396-126">可以按这种方式配置数据服务提供程序，使得数据服务能够使用并发标记检查实体是否更改。</span><span class="sxs-lookup"><span data-stu-id="99396-126">The data service provider can be configured in such a way that the data service checks for changes to entities by using a concurrency token.</span></span> <span data-ttu-id="99396-127">此标记包含实体类型的一个或多个属性，数据服务通过验证这些属性来确定某个资源是否已更改。</span><span class="sxs-lookup"><span data-stu-id="99396-127">This token includes one or more properties of an entity type that are validated by the data service to determine whether a resource has changed.</span></span> <span data-ttu-id="99396-128">并发令牌（包括在对来自数据服务的请求和响应的 eTag 标头中）由 WCF Data Services 客户端管理。</span><span class="sxs-lookup"><span data-stu-id="99396-128">Concurrency tokens, which are included in the eTag header of requests to and responses from the data service, are managed for you by the WCF Data Services client.</span></span> <span data-ttu-id="99396-129">有关详细信息，请参阅 [更新数据服务](updating-the-data-service-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="99396-129">For more information, see [Updating the Data Service](updating-the-data-service-wcf-data-services.md).</span></span>  
  
 <span data-ttu-id="99396-130"><xref:System.Data.Services.Client.DataServiceContext> 通过使用 <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>、<xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A> 和 <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A> 或通过 <xref:System.Data.Services.Client.DataServiceCollection%601> 跟踪已手动报告的对对象所做的更改。</span><span class="sxs-lookup"><span data-stu-id="99396-130">The <xref:System.Data.Services.Client.DataServiceContext> tracks changes made to objects that have been reported manually by using <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>, and <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>, or by a <xref:System.Data.Services.Client.DataServiceCollection%601>.</span></span> <span data-ttu-id="99396-131">当调用 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 方法时，客户端将更改发送回数据服务。</span><span class="sxs-lookup"><span data-stu-id="99396-131">When the <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> method is called, the client sends changes back to the data service.</span></span> <span data-ttu-id="99396-132">如果客户端中的数据更改与数据服务中的更改冲突，则 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 会失败。</span><span class="sxs-lookup"><span data-stu-id="99396-132"><xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> can fail when data changes in the client conflict with changes in the data service.</span></span> <span data-ttu-id="99396-133">当发生这种情况时，您必须再次查询实体资源以接收更新数据。</span><span class="sxs-lookup"><span data-stu-id="99396-133">When this occurs, you must query for the entity resource again to receive the update data.</span></span> <span data-ttu-id="99396-134">若要覆盖数据服务中的更改，请使用 <xref:System.Data.Services.Client.MergeOption.PreserveChanges> 合并选项执行查询。</span><span class="sxs-lookup"><span data-stu-id="99396-134">To overwrite changes in the data service, execute the query using the <xref:System.Data.Services.Client.MergeOption.PreserveChanges> merge option.</span></span> <span data-ttu-id="99396-135">再次调用 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 时，只要尚未对数据服务中的资源进行其他更改，客户端上保留的更改将永久保存到数据服务。</span><span class="sxs-lookup"><span data-stu-id="99396-135">When you call <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> again, the changes preserved on the client are persisted to the data service, as long as other changes have not already been made to the resource in the data service.</span></span>  
  
## <a name="saving-changes"></a><span data-ttu-id="99396-136">保存更改</span><span class="sxs-lookup"><span data-stu-id="99396-136">Saving Changes</span></span>  

 <span data-ttu-id="99396-137">在 <xref:System.Data.Services.Client.DataServiceContext> 实例中对更改进行跟踪，但不会将更改立即发送到服务器。</span><span class="sxs-lookup"><span data-stu-id="99396-137">Changes are tracked in the <xref:System.Data.Services.Client.DataServiceContext> instance but not sent to the server immediately.</span></span> <span data-ttu-id="99396-138">在完成对指定活动的所需更改后，调用 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 以将所有更改提交给数据服务。</span><span class="sxs-lookup"><span data-stu-id="99396-138">After you are finished with the required changes for a specified activity, call <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> to submit all the changes to the data service.</span></span> <span data-ttu-id="99396-139"><xref:System.Data.Services.Client.DataServiceResponse> 操作完成后，会返回 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 对象。</span><span class="sxs-lookup"><span data-stu-id="99396-139">A <xref:System.Data.Services.Client.DataServiceResponse> object is returned after the <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> operation is complete.</span></span> <span data-ttu-id="99396-140"><xref:System.Data.Services.Client.DataServiceResponse> 对象包括一系列 <xref:System.Data.Services.Client.OperationResponse> 对象，这些对象依次又包含一系列表示已保留或尝试的更改的 <xref:System.Data.Services.Client.EntityDescriptor> 或 <xref:System.Data.Services.Client.LinkDescriptor> 实例。</span><span class="sxs-lookup"><span data-stu-id="99396-140">The <xref:System.Data.Services.Client.DataServiceResponse> object includes a sequence of <xref:System.Data.Services.Client.OperationResponse> objects that, in turn, contain a sequence of <xref:System.Data.Services.Client.EntityDescriptor> or <xref:System.Data.Services.Client.LinkDescriptor> instances that represent the changes persisted or attempted.</span></span> <span data-ttu-id="99396-141">在数据服务中创建或修改实体之后，<xref:System.Data.Services.Client.EntityDescriptor> 包含对已更新实体的引用，其中包括所有服务器生成的属性值，例如上面示例中生成的 `ProductID` 值。</span><span class="sxs-lookup"><span data-stu-id="99396-141">When an entity is created or modified in the data service, the <xref:System.Data.Services.Client.EntityDescriptor> includes a reference to the updated entity, including any server-generated property values, such as the generated `ProductID` value in the previous example.</span></span> <span data-ttu-id="99396-142">客户端库自动更新 .NET Framework 对象以获取这些新值。</span><span class="sxs-lookup"><span data-stu-id="99396-142">The client library automatically updates the .NET Framework object to have these new values.</span></span>  
  
 <span data-ttu-id="99396-143">对于成功的插入和更新操作，与操作关联的 <xref:System.Data.Services.Client.EntityDescriptor> 或 <xref:System.Data.Services.Client.LinkDescriptor> 对象的状态属性设置为 <xref:System.Data.Services.Client.EntityStates.Unchanged>，并通过使用 <xref:System.Data.Services.Client.MergeOption.OverwriteChanges> 合并新值。</span><span class="sxs-lookup"><span data-stu-id="99396-143">For successful insert and update operations, the state property of the <xref:System.Data.Services.Client.EntityDescriptor> or <xref:System.Data.Services.Client.LinkDescriptor> object associated with the operation is set to <xref:System.Data.Services.Client.EntityStates.Unchanged> and the new values are merged by using <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>.</span></span> <span data-ttu-id="99396-144">如果数据服务中的插入、更新或删除操作失败，则实体状态保持在调用 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 之前的状态，并且 <xref:System.Data.Services.Client.OperationResponse.Error%2A> 的 <xref:System.Data.Services.Client.OperationResponse> 属性设置为包含有关该错误的信息的 <xref:System.Data.Services.Client.DataServiceRequestException>。</span><span class="sxs-lookup"><span data-stu-id="99396-144">When an insert, update, or delete operation fails in the data service, the entity state remains the same as it was before <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> was called, and the <xref:System.Data.Services.Client.OperationResponse.Error%2A> property of the <xref:System.Data.Services.Client.OperationResponse> is set to an <xref:System.Data.Services.Client.DataServiceRequestException> that contains information about the error.</span></span> <span data-ttu-id="99396-145">有关详细信息，请参阅 [更新数据服务](updating-the-data-service-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="99396-145">For more information, see [Updating the Data Service](updating-the-data-service-wcf-data-services.md).</span></span>  
  
### <a name="setting-the-http-method-for-updates"></a><span data-ttu-id="99396-146">为更新设置 HTTP 方法</span><span class="sxs-lookup"><span data-stu-id="99396-146">Setting the HTTP Method for Updates</span></span>  

 <span data-ttu-id="99396-147">默认情况下，.NET Framework 客户端库将更新作为 MERGE 请求发送至现有实体。</span><span class="sxs-lookup"><span data-stu-id="99396-147">By default, the .NET Framework client library sends updates to existing entities as MERGE requests.</span></span> <span data-ttu-id="99396-148">MERGE 请求将更新实体的选定属性；但客户端始终会在 MERGE 请求中包含所有属性，即使是未更改的属性也包含在内。</span><span class="sxs-lookup"><span data-stu-id="99396-148">A MERGE request updates selected properties of the entity; however the client always includes all properties in the MERGE request, even properties that have not changed.</span></span> <span data-ttu-id="99396-149">OData 协议还支持发送 PUT 请求来更新实体。</span><span class="sxs-lookup"><span data-stu-id="99396-149">The OData protocol also supports sending PUT requests to update entities.</span></span> <span data-ttu-id="99396-150">在 PUT 请求中，现有实体实际上将替换为该实体的一个新实例，新实例具有来自客户端的属性值。</span><span class="sxs-lookup"><span data-stu-id="99396-150">In a PUT request, an existing entity is essentially replaced with a new instance of the entity with property values from the client.</span></span> <span data-ttu-id="99396-151">要使用 PUT 请求，请在调用 <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> 时为 <xref:System.Data.Services.Client.SaveChangesOptions> 枚举设置 <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> 标志。</span><span class="sxs-lookup"><span data-stu-id="99396-151">To use PUT requests, set the <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> flag on the <xref:System.Data.Services.Client.SaveChangesOptions> enumeration when calling <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="99396-152">当客户端不知道实体的所有属性时，PUT 请求的行为会与 MERGE 请求不同。</span><span class="sxs-lookup"><span data-stu-id="99396-152">A PUT request will behave differently than a MERGE request when the client does not know about all properties of the entity.</span></span> <span data-ttu-id="99396-153">当将某个实体类型投影到客户端上的新类型时，可能会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="99396-153">This might occur when projecting an entity type into a new type on the client.</span></span> <span data-ttu-id="99396-154">当新属性已经添加到服务数据模型中的实体中，同时 <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> 的 <xref:System.Data.Services.Client.DataServiceContext> 属性设置为 `true` 以忽略这类客户端映射错误时，也会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="99396-154">It might also occur when new properties have been added to the entity in the service data model and the <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> property on the <xref:System.Data.Services.Client.DataServiceContext> is set to `true` to ignore such client mapping errors.</span></span> <span data-ttu-id="99396-155">在这种情况下，PUT 请求会将客户端未知的任何属性重置为默认值。</span><span class="sxs-lookup"><span data-stu-id="99396-155">In these cases, a PUT request will reset any properties that are unknown to the client to their default values.</span></span>  
  
### <a name="post-tunneling"></a><span data-ttu-id="99396-156">POST 隧道</span><span class="sxs-lookup"><span data-stu-id="99396-156">POST Tunneling</span></span>  

 <span data-ttu-id="99396-157">默认情况下，客户端库使用 POST、GET、PUT/MERGE/PATCH 和 DELETE 的相应 HTTP 方法向 OData 服务发送创建、读取、更新和删除请求。</span><span class="sxs-lookup"><span data-stu-id="99396-157">By default, the client library sends create, read, update, and delete requests to an OData service by using the corresponding HTTP methods of POST, GET, PUT/MERGE/PATCH, and DELETE.</span></span> <span data-ttu-id="99396-158">这保持了具象状态传输 (REST) 的基本原则。</span><span class="sxs-lookup"><span data-stu-id="99396-158">This upholds the basic principles of Representational State Transfer (REST).</span></span> <span data-ttu-id="99396-159">不过，不是每个 Web 服务器实现都支持完整的 HTTP 方法集。</span><span class="sxs-lookup"><span data-stu-id="99396-159">However, not every Web server implementation supports the full set of HTTP methods.</span></span> <span data-ttu-id="99396-160">在某些情况下，支持的方法可能仅限 GET 和 POST。</span><span class="sxs-lookup"><span data-stu-id="99396-160">In some cases, the supported methods might be restricted to just GET and POST.</span></span> <span data-ttu-id="99396-161">在中介（如防火墙）用某些方法阻止请求时，可能会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="99396-161">This can happen when an intermediary, like a firewall, blocks requests with certain methods.</span></span> <span data-ttu-id="99396-162">由于 GET 和 POST 方法通常受支持，因此 OData 要求使用 POST 请求来执行任何不受支持的 HTTP 方法。</span><span class="sxs-lookup"><span data-stu-id="99396-162">Because the GET and POST methods are most often supported, OData prescribes a way to execute any unsupported HTTP methods by using a POST request.</span></span> <span data-ttu-id="99396-163">这会使客户端能够使用自定义标头中指定的实际方法发送 POST 请求 `X-HTTP-Method` 。</span><span class="sxs-lookup"><span data-stu-id="99396-163">Known as *method tunneling* or *POST tunneling*, this enables a client to send a POST request with the actual method specified in the custom `X-HTTP-Method` header.</span></span> <span data-ttu-id="99396-164">要为请求启用 POST 隧道，请将 <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> 实例上的 <xref:System.Data.Services.Client.DataServiceContext> 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="99396-164">To enable POST tunneling for requests, set the <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> property on the <xref:System.Data.Services.Client.DataServiceContext> instance to `true`.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="99396-165">请参阅</span><span class="sxs-lookup"><span data-stu-id="99396-165">See also</span></span>

- [<span data-ttu-id="99396-166">WCF 数据服务客户端库</span><span class="sxs-lookup"><span data-stu-id="99396-166">WCF Data Services Client Library</span></span>](wcf-data-services-client-library.md)
- [<span data-ttu-id="99396-167">更新数据服务</span><span class="sxs-lookup"><span data-stu-id="99396-167">Updating the Data Service</span></span>](updating-the-data-service-wcf-data-services.md)
- [<span data-ttu-id="99396-168">异步操作</span><span class="sxs-lookup"><span data-stu-id="99396-168">Asynchronous Operations</span></span>](asynchronous-operations-wcf-data-services.md)
- [<span data-ttu-id="99396-169">批处理操作</span><span class="sxs-lookup"><span data-stu-id="99396-169">Batching Operations</span></span>](batching-operations-wcf-data-services.md)

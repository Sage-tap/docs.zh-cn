---
description: 了解详细信息：有关 WCF 中安全性的最佳做法
title: WCF 中安全性的最佳做法
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- best practices [WCF], security
ms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69
ms.openlocfilehash: 67c3f3054011ea5727d5713c1eabf810a4c39b42
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99643639"
---
# <a name="best-practices-for-security-in-wcf"></a><span data-ttu-id="cf705-103">WCF 中安全性的最佳做法</span><span class="sxs-lookup"><span data-stu-id="cf705-103">Best Practices for Security in WCF</span></span>

<span data-ttu-id="cf705-104">以下各节列出了在使用 Windows Communication Foundation (WCF) 创建安全应用程序时应考虑的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="cf705-104">The following sections list the best practices to consider when creating secure applications using Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="cf705-105">有关安全性的详细信息，请参阅[安全注意事项](security-considerations-in-wcf.md)、[数据的安全注意事项](security-considerations-for-data.md)和[元数据的安全注意事项](security-considerations-with-metadata.md)。</span><span class="sxs-lookup"><span data-stu-id="cf705-105">For more information about security, see [Security Considerations](security-considerations-in-wcf.md), [Security Considerations for Data](security-considerations-for-data.md), and [Security Considerations with Metadata](security-considerations-with-metadata.md).</span></span>  
  
## <a name="identify-services-performing-windows-authentication-with-spns"></a><span data-ttu-id="cf705-106">使用 SPN 标识执行 Windows 身份验证的服务</span><span class="sxs-lookup"><span data-stu-id="cf705-106">Identify Services Performing Windows Authentication with SPNs</span></span>  

 <span data-ttu-id="cf705-107">服务可以使用用户主体名称 (UPN) 或服务主体名称 (SPN) 来标识。</span><span class="sxs-lookup"><span data-stu-id="cf705-107">Services can be identified with either user principal names (UPNs) or service principal names (SPNs).</span></span> <span data-ttu-id="cf705-108">使用计算机帐户运行的服务（如网络服务）具有 SPN 标识，该标识对应于正在运行它们的计算机。</span><span class="sxs-lookup"><span data-stu-id="cf705-108">Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running.</span></span> <span data-ttu-id="cf705-109">使用用户帐户运行的服务具有 UPN 标识，该标识对应于它们正在以其身份运行的用户，但可以使用 `setspn` 工具为该用户帐户分配一个 SPN。</span><span class="sxs-lookup"><span data-stu-id="cf705-109">Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account.</span></span> <span data-ttu-id="cf705-110">配置服务以便可以通过 SPN 标识它，同时将连接到该服务的客户端配置为使用该 SPN，这可以提高对某些攻击的抵御能力。</span><span class="sxs-lookup"><span data-stu-id="cf705-110">Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult.</span></span> <span data-ttu-id="cf705-111">此指导信息适用于使用 Kerberos 或 SSPI 协商的绑定。</span><span class="sxs-lookup"><span data-stu-id="cf705-111">This guidance applies to bindings using Kerberos or SSPI negotiation.</span></span>  <span data-ttu-id="cf705-112">即使 SSPI 降级为 NTLM，客户端应仍指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="cf705-112">Clients should still specify an SPN in the case where SSPI falls back to NTLM.</span></span>  
  
## <a name="verify-service-identities-in-wsdl"></a><span data-ttu-id="cf705-113">验证 WSDL 中的服务标识</span><span class="sxs-lookup"><span data-stu-id="cf705-113">Verify Service Identities in WSDL</span></span>  

 <span data-ttu-id="cf705-114">WS-SecurityPolicy 允许服务在元数据中发布有关其自身标识的信息。</span><span class="sxs-lookup"><span data-stu-id="cf705-114">WS-SecurityPolicy allows services to publish information about their own identities in metadata.</span></span> <span data-ttu-id="cf705-115">通过 `svcutil` 或其他方法（如 <xref:System.ServiceModel.Description.WsdlImporter>）进行检索时，此标识信息将转换为 WCF 服务终结点地址的标识属性。</span><span class="sxs-lookup"><span data-stu-id="cf705-115">When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the WCF service endpoint addresses.</span></span> <span data-ttu-id="cf705-116">若客户端不验证这些服务标识是否正确、有效，则实际上是跳过了服务身份验证。</span><span class="sxs-lookup"><span data-stu-id="cf705-116">Clients which do not verify that these service identities are correct and valid effectively bypass service authentication.</span></span> <span data-ttu-id="cf705-117">恶意服务可以通过更改其 WSDL 中声称的标识，利用此类客户端来执行凭据转发和其他“中间人”攻击。</span><span class="sxs-lookup"><span data-stu-id="cf705-117">A malicious service can exploit such clients to execute credential forwarding and other "man in the middle" attacks by changing the identity claimed in its WSDL.</span></span>  
  
## <a name="use-x509-certificates-instead-of-ntlm"></a><span data-ttu-id="cf705-118">使用 X509 证书而不是 NTLM</span><span class="sxs-lookup"><span data-stu-id="cf705-118">Use X509 Certificates Instead of NTLM</span></span>  

 <span data-ttu-id="cf705-119">WCF 为对等身份验证提供两种机制：X509 证书（由对等通道使用）和 Windows 身份验证（其中 SSPI 协商从 Kerberos 降级为 NTLM）。</span><span class="sxs-lookup"><span data-stu-id="cf705-119">WCF offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.</span></span>  <span data-ttu-id="cf705-120">由于以下几个原因，使用 1024 位或更多位的密钥、基于证书的身份验证优于 NTLM：</span><span class="sxs-lookup"><span data-stu-id="cf705-120">Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:</span></span>  
  
- <span data-ttu-id="cf705-121">提供相互身份验证；</span><span class="sxs-lookup"><span data-stu-id="cf705-121">the availability of mutual authentication,</span></span>  
  
- <span data-ttu-id="cf705-122">使用更强的加密算法；以及</span><span class="sxs-lookup"><span data-stu-id="cf705-122">the use of stronger cryptographic algorithms, and</span></span>  
  
- <span data-ttu-id="cf705-123">不易使用转发的 X509 凭据。</span><span class="sxs-lookup"><span data-stu-id="cf705-123">the greater difficulty of utilizing forwarded X509 credentials.</span></span>  

## <a name="always-revert-after-impersonation"></a><span data-ttu-id="cf705-124">始终在模拟后还原</span><span class="sxs-lookup"><span data-stu-id="cf705-124">Always Revert After Impersonation</span></span>  

 <span data-ttu-id="cf705-125">在使用启用客户端模拟的 API 时，应确保还原为原始标识。</span><span class="sxs-lookup"><span data-stu-id="cf705-125">When using APIs that enable impersonation of a client, be sure to revert to the original identity.</span></span> <span data-ttu-id="cf705-126">例如，在使用 <xref:System.Security.Principal.WindowsIdentity> 和 <xref:System.Security.Principal.WindowsImpersonationContext> 时使用 C# `using` 语句或 Visual Basic `Using` 语句，如以下代码中所示。</span><span class="sxs-lookup"><span data-stu-id="cf705-126">For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the Visual Basic`Using` statement, as shown in the following code.</span></span> <span data-ttu-id="cf705-127"><xref:System.Security.Principal.WindowsImpersonationContext> 类实现 <xref:System.IDisposable> 接口，因此，一旦代码离开 `using` 块，公共语言运行库 (CLR) 就会自动还原到原始标识。</span><span class="sxs-lookup"><span data-stu-id="cf705-127">The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block.</span></span>  
  
 [!code-csharp[c_SecurityBestPractices#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_securitybestpractices/cs/source.cs#1)]
 [!code-vb[c_SecurityBestPractices#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_securitybestpractices/vb/source.vb#1)]  
  
## <a name="impersonate-only-as-needed"></a><span data-ttu-id="cf705-128">仅根据需要进行模拟</span><span class="sxs-lookup"><span data-stu-id="cf705-128">Impersonate Only as Needed</span></span>  

 <span data-ttu-id="cf705-129">通过使用 <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> 类的 <xref:System.Security.Principal.WindowsIdentity> 方法，可以在控制极严的范围中使用模拟。</span><span class="sxs-lookup"><span data-stu-id="cf705-129">Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope.</span></span> <span data-ttu-id="cf705-130">与此相反的是，使用 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> 的 <xref:System.ServiceModel.OperationBehaviorAttribute> 属性允许对整个操作的范围进行模拟。</span><span class="sxs-lookup"><span data-stu-id="cf705-130">This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation.</span></span> <span data-ttu-id="cf705-131">只要有可能，应使用更精确的 <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> 方法来控制模拟的范围。</span><span class="sxs-lookup"><span data-stu-id="cf705-131">Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method.</span></span>  
  
## <a name="obtain-metadata-from-trusted-sources"></a><span data-ttu-id="cf705-132">从受信任的源获取元数据</span><span class="sxs-lookup"><span data-stu-id="cf705-132">Obtain Metadata from Trusted Sources</span></span>  

 <span data-ttu-id="cf705-133">确保信任元数据的源，并确保没有人篡改元数据。</span><span class="sxs-lookup"><span data-stu-id="cf705-133">Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata.</span></span> <span data-ttu-id="cf705-134">使用 HTTP 协议检索到的元数据是以明文形式发送的，可能被篡改。</span><span class="sxs-lookup"><span data-stu-id="cf705-134">Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with.</span></span> <span data-ttu-id="cf705-135">如果服务使用 <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> 和 <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> 属性，请根据服务创建者提供的 URL，使用 HTTPS 协议下载数据。</span><span class="sxs-lookup"><span data-stu-id="cf705-135">If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.</span></span>  
  
## <a name="publish-metadata-using-security"></a><span data-ttu-id="cf705-136">使用安全发布元数据</span><span class="sxs-lookup"><span data-stu-id="cf705-136">Publish Metadata Using Security</span></span>  

 <span data-ttu-id="cf705-137">要防止篡改服务的已发布元数据，可使用传输或消息级安全来保证元数据交换终结点的安全。</span><span class="sxs-lookup"><span data-stu-id="cf705-137">To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security.</span></span> <span data-ttu-id="cf705-138">有关详细信息，请参阅[发布元数据终结点](../publishing-metadata-endpoints.md)和[如何：使用代码发布服务的元数据](how-to-publish-metadata-for-a-service-using-code.md)。</span><span class="sxs-lookup"><span data-stu-id="cf705-138">For more information, see [Publishing Metadata Endpoints](../publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](how-to-publish-metadata-for-a-service-using-code.md).</span></span>  
  
## <a name="ensure-use-of-local-issuer"></a><span data-ttu-id="cf705-139">确保使用本地颁发者</span><span class="sxs-lookup"><span data-stu-id="cf705-139">Ensure Use of Local Issuer</span></span>  

 <span data-ttu-id="cf705-140">如果为某个给定绑定指定了颁发者地址和绑定，则不对使用该绑定的终结点使用本地颁发者。</span><span class="sxs-lookup"><span data-stu-id="cf705-140">If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding.</span></span> <span data-ttu-id="cf705-141">希望始终使用本地颁发者的客户应确保不使用这样的绑定，或修改绑定以使颁发者地址为 null。</span><span class="sxs-lookup"><span data-stu-id="cf705-141">Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.</span></span>  
  
## <a name="saml-token-size-quotas"></a><span data-ttu-id="cf705-142">SAML 令牌大小配额</span><span class="sxs-lookup"><span data-stu-id="cf705-142">SAML Token Size Quotas</span></span>  

 <span data-ttu-id="cf705-143">如果在消息中序列化安全断言标记语言 (SAML) 令牌，无论这些令牌是由安全令牌服务 (STS) 颁发的，还是客户端将其作为身份验证的一部分提交给服务，最大消息大小配额都必须足够大，以便能够容纳 SAML 令牌和其他消息部分。</span><span class="sxs-lookup"><span data-stu-id="cf705-143">When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts.</span></span> <span data-ttu-id="cf705-144">正常情况下，默认消息大小配额足够使用。</span><span class="sxs-lookup"><span data-stu-id="cf705-144">In normal cases, the default message size quotas are sufficient.</span></span> <span data-ttu-id="cf705-145">但是，当 SAML 令牌由于包含数以百计的声明而过于庞大时，您可能需要提高配额，以便容纳序列化的令牌。</span><span class="sxs-lookup"><span data-stu-id="cf705-145">However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token.</span></span> <span data-ttu-id="cf705-146">有关配额的详细信息，请参阅[数据的安全注意事项](security-considerations-for-data.md)。</span><span class="sxs-lookup"><span data-stu-id="cf705-146">For more information about quotas, see [Security Considerations for Data](security-considerations-for-data.md).</span></span>  
  
## <a name="set-securitybindingelementincludetimestamp-to-true-on-custom-bindings"></a><span data-ttu-id="cf705-147">将自定义绑定上的 SecurityBindingElement.IncludeTimestamp 设置为 True</span><span class="sxs-lookup"><span data-stu-id="cf705-147">Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings</span></span>  

 <span data-ttu-id="cf705-148">创建自定义绑定时，必须将 <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> 设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="cf705-148">When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`.</span></span> <span data-ttu-id="cf705-149">否则如果将 <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> 设置为 `false`，并且客户端使用基于非对称密钥的令牌（例如 X509 证书），则不会对消息进行签名。</span><span class="sxs-lookup"><span data-stu-id="cf705-149">Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="cf705-150">请参阅</span><span class="sxs-lookup"><span data-stu-id="cf705-150">See also</span></span>

- [<span data-ttu-id="cf705-151">安全注意事项</span><span class="sxs-lookup"><span data-stu-id="cf705-151">Security Considerations</span></span>](security-considerations-in-wcf.md)
- [<span data-ttu-id="cf705-152">数据的安全考虑事项</span><span class="sxs-lookup"><span data-stu-id="cf705-152">Security Considerations for Data</span></span>](security-considerations-for-data.md)
- [<span data-ttu-id="cf705-153">元数据的安全注意事项</span><span class="sxs-lookup"><span data-stu-id="cf705-153">Security Considerations with Metadata</span></span>](security-considerations-with-metadata.md)

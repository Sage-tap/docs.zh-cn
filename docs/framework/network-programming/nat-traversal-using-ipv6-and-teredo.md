---
description: 详细了解：使用 IPv6 和 Teredo 的 NAT 遍历
title: 使用 IPv6 和 Teredo 的 NAT 遍历
ms.date: 03/30/2017
ms.assetid: 568cd245-3300-49ef-a995-d81bf845d961
ms.openlocfilehash: 4ff7f273c01ef52f4d307cbd3e0698c5cc2ead4d
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99785739"
---
# <a name="nat-traversal-using-ipv6-and-teredo"></a><span data-ttu-id="95967-103">使用 IPv6 和 Teredo 的 NAT 遍历</span><span class="sxs-lookup"><span data-stu-id="95967-103">NAT Traversal using IPv6 and Teredo</span></span>

<span data-ttu-id="95967-104">增强了功能：为网络地址转换 (NAT) 遍历提供支持。</span><span class="sxs-lookup"><span data-stu-id="95967-104">Enhancements were made that provide support for Network Address Translation (NAT) traversal.</span></span> <span data-ttu-id="95967-105">这些更改旨在用于 IPv6 和 Teredo，但也同样适用于其他 IP 隧道技术。</span><span class="sxs-lookup"><span data-stu-id="95967-105">These changes are designed for use with IPv6 and Teredo, but they are also applicable to other IP tunneling technologies.</span></span> <span data-ttu-id="95967-106">这些增强功能会影响 <xref:System.Net> 和相关命名空间中的类。</span><span class="sxs-lookup"><span data-stu-id="95967-106">These enhancements affect classes in the <xref:System.Net> and related namespaces.</span></span>  
  
 <span data-ttu-id="95967-107">这些更改会影响客户端和计划使用 IP 隧道技术的服务器应用程序。</span><span class="sxs-lookup"><span data-stu-id="95967-107">These changes can affect client and server applications that plan to use IP tunneling technologies.</span></span>  
  
 <span data-ttu-id="95967-108">支持 NAT 遍历的更改仅可用于使用 .NET Framework 版本 4 的应用程序。</span><span class="sxs-lookup"><span data-stu-id="95967-108">The changes to support NAT traversal are available only for applications using .NET Framework version 4.</span></span> <span data-ttu-id="95967-109">这些功能不可用于 .NET Framework 的早期版本。</span><span class="sxs-lookup"><span data-stu-id="95967-109">These features are not available on earlier versions of the .NET Framework.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="95967-110">概述</span><span class="sxs-lookup"><span data-stu-id="95967-110">Overview</span></span>  

 <span data-ttu-id="95967-111">Internet 协议版本 4 (IPv4) 将 IPv4 地址的长度定义为 32 位。</span><span class="sxs-lookup"><span data-stu-id="95967-111">The Internet Protocol version 4 (IPv4) defined an IPv4 address as 32 bits long.</span></span> <span data-ttu-id="95967-112">因此，IPv4 支持大约 40 亿个唯一 IP 地址（2^32）。</span><span class="sxs-lookup"><span data-stu-id="95967-112">As a result, IPv4 supports approximately 4 billion unique IP addresses (2^32).</span></span> <span data-ttu-id="95967-113">20 世纪 90 年代，随着 Internet 上计算机和网络设备数量的增加，IPv4 地址空间的限制变得明显起来。</span><span class="sxs-lookup"><span data-stu-id="95967-113">As the number of computers and network devices on the Internet expanded in the 1990s, the limits of the IPv4 address space became apparent.</span></span>  
  
 <span data-ttu-id="95967-114">有几种技术可延长 IPv4 的生存期，其中一种是通过部署 NAT，使单个唯一公共 IP 地址可以表示大量专用 IP 地址（专用 Intranet）。</span><span class="sxs-lookup"><span data-stu-id="95967-114">One of several techniques used to extend the lifetime of IPv4 has been to deploy NAT to allow a single unique public IP address to represent a large number of private IP addresses (private Intranet).</span></span> <span data-ttu-id="95967-115">NAT 设备后的多个专用 IP 地址共享一个公共 IPv4 地址。</span><span class="sxs-lookup"><span data-stu-id="95967-115">The private IP addresses behind the NAT device share the single public IPv4 address.</span></span> <span data-ttu-id="95967-116">NAT 设备可能是一个专用的硬件设备（例如，成本较低的无线接入点和路由器），或者是运行设备以便提供 NAT 的计算机。</span><span class="sxs-lookup"><span data-stu-id="95967-116">The NAT device may be a dedicated hardware device (an inexpensive Wireless Access Point and router, for example) or a computer running a service to provide NAT.</span></span> <span data-ttu-id="95967-117">这种公共 IP 地址的设备或服务转换公共 Internet 和专用 Intranet 之间的 IP 网络数据包。</span><span class="sxs-lookup"><span data-stu-id="95967-117">A device or service for this public IP address translates IP network packets between the public Internet and the private Intranet.</span></span>  
  
 <span data-ttu-id="95967-118">此方案非常适用于在专用 Intranet 上运行的客户端应用程序，该应用程序将请求发送到 Internet 上的其他 IP 地址（通常为服务器）。</span><span class="sxs-lookup"><span data-stu-id="95967-118">This scheme works well for client applications running on the private Intranet that send requests to other IP addresses (usually servers) on the Internet.</span></span> <span data-ttu-id="95967-119">NAT 设备或服务器可以保留客户端请求的映射，因此响应返回后，它知道要将响应发送到什么位置。</span><span class="sxs-lookup"><span data-stu-id="95967-119">The NAT device or server can keep a mapping of client requests so when a response is returned it knows where to send the response.</span></span> <span data-ttu-id="95967-120">但是，对于在 NAT 设备后的专用 Intranet 上运行且需要提供服务、侦听数据包和做出响应的应用程序，这一方案也带来了一些问题。</span><span class="sxs-lookup"><span data-stu-id="95967-120">But this scheme poses problems for applications running in the private Intranet behind the NAT device that want to provide services, listen for packets, and respond.</span></span> <span data-ttu-id="95967-121">对于对等应用程序而言，尤为如此。</span><span class="sxs-lookup"><span data-stu-id="95967-121">This is particularly the case for peer-to-peer applications.</span></span>  
  
 <span data-ttu-id="95967-122">IPv6 协议将 IPv4 地址的长度定义为 128 位。</span><span class="sxs-lookup"><span data-stu-id="95967-122">The IPv6 protocol defined an IPv4 address as 128 bits long.</span></span> <span data-ttu-id="95967-123">因此，IPv6 支持具有 3.2 x 10^38 个唯一地址（2^128）的超大 IP 地址空间。</span><span class="sxs-lookup"><span data-stu-id="95967-123">As a result, IPv6 supports very a large IP address space of 3.2 x 10^38 unique addresses (2^128).</span></span> <span data-ttu-id="95967-124">凭借这一大小的地址空间，便能为每台连接到 Internet 的设备提供一个唯一的地址。</span><span class="sxs-lookup"><span data-stu-id="95967-124">With an address space of this size, it is possible for every device connected to the Internet to be given a unique address.</span></span> <span data-ttu-id="95967-125">但是还存在一些问题。</span><span class="sxs-lookup"><span data-stu-id="95967-125">But there are problems.</span></span> <span data-ttu-id="95967-126">世界上许多地方仍然只使用 IPv4。</span><span class="sxs-lookup"><span data-stu-id="95967-126">Much of the world is still using only IPv4.</span></span> <span data-ttu-id="95967-127">特别是一些小型公司、组织和家庭使用的现有路由器和无线接入点，它们不支持 IPv6。</span><span class="sxs-lookup"><span data-stu-id="95967-127">In particular, many of the existing routers and wireless access points used by small companies, organizations, and households do not support IPv6.</span></span> <span data-ttu-id="95967-128">此外，一些为客户提供服务的 Internet 服务提供商也不支持 IPv6 或尚未配置对 IPv6 的支持。</span><span class="sxs-lookup"><span data-stu-id="95967-128">Also some Internet service providers that serve these customers either do not support or have not configured support for IPv6.</span></span>  
  
 <span data-ttu-id="95967-129">已开发多个 IPv6 转换技术，用于在 IPv4 数据包中挖掘 IPv6 隧道地址。</span><span class="sxs-lookup"><span data-stu-id="95967-129">Several IPv6 transition technologies have been developed to tunnel IPv6 addresses in an IPv4 packet.</span></span> <span data-ttu-id="95967-130">这些技术包括 6to4、ISATAP 和 Teredo 隧道，在 IPv6 主机必须遍历 IP4 网络来连接其他 IPv6 网络时，为单播 IPv6 流量提供地址分配和主机到主机的自动隧道。</span><span class="sxs-lookup"><span data-stu-id="95967-130">These technologies include 6to4, ISATAP, and Teredo tunnels that provide address assignment and host-to-host automatic tunneling for unicast IPv6 traffic when IPv6 hosts must traverse IP4 networks to reach other IPv6 networks.</span></span> <span data-ttu-id="95967-131">IPv6 数据包将隧道作为 IPv4 数据包发送。</span><span class="sxs-lookup"><span data-stu-id="95967-131">IPv6 packets are sent tunneled as IPv4 packets.</span></span> <span data-ttu-id="95967-132">正在使用多个隧道技术通过 NAT 设备实现 IPv6 地址的 NAT 遍历。</span><span class="sxs-lookup"><span data-stu-id="95967-132">Several tunneling techniques are being used that allow NAT traversal for IPv6 addresses through a NAT device.</span></span>  
  
 <span data-ttu-id="95967-133">Teredo 是 IPv6 转换技术之一，使 IPv6 连接到 IPv4 网络。</span><span class="sxs-lookup"><span data-stu-id="95967-133">Teredo is one of the IPv6 transition technologies which brings IPv6 connectivity to IPv4 networks.</span></span> <span data-ttu-id="95967-134">Internet 工程任务组发布的 RFC 4380 中记录了这一技术。</span><span class="sxs-lookup"><span data-stu-id="95967-134">Teredo is documented in RFC 4380 published by the Internet Engineering Task Force (IETF).</span></span> <span data-ttu-id="95967-135">Windows XP SP2 及更高版本为能够在 2001:0::/32 范围内提供公共 IPv6 地址的虚拟 Teredo 适配器提供支持。</span><span class="sxs-lookup"><span data-stu-id="95967-135">Windows XP SP2 and later provide support for a virtual Teredo adapter which can provide a public IPv6 address in the range 2001:0::/32.</span></span> <span data-ttu-id="95967-136">此 IPv6 地址可用于侦听从 Internet 传入的连接，并且可以提供给支持 IPv6、需要连接到侦听服务的客户端。</span><span class="sxs-lookup"><span data-stu-id="95967-136">This IPv6 address can be used to listen for incoming connections from the Internet and can be provided to IPv6 enabled clients that wish to connect to the listening service.</span></span> <span data-ttu-id="95967-137">应用程序可以只使用计算机的 IPv6 Teredo 地址连接计算机，因此，无需再担心应用程序如何为 NAT 设备下的计算机寻址。</span><span class="sxs-lookup"><span data-stu-id="95967-137">This frees an application from worrying about how to address a computer behind a NAT device, since the application can just connect to it using its IPv6 Teredo address.</span></span>  
  
## <a name="enhancements-to-support-nat-traversal-and-teredo"></a><span data-ttu-id="95967-138">支持 NAT 遍历和 Teredo 的增强功能</span><span class="sxs-lookup"><span data-stu-id="95967-138">Enhancements to Support NAT Traversal and Teredo</span></span>  

 <span data-ttu-id="95967-139">向 <xref:System.Net>、<xref:System.Net.NetworkInformation>和 <xref:System.Net.Sockets> 命名空间添加了增强功能，这些增强功能支持使用 IPv6 和 Teredo 进行 NAT 遍历。</span><span class="sxs-lookup"><span data-stu-id="95967-139">Enhancements are added to the <xref:System.Net>, <xref:System.Net.NetworkInformation>, and <xref:System.Net.Sockets> namespaces for supporting NAT traversal using IPv6 and Teredo.</span></span>  
  
 <span data-ttu-id="95967-140">向 <xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> 类添加了几种方法，用于获取主机上的单播 IP 地址列表。</span><span class="sxs-lookup"><span data-stu-id="95967-140">Several methods are added to the <xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> class to get the list of unicast IP addresses on the host.</span></span> <span data-ttu-id="95967-141"><xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> 方法发起一个异步请求，该请求用于检索本地计算机上稳定的单播 IP 地址表。</span><span class="sxs-lookup"><span data-stu-id="95967-141">The <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> method begins an asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="95967-142"><xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> 方法结束挂起的异步请求，该请求用于检索本地计算机上稳定的单播 IP 地址表。</span><span class="sxs-lookup"><span data-stu-id="95967-142">The <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> method ends a pending asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="95967-143"><xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> 方法是一来检索本地计算机上稳定的单播 IP 地址的异步请求，它根据需要等待，直到地址表稳定。</span><span class="sxs-lookup"><span data-stu-id="95967-143">The <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> method is a synchronous request to retrieve the stable unicast IP address table on the local computer, waiting until the address table stabilizes if necessary.</span></span>  
  
 <span data-ttu-id="95967-144"><xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType> 属性可以用于确定 <xref:System.Net.IPAddress> 是否为 IPv6 Teredo 地址。</span><span class="sxs-lookup"><span data-stu-id="95967-144">The <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType> property can be used to determine if an <xref:System.Net.IPAddress> is an IPv6 Teredo address.</span></span>  
  
 <span data-ttu-id="95967-145">联合使用这些新 <xref:System.Net.NetworkInformation.IPGlobalProperties> 类方法和 <xref:System.Net.IPAddress.IsIPv6Teredo%2A> 属性可让应用程序轻松查找 Teredo 地址。</span><span class="sxs-lookup"><span data-stu-id="95967-145">Using these new <xref:System.Net.NetworkInformation.IPGlobalProperties> class methods in combination with the <xref:System.Net.IPAddress.IsIPv6Teredo%2A> property allows an application to easily find the Teredo address.</span></span> <span data-ttu-id="95967-146">如果应用程序将本地 Teredo 地址传达给远程应用程序，则它只需知道该信息即可。</span><span class="sxs-lookup"><span data-stu-id="95967-146">An application normally only needs to know the local Teredo address if it is communicating this information to remote applications.</span></span> <span data-ttu-id="95967-147">例如，一个对等应用程序可能会将其所有 IPv6 地址发送给匹配服务器，该服务器再将这些地址转发给其他对等机，从而实现直接通信。</span><span class="sxs-lookup"><span data-stu-id="95967-147">For example, a peer-to-peer application might send all of its IPv6 addresses to a matchmaking server which can then forward them to others peers to enable direct communication.</span></span>  
  
 <span data-ttu-id="95967-148">应用程序通常应将其侦听服务设置为在 <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType> 上侦听，而不是在本地 Teredo 地址上侦听。</span><span class="sxs-lookup"><span data-stu-id="95967-148">An application should normally set its listening service to listen on <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType> rather than on the local Teredo address.</span></span> <span data-ttu-id="95967-149">因此，如果远程客户端或对等机具有侦听服务主机的直接 IPv6 路由，该客户端或对等机可以使用 IPv6（而无需使用 Teredo）直接连接到隧道数据包。</span><span class="sxs-lookup"><span data-stu-id="95967-149">So if a remote client or peer has a direct IPv6 route to the host of the listening service, the client or peer can connect directly using IPv6 and not have to use Teredo to tunnel packets.</span></span>  
  
 <span data-ttu-id="95967-150">对于 TCP 应用程序，<xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType> 类具有 <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> 方法，该方法可启用 NAT 遍历。</span><span class="sxs-lookup"><span data-stu-id="95967-150">For TCP applications, the <xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> method to enable NAT traversal.</span></span> <span data-ttu-id="95967-151">对于 UDP 应用程序，<xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType> 类具有 <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> 方法，该方法可启用 NAT 遍历。</span><span class="sxs-lookup"><span data-stu-id="95967-151">For UDP applications, the <xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> method to enable NAT traversal.</span></span>  
  
 <span data-ttu-id="95967-152">对于使用 <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> 和相关类的应用程序，可将 <xref:System.Net.Sockets.Socket.GetSocketOption%2A> 和 <xref:System.Net.Sockets.Socket.SetSocketOption%2A> 方法与 <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType> 套接字选项一起使用，用于查询、启用或禁用 NAT 遍历。</span><span class="sxs-lookup"><span data-stu-id="95967-152">For applications that use the <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> and related classes, the <xref:System.Net.Sockets.Socket.GetSocketOption%2A> and <xref:System.Net.Sockets.Socket.SetSocketOption%2A> methods can be used with the <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType> socket option to query, enable, or disable NAT traversal.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="95967-153">另请参阅</span><span class="sxs-lookup"><span data-stu-id="95967-153">See also</span></span>

- <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.IPProtectionLevel?displayProperty=nameWithType>
- <xref:System.Net.Sockets.Socket.SetIPProtectionLevel%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A?displayProperty=nameWithType>

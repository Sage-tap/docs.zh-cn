---
description: 了解详细信息： ADO.NET 中的数据跟踪
title: 数据跟踪
ms.date: 03/30/2017
ms.assetid: a6a752a5-d2a9-4335-a382-b58690ccb79f
ms.openlocfilehash: 7fc4407e76ea34bacc97177d6342730a8263b5c9
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99663737"
---
# <a name="data-tracing-in-adonet"></a><span data-ttu-id="3125a-103">ADO.NET 中的数据跟踪</span><span class="sxs-lookup"><span data-stu-id="3125a-103">Data Tracing in ADO.NET</span></span>

<span data-ttu-id="3125a-104">ADO.NET 功能内置数据跟踪功能，适用于 SQL Server、Oracle、OLE DB 和 ODBC 的 .NET 数据提供程序，以及 ADO.NET <xref:System.Data.DataSet> 和 SQL Server 网络协议。</span><span class="sxs-lookup"><span data-stu-id="3125a-104">ADO.NET features built-in data tracing functionality that is supported by the .NET data providers for SQL Server, Oracle, OLE DB and ODBC, as well as the ADO.NET <xref:System.Data.DataSet>, and the SQL Server network protocols.</span></span>

<span data-ttu-id="3125a-105">跟踪数据访问 API 调用可以帮助诊断以下问题：</span><span class="sxs-lookup"><span data-stu-id="3125a-105">Tracing data access API calls can help diagnose the following problems:</span></span>

- <span data-ttu-id="3125a-106">客户端程序和数据库之间的架构不匹配。</span><span class="sxs-lookup"><span data-stu-id="3125a-106">Schema mismatch between client program and the database.</span></span>

- <span data-ttu-id="3125a-107">数据库不可用或网络库问题。</span><span class="sxs-lookup"><span data-stu-id="3125a-107">Database unavailability or network library problems.</span></span>

- <span data-ttu-id="3125a-108">不正确的 SQL，无论是硬编码还是由应用程序生成。</span><span class="sxs-lookup"><span data-stu-id="3125a-108">Incorrect SQL whether hard coded or generated by an application.</span></span>

- <span data-ttu-id="3125a-109">不正确的编程逻辑。</span><span class="sxs-lookup"><span data-stu-id="3125a-109">Incorrect programming logic.</span></span>

- <span data-ttu-id="3125a-110">多个 ADO.NET 组件之间或 ADO.NET 与您自己的组件之间的交互引发的问题。</span><span class="sxs-lookup"><span data-stu-id="3125a-110">Issues resulting from the interaction between multiple ADO.NET components or between ADO.NET and your own components.</span></span>

<span data-ttu-id="3125a-111">为了支持不同的跟踪技术，跟踪是可扩展的，这样，开发人员可以在任何应用程序堆栈级别上跟踪问题。</span><span class="sxs-lookup"><span data-stu-id="3125a-111">To support different trace technologies, tracing is extensible, so a developer can trace a problem at any level of the application stack.</span></span> <span data-ttu-id="3125a-112">尽管跟踪不属于纯 ADO.NET 功能，但是，Microsoft 提供程序利用通用的跟踪和规范 API。</span><span class="sxs-lookup"><span data-stu-id="3125a-112">Although tracing is not an ADO.NET-only feature, Microsoft providers take advantage of generalized tracing and instrumentation APIs.</span></span>

<span data-ttu-id="3125a-113">有关在 ADO.NET 中设置和配置托管跟踪的详细信息，请参阅 [跟踪数据访问](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))。</span><span class="sxs-lookup"><span data-stu-id="3125a-113">For more information about setting and configuring managed tracing in ADO.NET, see [Tracing Data Access](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).</span></span>

## <a name="accessing-diagnostic-information-in-the-extended-events-log"></a><span data-ttu-id="3125a-114">访问扩展事件日志中的诊断信息</span><span class="sxs-lookup"><span data-stu-id="3125a-114">Accessing Diagnostic Information in the Extended Events Log</span></span>

<span data-ttu-id="3125a-115">在用于 SQL Server 的 .NET Framework 数据提供程序中，数据访问跟踪 ([数据访问跟踪](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) 已更新，以便更轻松地将客户端事件与诊断信息关联，如连接失败、从服务器的连接环形缓冲区和扩展事件日志中的应用程序性能信息。</span><span class="sxs-lookup"><span data-stu-id="3125a-115">In the .NET Framework Data Provider for SQL Server, data access tracing ([Data Access Tracing](/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) has been updated to make it easier to correlate client events with diagnostic information, such as connection failures, from the server's connectivity ring buffer and application performance information in the extended events log.</span></span> <span data-ttu-id="3125a-116">有关读取扩展事件日志的信息，请参阅[查看事件会话数据](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110))。</span><span class="sxs-lookup"><span data-stu-id="3125a-116">For information about reading the extended events log, see [View Event Session Data](/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).</span></span>

<span data-ttu-id="3125a-117">对于连接操作，ADO.NET 将发送一个客户端连接 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-117">For connection operations, ADO.NET will send a client connection ID.</span></span> <span data-ttu-id="3125a-118">如果连接失败，你可以访问连接环形缓冲区（[在 SQL Server 2008 中使用连接环形缓冲区解决连接问题](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)），查找 `ClientConnectionID` 字段并获取有关连接失败的诊断信息。</span><span class="sxs-lookup"><span data-stu-id="3125a-118">If the connection fails, you can access the connectivity ring buffer ([Connectivity troubleshooting in SQL Server 2008 with the Connectivity Ring Buffer](/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)) and find the `ClientConnectionID` field and get diagnostic information about the connection failure.</span></span> <span data-ttu-id="3125a-119">仅当发生错误时，才在环形缓冲区中记录客户端连接 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-119">Client connection IDs are logged in the ring buffer only if an error occurs.</span></span> <span data-ttu-id="3125a-120">（如果在发送预登录数据包前连接失败，将不会生成客户端连接 ID。）客户端连接 ID 是 16 字节的 GUID。</span><span class="sxs-lookup"><span data-stu-id="3125a-120">(If a connection fails before sending the prelogin packet, a client connection ID will not be generated.) The client connection ID is a 16-byte GUID.</span></span> <span data-ttu-id="3125a-121">如果 `client_connection_id` 操作已添加到扩展事件会话中的事件，则还可以在扩展事件目标输出中找到查找客户端连接 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-121">You can also find the client connection ID in the extended events target output, if the `client_connection_id` action is added to events in an extended events session.</span></span> <span data-ttu-id="3125a-122">如果需要进一步的客户端驱动程序诊断帮助，可以启用数据访问跟踪并重新运行连接命令，然后观察 `ClientConnectionID` 字段。</span><span class="sxs-lookup"><span data-stu-id="3125a-122">You can enable data access tracing and rerun the connection command and observe the `ClientConnectionID` field in the data access trace, if you need further client driver diagnostic assistance.</span></span>

<span data-ttu-id="3125a-123">还可以通过使用 `SqlConnection.ClientConnectionID` 属性以编程方式获取客户端连接 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-123">You can get the client connection ID programmatically by using the `SqlConnection.ClientConnectionID` property.</span></span>

<span data-ttu-id="3125a-124">`ClientConnectionID` 可用于成功建立连接的 <xref:System.Data.SqlClient.SqlConnection> 对象。</span><span class="sxs-lookup"><span data-stu-id="3125a-124">The `ClientConnectionID` is available for a <xref:System.Data.SqlClient.SqlConnection> object that successfully establishes  a connection.</span></span> <span data-ttu-id="3125a-125">如果连接尝试失败，则 `ClientConnectionID` 可通过 `SqlException.ToString` 提供。</span><span class="sxs-lookup"><span data-stu-id="3125a-125">If a connection attempt fails, `ClientConnectionID` may be available via `SqlException.ToString`.</span></span>

<span data-ttu-id="3125a-126">ADO.NET 还会发送一个特定于线程的活动 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-126">ADO.NET also sends a thread-specific activity ID.</span></span> <span data-ttu-id="3125a-127">如果开始会话时启用了 TRACK_CAUSALITY 选项，则会在扩展的事件会话中捕获活动 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-127">The activity ID is captured in the extended events sessions if the sessions are started with the TRACK_CAUSALITY option enabled.</span></span> <span data-ttu-id="3125a-128">对于活动连接的性能问题，您可以从客户端的数据访问跟踪（`ActivityID` 字段）中获取活动 ID，然后在扩展事件输出中找到活动 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-128">For performance issues with an active connection, you can get the activity ID from the client's data access trace (`ActivityID` field) and then locate the activity ID in the extended events output.</span></span> <span data-ttu-id="3125a-129">扩展事件中的活动 ID 为追加了 4 字节序列号的 16 字节的 GUID（与客户端连接 ID 的 GUID 不同）。</span><span class="sxs-lookup"><span data-stu-id="3125a-129">The activity ID in extended events is a 16-byte GUID (not the same as the GUID for the client connection ID) appended with a four-byte sequence number.</span></span> <span data-ttu-id="3125a-130">该序列号表示某个请求在线程内的顺序，并指示线程的批处理和 RPC 语句的相对顺序。</span><span class="sxs-lookup"><span data-stu-id="3125a-130">The sequence number represents the order of a request within a thread and indicates the relative ordering of batch and RPC statements for the thread.</span></span> <span data-ttu-id="3125a-131">启用数据访问跟踪以及数据访问跟踪配置字中的第 18 位处于打开状态时，当前可以针对 SQL 批处理语句和 RPC 请求选择发送 `ActivityID`。</span><span class="sxs-lookup"><span data-stu-id="3125a-131">The `ActivityID` is currently optionally sent for SQL batch statements and RPC requests when data access tracing is enabled on and the 18th bit in the data access tracing configuration word is turned ON.</span></span>

<span data-ttu-id="3125a-132">下面的示例使用 Transact-sql 来启动扩展事件会话，该会话将存储在环形缓冲区中并记录从客户端在 RPC 和批处理操作上发送的活动 ID。</span><span class="sxs-lookup"><span data-stu-id="3125a-132">The following is a sample that uses Transact-SQL to start an extended events session that will be stored in a ring buffer and will record the activity ID sent from a client on RPC and batch operations.</span></span>

```sql
create event session MySession on server
add event connectivity_ring_buffer_recorded,
add event sql_statement_starting (action (client_connection_id)),
add event sql_statement_completed (action (client_connection_id)),
add event rpc_starting (action (client_connection_id)),
add event rpc_completed (action (client_connection_id))
add target ring_buffer with (track_causality=on)
```

## <a name="see-also"></a><span data-ttu-id="3125a-133">请参阅</span><span class="sxs-lookup"><span data-stu-id="3125a-133">See also</span></span>

- [<span data-ttu-id="3125a-134">.NET Framework 中的网络跟踪</span><span class="sxs-lookup"><span data-stu-id="3125a-134">Network Tracing in the .NET Framework</span></span>](../../network-programming/network-tracing.md)
- [<span data-ttu-id="3125a-135">跟踪应用程序和在应用程序中插入检测点</span><span class="sxs-lookup"><span data-stu-id="3125a-135">Tracing and Instrumenting Applications</span></span>](../../debug-trace-profile/tracing-and-instrumenting-applications.md)
- [<span data-ttu-id="3125a-136">ADO.NET 概述</span><span class="sxs-lookup"><span data-stu-id="3125a-136">ADO.NET Overview</span></span>](ado-net-overview.md)

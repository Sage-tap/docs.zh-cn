---
title: CA2012：正确使用 ValueTask（代码分析）
description: 了解代码分析规则 CA2012：正确使用 ValueTask
ms.date: 06/18/2020
ms.topic: reference
f1_keywords:
- UseValueTasksCorrectly
- CA2012
helpviewer_keywords:
- UseValueTasksCorrectly
- CA2012
author: stephentoub
ms.author: stoub
ms.openlocfilehash: e6bf3b099ce31e72027b9b749aefcd4a11b1f470
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/30/2021
ms.locfileid: "99754740"
---
# <a name="ca2012-use-valuetasks-correctly"></a><span data-ttu-id="9c79b-103">CA2012:正确使用 ValueTask</span><span class="sxs-lookup"><span data-stu-id="9c79b-103">CA2012: Use ValueTasks correctly</span></span>

| | <span data-ttu-id="9c79b-104">值</span><span class="sxs-lookup"><span data-stu-id="9c79b-104">Value</span></span> |
|-|-|
| <span data-ttu-id="9c79b-105">**规则 ID**</span><span class="sxs-lookup"><span data-stu-id="9c79b-105">**Rule ID**</span></span> |<span data-ttu-id="9c79b-106">CA2012</span><span class="sxs-lookup"><span data-stu-id="9c79b-106">CA2012</span></span>|
| <span data-ttu-id="9c79b-107">**类别**</span><span class="sxs-lookup"><span data-stu-id="9c79b-107">**Category**</span></span> |[<span data-ttu-id="9c79b-108">可靠性</span><span class="sxs-lookup"><span data-stu-id="9c79b-108">Reliability</span></span>](reliability-warnings.md)|
| <span data-ttu-id="9c79b-109">修复是中断修复还是非中断修复</span><span class="sxs-lookup"><span data-stu-id="9c79b-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="9c79b-110">非中断</span><span class="sxs-lookup"><span data-stu-id="9c79b-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="9c79b-111">原因</span><span class="sxs-lookup"><span data-stu-id="9c79b-111">Cause</span></span>

<span data-ttu-id="9c79b-112">从成员调用中返回的 <xref:System.Threading.Tasks.ValueTask> 实例的使用方式可能导致异常、损坏或性能不佳。</span><span class="sxs-lookup"><span data-stu-id="9c79b-112">A <xref:System.Threading.Tasks.ValueTask> instance returned from a member invocation is used in a way that could lead to exceptions, corruption, or poor performance.</span></span>

## <a name="rule-description"></a><span data-ttu-id="9c79b-113">规则说明</span><span class="sxs-lookup"><span data-stu-id="9c79b-113">Rule description</span></span>

<span data-ttu-id="9c79b-114">从成员调用中返回的 <xref:System.Threading.Tasks.ValueTask> 实例旨在直接等待。</span><span class="sxs-lookup"><span data-stu-id="9c79b-114"><xref:System.Threading.Tasks.ValueTask> instances returned from member invocations are intended to be directly awaited.</span></span>  <span data-ttu-id="9c79b-115">多次尝试使用 ValueTask 或在已知完成之前直接访问其结果可能会导致异常或损坏。</span><span class="sxs-lookup"><span data-stu-id="9c79b-115">Attempts to consume a ValueTask multiple times or to directly access one's result before it's known to be completed may result in an exception or corruption.</span></span>  <span data-ttu-id="9c79b-116">忽略此类 ValueTask 可能指示出现功能 Bug，还可能降低性能。</span><span class="sxs-lookup"><span data-stu-id="9c79b-116">Ignoring such a ValueTask is likely an indication of a functional bug and may degrade performance.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="9c79b-117">如何解决冲突</span><span class="sxs-lookup"><span data-stu-id="9c79b-117">How to fix violations</span></span>

<span data-ttu-id="9c79b-118">通常情况下，应直接等待 ValueTask，而不是将其丢弃或存储到其他位置（如局部变量或字段）。</span><span class="sxs-lookup"><span data-stu-id="9c79b-118">In general, ValueTasks should be directly awaited rather than discarded or stored into other locations like local variables or fields.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="9c79b-119">何时禁止显示警告</span><span class="sxs-lookup"><span data-stu-id="9c79b-119">When to suppress warnings</span></span>

<span data-ttu-id="9c79b-120">对于从任意成员调用返回的 ValueTask，调用方需要假设 ValueTask 必须使用一次（例如等待）并且仅使用一次。</span><span class="sxs-lookup"><span data-stu-id="9c79b-120">For ValueTasks returned from arbitrary member calls, the caller needs to assume that the ValueTask must be consumed (e.g. awaited) once and only once.</span></span>  <span data-ttu-id="9c79b-121">但是，如果开发人员还控制被调用的成员并对其实现情况有全面了解，则开发人员可能知道可禁止显示警告，例如，如果返回 ValueTask 始终包装 <xref:System.Threading.Tasks.Task> 对象。</span><span class="sxs-lookup"><span data-stu-id="9c79b-121">However, if the developer also controls the member being invoked and has complete knowledge of its implementation, the developer may know it's safe to suppress the warning, for example, if the return ValueTask always wraps a <xref:System.Threading.Tasks.Task> object.</span></span>

## <a name="see-also"></a><span data-ttu-id="9c79b-122">另请参阅</span><span class="sxs-lookup"><span data-stu-id="9c79b-122">See also</span></span>

- [<span data-ttu-id="9c79b-123">可靠性规则</span><span class="sxs-lookup"><span data-stu-id="9c79b-123">Reliability rules</span></span>](reliability-warnings.md)

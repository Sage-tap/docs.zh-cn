---
description: 了解详细信息：在工作流中建模取消行为
title: 为工作流中的取消行为进行建模
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: 971e044336eb0aed41e773e03f6e0fb70d959094
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99792643"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="e3586-103">为工作流中的取消行为进行建模</span><span class="sxs-lookup"><span data-stu-id="e3586-103">Modeling Cancellation Behavior in Workflows</span></span>

<span data-ttu-id="e3586-104">可以在工作流内部通过一个 <xref:System.Activities.Statements.Parallel> 活动（此活动在其 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 的计算结果为 `true` 时将取消不完整的分支）取消活动，也可以从工作流外部取消活动（如果主机调用 <xref:System.Activities.WorkflowApplication.Cancel%2A>）。</span><span class="sxs-lookup"><span data-stu-id="e3586-104">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="e3586-105">若要提供取消处理，工作流作者可以使用 <xref:System.Activities.Statements.CancellationScope> 活动和 <xref:System.Activities.Statements.CompensableActivity> 活动，也可以创建提供取消逻辑的自定义活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-105">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="e3586-106">本主题概述了工作流中的取消。</span><span class="sxs-lookup"><span data-stu-id="e3586-106">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="e3586-107">取消、补偿和事务</span><span class="sxs-lookup"><span data-stu-id="e3586-107">Cancellation, Compensation, and Transactions</span></span>  

 <span data-ttu-id="e3586-108">利用事务，应用程序可以在事务进程的任何部分中出现错误时中止（回滚）事务内执行的所有更改。</span><span class="sxs-lookup"><span data-stu-id="e3586-108">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="e3586-109">但并非所有可能需要取消或撤销的工作都适用于事务，如长时间运行的工作或未涉及事务性资源的工作。</span><span class="sxs-lookup"><span data-stu-id="e3586-109">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="e3586-110">如果工作流中发生后续失败，补偿将提供用于撤销之前完成的非事务性工作的模型。</span><span class="sxs-lookup"><span data-stu-id="e3586-110">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="e3586-111">取消将为工作流作者和活动作者提供用于处理未完成的非事务性工作的模型。</span><span class="sxs-lookup"><span data-stu-id="e3586-111">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="e3586-112">如果某个活动的执行过程尚未完成就被取消，则将调用此活动的取消逻辑（如果可用）。</span><span class="sxs-lookup"><span data-stu-id="e3586-112">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e3586-113">有关事务和补偿的详细信息，请参阅 [事务](workflow-transactions.md) 和 [补偿](compensation.md)。</span><span class="sxs-lookup"><span data-stu-id="e3586-113">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="e3586-114">使用 CancellationScope</span><span class="sxs-lookup"><span data-stu-id="e3586-114">Using CancellationScope</span></span>  

 <span data-ttu-id="e3586-115"><xref:System.Activities.Statements.CancellationScope> 活动包含两个部分，这两个部分可包含的子活动为 <xref:System.Activities.Statements.CancellationScope.Body%2A> 和 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>。</span><span class="sxs-lookup"><span data-stu-id="e3586-115">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="e3586-116"><xref:System.Activities.Statements.CancellationScope.Body%2A> 用于放置构成活动逻辑的活动，<xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 用于放置提供活动的取消逻辑的活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-116">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="e3586-117">只能在某个活动尚未完成时取消此活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-117">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="e3586-118">对于 <xref:System.Activities.Statements.CancellationScope> 活动，完成是指完成 <xref:System.Activities.Statements.CancellationScope.Body%2A> 中的活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-118">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="e3586-119">如果安排了取消请求且 <xref:System.Activities.Statements.CancellationScope.Body%2A> 中的活动尚未完成，则将 <xref:System.Activities.Statements.CancellationScope> 标记为 <xref:System.Activities.ActivityInstanceState.Canceled>，并执行 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-119">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="e3586-120">从主机取消工作流</span><span class="sxs-lookup"><span data-stu-id="e3586-120">Canceling a Workflow from the Host</span></span>  

 <span data-ttu-id="e3586-121">主机可通过调用正在承载某个工作流的 <xref:System.Activities.WorkflowApplication.Cancel%2A> 实例的 <xref:System.Activities.WorkflowApplication> 方法来取消该工作流。</span><span class="sxs-lookup"><span data-stu-id="e3586-121">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="e3586-122">下面的示例创建一个具有 <xref:System.Activities.Statements.CancellationScope> 的工作流。</span><span class="sxs-lookup"><span data-stu-id="e3586-122">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="e3586-123">调用该工作流后，主机将调用 <xref:System.Activities.WorkflowApplication.Cancel%2A>。</span><span class="sxs-lookup"><span data-stu-id="e3586-123">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="e3586-124">停止工作流的主执行，并调用 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 的 <xref:System.Activities.Statements.CancellationScope>，然后完成工作流，其状态为 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="e3586-124">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="e3586-125">调用该工作流时，会将以下输出显示到控制台。</span><span class="sxs-lookup"><span data-stu-id="e3586-125">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e3586-126">**启动工作流。**</span><span class="sxs-lookup"><span data-stu-id="e3586-126">**Starting the workflow.**</span></span>  
<span data-ttu-id="e3586-127">已 **调用 CancellationHandler。** 
**Workflow B30ebb30-df46-4d90-a211-e31c38d8db3c 已取消。**</span><span class="sxs-lookup"><span data-stu-id="e3586-127">**CancellationHandler invoked.**
**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>
> [!NOTE]
> <span data-ttu-id="e3586-128">在取消 <xref:System.Activities.Statements.CancellationScope> 活动并调用 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 时，工作流作者应负责确定活动在完全取消之前的取消进度，以便提供适当的取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="e3586-129"><xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 不提供有关活动的取消进度的任何信息。</span><span class="sxs-lookup"><span data-stu-id="e3586-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="e3586-130">如果某个未经处理的异常从工作流的根冒出，且 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 处理程序返回 <xref:System.Activities.UnhandledExceptionAction.Cancel>，则也可以从主机取消该工作流。</span><span class="sxs-lookup"><span data-stu-id="e3586-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="e3586-131">在此示例中，工作流将启动并引发 <xref:System.ApplicationException>。</span><span class="sxs-lookup"><span data-stu-id="e3586-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="e3586-132">由于工作流未处理此异常，因此将调用 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 处理程序。</span><span class="sxs-lookup"><span data-stu-id="e3586-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="e3586-133">该处理程序指示运行时取消工作流，并调用当前正在执行的 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 活动的 <xref:System.Activities.Statements.CancellationScope>。</span><span class="sxs-lookup"><span data-stu-id="e3586-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="e3586-134">调用该工作流时，会将以下输出显示到控制台。</span><span class="sxs-lookup"><span data-stu-id="e3586-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e3586-135">**启动工作流。**</span><span class="sxs-lookup"><span data-stu-id="e3586-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="e3586-136">**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** 
 中的 OnUnhandledException **引发了 ApplicationException。** 
已 **调用 CancellationHandler。** 
**Workflow 6Bb2d5d6-f49a-4c6d-a988-478afb86dbe9 已取消。**</span><span class="sxs-lookup"><span data-stu-id="e3586-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9**
**An ApplicationException was thrown.**
**CancellationHandler invoked.**
**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>

### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="e3586-137">从工作流内部取消活动</span><span class="sxs-lookup"><span data-stu-id="e3586-137">Canceling an Activity from Inside a Workflow</span></span>  

 <span data-ttu-id="e3586-138">一个活动也可由其父级取消。</span><span class="sxs-lookup"><span data-stu-id="e3586-138">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="e3586-139">例如，如果 <xref:System.Activities.Statements.Parallel> 活动具有多个正在执行的分支，且其 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 的计算结果为 `true`，则将取消其不完整的分支。</span><span class="sxs-lookup"><span data-stu-id="e3586-139">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="e3586-140">此示例创建一个具有两个分支的 <xref:System.Activities.Statements.Parallel> 活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-140">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="e3586-141">由于该活动的 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 设置为 `true`，因此只要完成其任一分支即完成 <xref:System.Activities.Statements.Parallel>。</span><span class="sxs-lookup"><span data-stu-id="e3586-141">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="e3586-142">在此示例中，完成了分支 2，因此将取消分支 1。</span><span class="sxs-lookup"><span data-stu-id="e3586-142">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="e3586-143">调用该工作流时，会将以下输出显示到控制台。</span><span class="sxs-lookup"><span data-stu-id="e3586-143">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e3586-144">**分支 1 启动。**</span><span class="sxs-lookup"><span data-stu-id="e3586-144">**Branch 1 starting.**</span></span>  
<span data-ttu-id="e3586-145">**分支2完成。** 
**分支1已取消。** 
**Workflow E0685e24-18ef-4a47-acf3-5c638732f3be 已完成。**</span><span class="sxs-lookup"><span data-stu-id="e3586-145">**Branch 2 complete.**
**Branch 1 canceled.**
**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="e3586-146">如果一个异常从活动的根冒出，但在工作流中的较高级别处理该异常，则也可以取消活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-146">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="e3586-147">在此示例中，工作流的主逻辑由一个 <xref:System.Activities.Statements.Sequence> 活动组成。</span><span class="sxs-lookup"><span data-stu-id="e3586-147">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="e3586-148"><xref:System.Activities.Statements.Sequence> 将指定为 <xref:System.Activities.Statements.CancellationScope.Body%2A> 活动所包含的 <xref:System.Activities.Statements.CancellationScope> 活动的 <xref:System.Activities.Statements.TryCatch>。</span><span class="sxs-lookup"><span data-stu-id="e3586-148">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="e3586-149"><xref:System.Activities.Statements.Sequence> 的正文中将引发一个异常，此异常由父 <xref:System.Activities.Statements.TryCatch> 活动处理，并且将取消 <xref:System.Activities.Statements.Sequence>。</span><span class="sxs-lookup"><span data-stu-id="e3586-149">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="e3586-150">调用该工作流时，会将以下输出显示到控制台。</span><span class="sxs-lookup"><span data-stu-id="e3586-150">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="e3586-151">**序列启动。**</span><span class="sxs-lookup"><span data-stu-id="e3586-151">**Sequence starting.**</span></span>  
<span data-ttu-id="e3586-152">**已取消序列。** 
**捕获了异常。** 
**Workflow E3c18939-121e-4c43-af1c-ba1ce977ce55 已完成。**</span><span class="sxs-lookup"><span data-stu-id="e3586-152">**Sequence canceled.**
**Exception caught.**
**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>

### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="e3586-153">从 CancellationHandler 引发异常</span><span class="sxs-lookup"><span data-stu-id="e3586-153">Throwing Exceptions from a CancellationHandler</span></span>  

 <span data-ttu-id="e3586-154">对于工作流而言，从 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 的 <xref:System.Activities.Statements.CancellationScope> 引发的任何异常都是严重异常。</span><span class="sxs-lookup"><span data-stu-id="e3586-154">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="e3586-155">如果存在 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 无法捕获的异常，请使用 <xref:System.Activities.Statements.TryCatch> 中的 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 来捕获并处理这些异常。</span><span class="sxs-lookup"><span data-stu-id="e3586-155">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="e3586-156">使用 CompensableActivity 进行的取消</span><span class="sxs-lookup"><span data-stu-id="e3586-156">Cancellation using CompensableActivity</span></span>  

 <span data-ttu-id="e3586-157">与 <xref:System.Activities.Statements.CancellationScope> 活动一样，<xref:System.Activities.Statements.CompensableActivity> 也具有一个 <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>。</span><span class="sxs-lookup"><span data-stu-id="e3586-157">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="e3586-158">如果取消 <xref:System.Activities.Statements.CompensableActivity>，则将调用其 <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> 中的任何活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-158">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="e3586-159">这对于撤销部分完成的可补偿工作很有用。</span><span class="sxs-lookup"><span data-stu-id="e3586-159">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="e3586-160">有关如何使用 <xref:System.Activities.Statements.CompensableActivity> 进行补偿和取消的信息，请参阅 [补偿](compensation.md)。</span><span class="sxs-lookup"><span data-stu-id="e3586-160">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="e3586-161">使用自定义活动进行的取消</span><span class="sxs-lookup"><span data-stu-id="e3586-161">Cancellation using Custom Activities</span></span>  

 <span data-ttu-id="e3586-162">自定义活动作者可按照多种不同的方式实现其自定义活动中的取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-162">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="e3586-163">派生自 <xref:System.Activities.Activity> 的自定义活动可实现取消逻辑，方法是将一个 <xref:System.Activities.Statements.CancellationScope> 或其他包含取消逻辑的自定义活动置于活动正文中。</span><span class="sxs-lookup"><span data-stu-id="e3586-163">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="e3586-164"><xref:System.Activities.AsyncCodeActivity> 和 <xref:System.Activities.NativeActivity> 派生的活动可重写其各自的 <xref:System.Activities.NativeActivity.Cancel%2A> 方法，并在其中提供取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-164"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="e3586-165"><xref:System.Activities.CodeActivity> 派生的活动不提供任何取消设置，原因是当运行时调用 <xref:System.Activities.CodeActivity.Execute%2A> 方法时，将通过单次执行来执行其所有工作。</span><span class="sxs-lookup"><span data-stu-id="e3586-165"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="e3586-166">如果尚未调用执行方法，且取消了基于 <xref:System.Activities.CodeActivity> 的活动，则该活动将关闭，其状态为 <xref:System.Activities.ActivityInstanceState.Canceled>，并且不调用 <xref:System.Activities.CodeActivity.Execute%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="e3586-166">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="e3586-167">使用 NativeActivity 进行的取消</span><span class="sxs-lookup"><span data-stu-id="e3586-167">Cancellation using NativeActivity</span></span>  

 <span data-ttu-id="e3586-168"><xref:System.Activities.NativeActivity> 派生的活动可重写 <xref:System.Activities.NativeActivity.Cancel%2A> 方法以提供自定义取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-168"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="e3586-169">如果未重写此方法，则将应用默认工作流取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-169">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="e3586-170">默认取消是对 <xref:System.Activities.NativeActivity> 不重写 <xref:System.Activities.NativeActivity.Cancel%2A> 方法或其 <xref:System.Activities.NativeActivity.Cancel%2A> 方法调用基 <xref:System.Activities.NativeActivity> 方法的执行的过程 <xref:System.Activities.NativeActivity.Cancel%2A> 。</span><span class="sxs-lookup"><span data-stu-id="e3586-170">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="e3586-171">当取消某个活动时，运行时将标记此活动以进行取消，并自动处理特定清理。</span><span class="sxs-lookup"><span data-stu-id="e3586-171">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="e3586-172">如果此活动仅具有未处理的书签，则移除这些书签，并将此活动标记为 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="e3586-172">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e3586-173">然后将取消已取消活动的任何未处理的子活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-173">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="e3586-174">尝试安排其他子活动将导致尝试被忽略，且此活动将标记为 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="e3586-174">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e3586-175">如果任何未处理的子活动在完成时处于 <xref:System.Activities.ActivityInstanceState.Canceled> 或 <xref:System.Activities.ActivityInstanceState.Faulted> 状态，则此活动将标记为 <xref:System.Activities.ActivityInstanceState.Canceled>。</span><span class="sxs-lookup"><span data-stu-id="e3586-175">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="e3586-176">请注意，可以忽略取消请求。</span><span class="sxs-lookup"><span data-stu-id="e3586-176">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="e3586-177">如果某个活动不具有任何未处理的书签或正在执行的子活动，并且在添加取消标记后不安排任何其他工作项，则将成功完成此活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-177">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="e3586-178">虽然此默认取消可满足多种方案的需求，但如果需要其他取消逻辑，请使用内置取消活动或自定义活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-178">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="e3586-179">在下面的示例中，将定义基于 <xref:System.Activities.NativeActivity.Cancel%2A> 的自定义 <xref:System.Activities.NativeActivity> 活动的 `ParallelForEach` 重写。</span><span class="sxs-lookup"><span data-stu-id="e3586-179">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="e3586-180">在取消此活动时，该重写将处理此活动的取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-180">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="e3586-181">此示例是 [非泛型 ParallelForEach](./samples/non-generic-parallelforeach.md) 示例的一部分。</span><span class="sxs-lookup"><span data-stu-id="e3586-181">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="e3586-182"><xref:System.Activities.NativeActivity> 派生的活动可通过检查 <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> 属性来确定是否已请求取消，并可通过调用 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> 方法将自身标记为已取消。</span><span class="sxs-lookup"><span data-stu-id="e3586-182"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="e3586-183">调用 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> 不会立刻完成此活动。</span><span class="sxs-lookup"><span data-stu-id="e3586-183">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="e3586-184">通常，运行时将在没有未处理的工作时完成活动，但如果调用 <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>，则最终状态将为 <xref:System.Activities.ActivityInstanceState.Canceled> 而不是 <xref:System.Activities.ActivityInstanceState.Closed>。</span><span class="sxs-lookup"><span data-stu-id="e3586-184">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="e3586-185">使用 AsyncCodeActivity 进行的取消</span><span class="sxs-lookup"><span data-stu-id="e3586-185">Cancellation using AsyncCodeActivity</span></span>  

 <span data-ttu-id="e3586-186">基于 <xref:System.Activities.AsyncCodeActivity> 的活动也可以通过重写 <xref:System.Activities.AsyncCodeActivity.Cancel%2A> 方法来提供自定义取消逻辑。</span><span class="sxs-lookup"><span data-stu-id="e3586-186"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="e3586-187">如果未重写此方法，则在取消活动的情况下不执行任何取消处理。</span><span class="sxs-lookup"><span data-stu-id="e3586-187">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="e3586-188">在下面的示例中，将定义基于 <xref:System.Activities.AsyncCodeActivity.Cancel%2A> 的自定义 <xref:System.Activities.AsyncCodeActivity> 活动的 `ExecutePowerShell` 重写。 </span><span class="sxs-lookup"><span data-stu-id="e3586-188">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="e3586-189">在取消此活动时，它将执行所需的取消行为。</span><span class="sxs-lookup"><span data-stu-id="e3586-189">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="e3586-190"><xref:System.Activities.AsyncCodeActivity> 派生的活动可通过检查 <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> 属性来确定是否已请求取消，并可通过调用 <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> 方法将自身标记为已取消。</span><span class="sxs-lookup"><span data-stu-id="e3586-190"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>

---
description: 了解详细信息：扩展调度
title: 扩展调度程序
ms.date: 03/30/2017
helpviewer_keywords:
- dispatcher extensions [WCF]
ms.assetid: d0ad15ac-fa12-4f27-80e8-7ac2271e5985
ms.openlocfilehash: 22be85c57439a88746e3e87625472d02ab412c1d
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99735278"
---
# <a name="extending-dispatchers"></a><span data-ttu-id="2fc71-103">扩展调度程序</span><span class="sxs-lookup"><span data-stu-id="2fc71-103">Extending Dispatchers</span></span>

<span data-ttu-id="2fc71-104">调度程序负责从基础通道提取出传入的消息，将它们翻译成应用程序代码形式的方法调用，并将结果发送回调用方。</span><span class="sxs-lookup"><span data-stu-id="2fc71-104">Dispatchers are responsible for pulling incoming messages out of the underlying channels, translating them into method invocations in application code, and sending the results back to the caller.</span></span> <span data-ttu-id="2fc71-105">调度程序扩展允许您修改此过程。</span><span class="sxs-lookup"><span data-stu-id="2fc71-105">Dispatcher extensions allow you to modify this processing.</span></span>  <span data-ttu-id="2fc71-106">您可以实现消息或参数检查器，用来检查或修改消息或参数的内容。</span><span class="sxs-lookup"><span data-stu-id="2fc71-106">You can implement message or parameter inspectors that inspect or modify the contents of messages or parameters.</span></span>  <span data-ttu-id="2fc71-107">您也可以更改将消息路由到操作的方式或提供其他功能。</span><span class="sxs-lookup"><span data-stu-id="2fc71-107">You can change the way messages are routed to operations or provide some other functionality.</span></span>

<span data-ttu-id="2fc71-108">本主题介绍如何使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> <xref:System.ServiceModel.Dispatcher.DispatchOperation> WINDOWS COMMUNICATION FOUNDATION (WCF) 服务应用程序中的和类来修改调度程序的默认执行行为，或在从通道层发送或检索消息、参数或返回值之前或之后将其截获或修改。</span><span class="sxs-lookup"><span data-stu-id="2fc71-108">This topic describes how to use the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> and <xref:System.ServiceModel.Dispatcher.DispatchOperation> classes in a Windows Communication Foundation (WCF) service application to modify the default execution behavior of a dispatcher or to intercept or modify messages, parameters, or return values prior to or subsequent to sending or retrieving them from the channel layer.</span></span> <span data-ttu-id="2fc71-109">有关等效的客户端运行时消息处理的详细信息，请参阅 [扩展客户端](extending-clients.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-109">For more information about the equivalent client runtime message processing, see [Extending Clients](extending-clients.md).</span></span> <span data-ttu-id="2fc71-110">若要了解 <xref:System.ServiceModel.IExtensibleObject%601> 类型在不同运行时自定义对象之间访问共享状态时所扮演的角色，请参阅 [可扩展对象](extensible-objects.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-110">To understand the role that <xref:System.ServiceModel.IExtensibleObject%601> types play in accessing shared state between various runtime customization objects, see [Extensible Objects](extensible-objects.md).</span></span>

## <a name="dispatchers"></a><span data-ttu-id="2fc71-111">调度程序</span><span class="sxs-lookup"><span data-stu-id="2fc71-111">Dispatchers</span></span>

<span data-ttu-id="2fc71-112">服务模型层执行开发人员的编程模型与基础消息交换（通常称为通道层）之间的转换。</span><span class="sxs-lookup"><span data-stu-id="2fc71-112">The service model layer performs the conversion between the developer’s programming model and the underlying message exchange, commonly called the channel layer.</span></span> <span data-ttu-id="2fc71-113">在 WCF 中，通道和终结点 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 调度 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> 程序分别 (和，) 是负责接受新通道、接收消息、操作调度和调用以及响应处理的服务组件。</span><span class="sxs-lookup"><span data-stu-id="2fc71-113">In WCF the channel and endpoint dispatchers (<xref:System.ServiceModel.Dispatcher.ChannelDispatcher> and <xref:System.ServiceModel.Dispatcher.EndpointDispatcher>, respectively) are the service components responsible for accepting new channels, receiving messages, operation dispatch and invocation, and response processing.</span></span> <span data-ttu-id="2fc71-114">调度程序对象是接收方对象，但双工服务中的回调协定实现还公开其用于检查、修改或扩展的调度程序对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-114">Dispatcher objects are receiver objects, but callback contract implementations in duplex services also expose their dispatcher objects for inspection, modification, or extension.</span></span>

<span data-ttu-id="2fc71-115">通道调度程序（和伴随 <xref:System.ServiceModel.Channels.IChannelListener>）从基础通道中提取出消息，然后将消息传递到各自的终结点调用程序。</span><span class="sxs-lookup"><span data-stu-id="2fc71-115">The channel dispatcher (and companion <xref:System.ServiceModel.Channels.IChannelListener>) pulls messages out of the underling channel and passes the messages to their respective endpoint dispatchers.</span></span> <span data-ttu-id="2fc71-116">每个终结点调度程序都有一个 <xref:System.ServiceModel.Dispatcher.DispatchRuntime>，用于将消息路由到相应的、负责调用实现操作的方法的 <xref:System.ServiceModel.Dispatcher.DispatchOperation>。</span><span class="sxs-lookup"><span data-stu-id="2fc71-116">Each endpoint dispatcher has a <xref:System.ServiceModel.Dispatcher.DispatchRuntime> that routes messages to the appropriate <xref:System.ServiceModel.Dispatcher.DispatchOperation>, which is responsible for calling the method that implements the operation.</span></span> <span data-ttu-id="2fc71-117">在此过程中，将会调用各种可选的和必选的扩展类。</span><span class="sxs-lookup"><span data-stu-id="2fc71-117">Various optional and required extension classes are invoked along the way.</span></span> <span data-ttu-id="2fc71-118">本主题说明这些部分如何组合在一起，以及如何修改属性和插入自己的代码以扩展基本功能。</span><span class="sxs-lookup"><span data-stu-id="2fc71-118">This topic explains how these pieces fit together, and how you might modify properties and plug your own code in to extend the base functionality.</span></span>

<span data-ttu-id="2fc71-119">通过使用服务、终结点、协定或操作行为对象插入调度程序属性和修改的自定义对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-119">Dispatcher properties and modified customization objects are inserted by using service, endpoint, contract, or operation behavior objects.</span></span> <span data-ttu-id="2fc71-120">本主题不介绍如何使用行为。</span><span class="sxs-lookup"><span data-stu-id="2fc71-120">This topic does not describe how to use behaviors.</span></span> <span data-ttu-id="2fc71-121">有关用于插入调度程序修改的类型的详细信息，请参阅 [使用行为配置和扩展运行时](configuring-and-extending-the-runtime-with-behaviors.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-121">For more information about the types used to insert dispatcher modifications, see [Configuring and Extending the Runtime with Behaviors](configuring-and-extending-the-runtime-with-behaviors.md).</span></span>

<span data-ttu-id="2fc71-122">下图提供了服务中的体系结构项的高级别视图。</span><span class="sxs-lookup"><span data-stu-id="2fc71-122">The following graphic provides a high-level view of the architectural items in a service.</span></span>

<span data-ttu-id="2fc71-123">![调度运行时体系结构](./media/wcfc-dispatchruntimearchc.gif "wcfc_DispatchRuntimeArchc")</span><span class="sxs-lookup"><span data-stu-id="2fc71-123">![The dispatch runtime architecture](./media/wcfc-dispatchruntimearchc.gif "wcfc_DispatchRuntimeArchc")</span></span>

### <a name="channel-dispatchers"></a><span data-ttu-id="2fc71-124">通道调度程序</span><span class="sxs-lookup"><span data-stu-id="2fc71-124">Channel Dispatchers</span></span>

<span data-ttu-id="2fc71-125">创建 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 对象以将特定 URI（称为侦听 URI）处的 <xref:System.ServiceModel.Channels.IChannelListener> 与服务的实例相关联。</span><span class="sxs-lookup"><span data-stu-id="2fc71-125">A <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> object is created to associate an <xref:System.ServiceModel.Channels.IChannelListener> at a particular URI (called a listen URI) with an instance of a service.</span></span> <span data-ttu-id="2fc71-126">每个 <xref:System.ServiceModel.ServiceHost> 对象都可以具有许多 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 对象，其中的每个对象都只与一个侦听器和侦听 URI 相关联。</span><span class="sxs-lookup"><span data-stu-id="2fc71-126">Each <xref:System.ServiceModel.ServiceHost> object can have many <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> objects, each associated with only one listener and listen URI.</span></span> <span data-ttu-id="2fc71-127">当消息到达时，<xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 会查询每个相关的 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> 对象以确定终结点是否可以接受消息，并将该消息传递到可以接受消息的终结点。</span><span class="sxs-lookup"><span data-stu-id="2fc71-127">When a message arrives, the <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> queries each of the associated <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> objects whether the endpoint can accept the message, and passes the message to the one that can.</span></span>

<span data-ttu-id="2fc71-128">控制通道会话的生存期和行为的所有属性都可以在 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 对象上检查或修改。</span><span class="sxs-lookup"><span data-stu-id="2fc71-128">All properties that control the lifetime and behavior of a channel session are available for inspection or modification on the <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> object.</span></span> <span data-ttu-id="2fc71-129">这些属性包括自定义通道初始值设定项、通道侦听器、主机、关联的 <xref:System.ServiceModel.InstanceContext>，等等。</span><span class="sxs-lookup"><span data-stu-id="2fc71-129">These include custom channel initializers, the channel listener, the host, the associated <xref:System.ServiceModel.InstanceContext>, and so on.</span></span>

### <a name="endpoint-dispatchers"></a><span data-ttu-id="2fc71-130">终结点调度程序</span><span class="sxs-lookup"><span data-stu-id="2fc71-130">Endpoint Dispatchers</span></span>

<span data-ttu-id="2fc71-131">当消息的目标地址与 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> 相匹配并且消息操作与 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> 属性相匹配时，<xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> 对象负责处理来自 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> 的消息。</span><span class="sxs-lookup"><span data-stu-id="2fc71-131">The <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> object is responsible for processing messages from a <xref:System.ServiceModel.Dispatcher.ChannelDispatcher> when the destination address of a message matches the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.AddressFilter%2A> and the message action matches the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.ContractFilter%2A> property.</span></span> <span data-ttu-id="2fc71-132">如果两个 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> 对象可以接受一个消息，则 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.FilterPriority%2A> 属性值确定具有较高优先级的终结点。</span><span class="sxs-lookup"><span data-stu-id="2fc71-132">If two <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> objects can accept a message, the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher.FilterPriority%2A> property value determines the higher priority endpoint.</span></span>

<span data-ttu-id="2fc71-133">使用 <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> 以获取两个主服务模型扩展点（<xref:System.ServiceModel.Dispatcher.DispatchRuntime> 和 <xref:System.ServiceModel.Dispatcher.DispatchOperation> 类），可以使用这两个主服务模型扩展点来自定义调度程序的处理。</span><span class="sxs-lookup"><span data-stu-id="2fc71-133">Use the <xref:System.ServiceModel.Dispatcher.EndpointDispatcher> to acquire the two main service model extension points – the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> and <xref:System.ServiceModel.Dispatcher.DispatchOperation> classes – that you can use to customize the processing of the dispatcher.</span></span> <span data-ttu-id="2fc71-134"><xref:System.ServiceModel.Dispatcher.DispatchRuntime> 类允许用户在协定范围内（即，针对协定中的所有消息）截获并扩展调度程序。</span><span class="sxs-lookup"><span data-stu-id="2fc71-134">The <xref:System.ServiceModel.Dispatcher.DispatchRuntime> class allows users to intercept and extend the dispatcher at the contract scope (that is, for all messages in a contract).</span></span> <span data-ttu-id="2fc71-135"><xref:System.ServiceModel.Dispatcher.DispatchOperation> 类允许用户在操作范围内（即，针对操作中的所有消息）截获并扩展调度程序。</span><span class="sxs-lookup"><span data-stu-id="2fc71-135">The <xref:System.ServiceModel.Dispatcher.DispatchOperation> class allows users to intercept and extend the dispatcher at an operation scope (that is, for all messages in an operation).</span></span>

## <a name="scenarios"></a><span data-ttu-id="2fc71-136">方案</span><span class="sxs-lookup"><span data-stu-id="2fc71-136">Scenarios</span></span>

<span data-ttu-id="2fc71-137">可以有很多理由来扩展调度程序：</span><span class="sxs-lookup"><span data-stu-id="2fc71-137">There a number of reasons to extend the dispatcher:</span></span>

- <span data-ttu-id="2fc71-138">自定义消息验证。</span><span class="sxs-lookup"><span data-stu-id="2fc71-138">Custom Message Validation.</span></span> <span data-ttu-id="2fc71-139">用户可以强制消息对某个架构有效。</span><span class="sxs-lookup"><span data-stu-id="2fc71-139">Users can enforce that a message is valid for a certain schema.</span></span> <span data-ttu-id="2fc71-140">这可以通过实现消息拦截器接口来完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-140">This can be done by implementing the message interceptor interfaces.</span></span> <span data-ttu-id="2fc71-141">有关示例，请参阅 [消息检查](../samples/message-inspectors.md)器。</span><span class="sxs-lookup"><span data-stu-id="2fc71-141">For an example, see [Message Inspectors](../samples/message-inspectors.md).</span></span>

- <span data-ttu-id="2fc71-142">自定义消息日志记录。</span><span class="sxs-lookup"><span data-stu-id="2fc71-142">Custom Message Logging.</span></span> <span data-ttu-id="2fc71-143">用户可以检查并记录流过某个终结点的应用程序消息集。</span><span class="sxs-lookup"><span data-stu-id="2fc71-143">Users can inspect and log some set of application messages that flow through an endpoint.</span></span> <span data-ttu-id="2fc71-144">此操作也可以使用消息拦截器接口完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-144">This can also be accomplished with the message interceptor interfaces.</span></span>

- <span data-ttu-id="2fc71-145">自定义消息转换。</span><span class="sxs-lookup"><span data-stu-id="2fc71-145">Custom Message Transformations.</span></span> <span data-ttu-id="2fc71-146">用户可以在运行时对消息应用某些转换（例如，用于版本控制）。</span><span class="sxs-lookup"><span data-stu-id="2fc71-146">Users can apply certain transformations to the message in the runtime (for example, for versioning).</span></span> <span data-ttu-id="2fc71-147">此操作也可以使用消息拦截器接口完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-147">This can be accomplished, again, with the message interceptor interfaces.</span></span>

- <span data-ttu-id="2fc71-148">自定义数据模型。</span><span class="sxs-lookup"><span data-stu-id="2fc71-148">Custom Data Model.</span></span> <span data-ttu-id="2fc71-149">用户可以有一个数据序列化模型，而不是默认情况下在 WCF (中支持的数据序列化模型，即、、 <xref:System.Runtime.Serialization.DataContractSerializer?displayProperty=nameWithType> <xref:System.Xml.Serialization.XmlSerializer?displayProperty=nameWithType> 和原始消息) 。</span><span class="sxs-lookup"><span data-stu-id="2fc71-149">Users can have a data serialization model other than those supported by default in WCF (namely, <xref:System.Runtime.Serialization.DataContractSerializer?displayProperty=nameWithType>, <xref:System.Xml.Serialization.XmlSerializer?displayProperty=nameWithType>, and raw messages).</span></span> <span data-ttu-id="2fc71-150">这可以通过实现消息格式化程序接口来完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-150">This can be done by implement the message formatter interfaces.</span></span> <span data-ttu-id="2fc71-151">有关示例，请参阅 [操作格式化程序和操作选择器](../samples/operation-formatter-and-operation-selector.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-151">For an example, see [Operation Formatter and Operation Selector](../samples/operation-formatter-and-operation-selector.md).</span></span>

- <span data-ttu-id="2fc71-152">自定义参数验证。</span><span class="sxs-lookup"><span data-stu-id="2fc71-152">Custom Parameter Validation.</span></span> <span data-ttu-id="2fc71-153">用户可以强制类型化参数有效（与 XML 相对）。</span><span class="sxs-lookup"><span data-stu-id="2fc71-153">Users can enforce that typed parameters are valid (as opposed to XML).</span></span> <span data-ttu-id="2fc71-154">可以使用参数检查器来完成此操作。</span><span class="sxs-lookup"><span data-stu-id="2fc71-154">This can be done using the parameter inspector interfaces.</span></span>

- <span data-ttu-id="2fc71-155">自定义操作调度。</span><span class="sxs-lookup"><span data-stu-id="2fc71-155">Custom Operation Dispatching.</span></span> <span data-ttu-id="2fc71-156">用户可以对操作之外的内容（例如，对正文元素或自定义消息属性）实现调度。</span><span class="sxs-lookup"><span data-stu-id="2fc71-156">Users can implement dispatching on something other than action – for example, on the body element, or on a custom message property.</span></span> <span data-ttu-id="2fc71-157">这可以使用 <xref:System.ServiceModel.Dispatcher.IDispatchOperationSelector> 接口来完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-157">This can be done using the <xref:System.ServiceModel.Dispatcher.IDispatchOperationSelector> interface.</span></span> <span data-ttu-id="2fc71-158">有关示例，请参阅 [操作格式化程序和操作选择器](../samples/operation-formatter-and-operation-selector.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-158">For an example, see [Operation Formatter and Operation Selector](../samples/operation-formatter-and-operation-selector.md).</span></span>

- <span data-ttu-id="2fc71-159">对象池。</span><span class="sxs-lookup"><span data-stu-id="2fc71-159">Object Pooling.</span></span> <span data-ttu-id="2fc71-160">用户可以将实例放入池中，而不是为每个调用分配一个新的实例。</span><span class="sxs-lookup"><span data-stu-id="2fc71-160">Users can pool instances rather than allocating a new one for every call.</span></span> <span data-ttu-id="2fc71-161">这可以使用实例提供程序接口来实现。</span><span class="sxs-lookup"><span data-stu-id="2fc71-161">This can be implemented using the instance provider interfaces.</span></span> <span data-ttu-id="2fc71-162">有关示例，请参阅 [Pooling](../samples/pooling.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-162">For an example, see [Pooling](../samples/pooling.md).</span></span>

- <span data-ttu-id="2fc71-163">实例租约。</span><span class="sxs-lookup"><span data-stu-id="2fc71-163">Instance Leasing.</span></span> <span data-ttu-id="2fc71-164">用户可以实现实例生存期的租约模式，类似于 .NET Framework 远程处理的租约模式。</span><span class="sxs-lookup"><span data-stu-id="2fc71-164">Users can implement a leasing pattern for instance lifetime, similar to that of .NET Framework Remoting.</span></span> <span data-ttu-id="2fc71-165">这可以使用实例上下文生存期接口来完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-165">This can be done using the instance context lifetime interfaces.</span></span>

- <span data-ttu-id="2fc71-166">自定义错误处理。</span><span class="sxs-lookup"><span data-stu-id="2fc71-166">Custom Error Handling.</span></span> <span data-ttu-id="2fc71-167">用户可以控制如何处理两个本地错误以及如何将错误发送回客户端。</span><span class="sxs-lookup"><span data-stu-id="2fc71-167">Users can control how both local errors are processed and how faults are communicated back to clients.</span></span> <span data-ttu-id="2fc71-168">这可以使用 <xref:System.ServiceModel.Dispatcher.IErrorHandler> 接口来实现。</span><span class="sxs-lookup"><span data-stu-id="2fc71-168">This can be implemented using the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interfaces.</span></span>

- <span data-ttu-id="2fc71-169">自定义授权行为。</span><span class="sxs-lookup"><span data-stu-id="2fc71-169">Custom Authorization Behaviors.</span></span> <span data-ttu-id="2fc71-170">通过扩展“协定”或“操作”的运行时部分并添加基于消息中呈现的标记的安全检查，用户可以实现自定义访问控制。</span><span class="sxs-lookup"><span data-stu-id="2fc71-170">Users can implement custom access control by extending the Contract or Operation run-time pieces and adding security checks based upon the tokens present in the message.</span></span> <span data-ttu-id="2fc71-171">这可以使用消息拦截器接口或参数拦截器接口来完成。</span><span class="sxs-lookup"><span data-stu-id="2fc71-171">This can be accomplished using either the message interceptor or parameter interceptor interfaces.</span></span> <span data-ttu-id="2fc71-172">有关示例，请参阅 [安全扩展性](../samples/security-extensibility.md)。</span><span class="sxs-lookup"><span data-stu-id="2fc71-172">For examples, see [Security Extensibility](../samples/security-extensibility.md).</span></span>

  > [!CAUTION]
  > <span data-ttu-id="2fc71-173">由于更改安全属性有可能危害 WCF 应用程序的安全性，因此强烈建议您在部署之前，请注意和全面测试来执行与安全相关的修改。</span><span class="sxs-lookup"><span data-stu-id="2fc71-173">Because altering security properties has the potential to compromise the security of WCF applications, it is strongly recommended that you undertake security-related modifications with care and test thoroughly prior to deployment.</span></span>

- <span data-ttu-id="2fc71-174">自定义 WCF 运行时验证程序。</span><span class="sxs-lookup"><span data-stu-id="2fc71-174">Custom WCF Runtime Validators.</span></span> <span data-ttu-id="2fc71-175">可以安装用于检查服务、协定和绑定的自定义验证程序，以便对 WCF 应用程序强制实施企业级策略。</span><span class="sxs-lookup"><span data-stu-id="2fc71-175">You can install custom validators that examine services, contracts, and bindings to enforce enterprise-level policies with respect to WCF applications.</span></span> <span data-ttu-id="2fc71-176"> (示例，请参阅 [如何：锁定企业中的终结点](how-to-lock-down-endpoints-in-the-enterprise.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="2fc71-176">(For example, see [How to: Lock Down Endpoints in the Enterprise](how-to-lock-down-endpoints-in-the-enterprise.md).)</span></span>

### <a name="using-the-dispatchruntime-class"></a><span data-ttu-id="2fc71-177">使用 DispatchRuntime 类</span><span class="sxs-lookup"><span data-stu-id="2fc71-177">Using the DispatchRuntime Class</span></span>

<span data-ttu-id="2fc71-178">使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 类可修改服务或单个终结点的默认行为，或将实现自定义修改的对象插入到以下一个或全部两个服务进程中（对于双工客户端则为客户端进程）：</span><span class="sxs-lookup"><span data-stu-id="2fc71-178">Use the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> class either to modify the default behavior of a service or individual endpoint, or to insert objects that implement custom modifications to one or both of the following service processes (or client processes in the case of a duplex client):</span></span>

- <span data-ttu-id="2fc71-179">将传入消息转换为对象并在服务对象上以方法调用形式释放这些对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-179">The transformation of incoming messages into objects and releasing those objects as method invocations on a service object.</span></span>

- <span data-ttu-id="2fc71-180">将响应服务操作调用后收到的对象转换为出站消息。</span><span class="sxs-lookup"><span data-stu-id="2fc71-180">The transformation of objects received from the response to a service operation invocation into outbound messages.</span></span>

<span data-ttu-id="2fc71-181">通过 <xref:System.ServiceModel.Dispatcher.DispatchRuntime>，即使在无法识别消息的情况下，您也可以为特定协定中的所有消息截获和扩展通道或终结点调度程序。</span><span class="sxs-lookup"><span data-stu-id="2fc71-181">The <xref:System.ServiceModel.Dispatcher.DispatchRuntime> enables you to intercept and extend the channel or endpoint dispatcher for all messages across a particular contract, even when a message is not recognized.</span></span> <span data-ttu-id="2fc71-182">当到达的消息与协定中声明的任何消息均不匹配时，就会将该消息调度到由 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.UnhandledDispatchOperation%2A> 属性返回的操作。</span><span class="sxs-lookup"><span data-stu-id="2fc71-182">When a message arrives that does not match any declared in the contract it is dispatched to the operation returned by the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.UnhandledDispatchOperation%2A> property.</span></span> <span data-ttu-id="2fc71-183">若要截获或扩展针对特定操作的所有消息，请参见 <xref:System.ServiceModel.Dispatcher.DispatchOperation> 类。</span><span class="sxs-lookup"><span data-stu-id="2fc71-183">To intercept or extend across all messages for a particular operation, see the <xref:System.ServiceModel.Dispatcher.DispatchOperation> class.</span></span>

<span data-ttu-id="2fc71-184">由 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 类公开的调度程序扩展性主要包括以下四个方面：</span><span class="sxs-lookup"><span data-stu-id="2fc71-184">There are four main areas of dispatcher extensibility exposed by the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> class:</span></span>

1. <span data-ttu-id="2fc71-185">通道组件可使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 的属性和由 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.ChannelDispatcher%2A> 属性返回的关联通道调度程序的属性，来自定义通道调度程序接受和关闭通道的方式。</span><span class="sxs-lookup"><span data-stu-id="2fc71-185">Channel components use the properties of the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> and those of the associated channel dispatcher returned by the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.ChannelDispatcher%2A> property to customize how the channel dispatcher accepts and closes channels.</span></span> <span data-ttu-id="2fc71-186">此类别包括 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher.ChannelInitializers%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InputSessionShutdownHandlers%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="2fc71-186">This category includes the <xref:System.ServiceModel.Dispatcher.ChannelDispatcher.ChannelInitializers%2A> and <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InputSessionShutdownHandlers%2A> properties.</span></span>

2. <span data-ttu-id="2fc71-187">可为处理的每个消息自定义消息组件。</span><span class="sxs-lookup"><span data-stu-id="2fc71-187">Message components are customized for each message processed.</span></span> <span data-ttu-id="2fc71-188">此类别包括 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.MessageInspectors%2A>、<xref:System.ServiceModel.Dispatcher.DispatchRuntime.OperationSelector%2A>、<xref:System.ServiceModel.Dispatcher.DispatchRuntime.Operations%2A> 和 <xref:System.ServiceModel.Dispatcher.ChannelDispatcher.ErrorHandlers%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="2fc71-188">This category includes the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.MessageInspectors%2A>, <xref:System.ServiceModel.Dispatcher.DispatchRuntime.OperationSelector%2A>, <xref:System.ServiceModel.Dispatcher.DispatchRuntime.Operations%2A>, and the <xref:System.ServiceModel.Dispatcher.ChannelDispatcher.ErrorHandlers%2A> properties.</span></span>

3. <span data-ttu-id="2fc71-189">实例组件可自定义服务类型实例的创建、生存期和处理。</span><span class="sxs-lookup"><span data-stu-id="2fc71-189">Instance components customize the creation, lifetime, and disposal of instances of the service type.</span></span> <span data-ttu-id="2fc71-190">有关服务对象生存期的更多信息，请参见 <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="2fc71-190">For more information about service object lifetimes, see the <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A> property.</span></span> <span data-ttu-id="2fc71-191">此类别包括 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextInitializers%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceProvider%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="2fc71-191">This category includes the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceContextInitializers%2A> and the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.InstanceProvider%2A> properties.</span></span>

4. <span data-ttu-id="2fc71-192">与安全相关的组件可使用以下属性：</span><span class="sxs-lookup"><span data-stu-id="2fc71-192">Security-related components can use the following properties:</span></span>

    - <span data-ttu-id="2fc71-193"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.SecurityAuditLogLocation%2A> 可指示写入审核事件的位置。</span><span class="sxs-lookup"><span data-stu-id="2fc71-193"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.SecurityAuditLogLocation%2A> indicates where audit events are written.</span></span>

    - <span data-ttu-id="2fc71-194"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.ImpersonateCallerForAllOperations%2A> 可控制服务是否尝试使用传入消息所提供的凭据进行模拟。</span><span class="sxs-lookup"><span data-stu-id="2fc71-194"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.ImpersonateCallerForAllOperations%2A> controls whether the service attempts to impersonate using the credentials provided by the incoming message.</span></span>

    - <span data-ttu-id="2fc71-195"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.MessageAuthenticationAuditLevel%2A> 可控制是否将成功消息身份验证事件写入由 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.SecurityAuditLogLocation%2A> 指定的事件日志。</span><span class="sxs-lookup"><span data-stu-id="2fc71-195"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.MessageAuthenticationAuditLevel%2A> controls whether successful message authentication events are written to the event log specified by <xref:System.ServiceModel.Dispatcher.DispatchRuntime.SecurityAuditLogLocation%2A>.</span></span>

    - <span data-ttu-id="2fc71-196"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.PrincipalPermissionMode%2A> 可控制如何设置 <xref:System.Threading.Thread.CurrentPrincipal%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="2fc71-196"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.PrincipalPermissionMode%2A> controls how the <xref:System.Threading.Thread.CurrentPrincipal%2A> property is set.</span></span>

    - <span data-ttu-id="2fc71-197"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.ServiceAuthorizationAuditLevel%2A> 可指定如何执行授权事件的审核。</span><span class="sxs-lookup"><span data-stu-id="2fc71-197"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.ServiceAuthorizationAuditLevel%2A> specifies how the auditing of authorization events is performed.</span></span>

    - <span data-ttu-id="2fc71-198"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.SuppressAuditFailure%2A> 可指定是否要取消显示记录过程中出现的非关键异常。</span><span class="sxs-lookup"><span data-stu-id="2fc71-198"><xref:System.ServiceModel.Dispatcher.DispatchRuntime.SuppressAuditFailure%2A> specifies whether to suppress non-critical exceptions that occur during the logging process.</span></span>

<span data-ttu-id="2fc71-199">通常，服务行为（可实现 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 的对象）、协定行为（可实现 <xref:System.ServiceModel.Description.IServiceBehavior> 的对象）或终结点行为（可实现 <xref:System.ServiceModel.Description.IContractBehavior> 的对象）会将自定义扩展对象分配给 <xref:System.ServiceModel.Description.IEndpointBehavior> 属性或将其插入集合。</span><span class="sxs-lookup"><span data-stu-id="2fc71-199">Typically, custom extension objects are assigned to a <xref:System.ServiceModel.Dispatcher.DispatchRuntime> property or inserted into a collection by a service behavior (an object that implements <xref:System.ServiceModel.Description.IServiceBehavior>), a contract behavior (an object that implements <xref:System.ServiceModel.Description.IContractBehavior>), or an endpoint behavior (an object that implements <xref:System.ServiceModel.Description.IEndpointBehavior>).</span></span> <span data-ttu-id="2fc71-200">然后，以编程方式或通过实现自定义 <xref:System.ServiceModel.Configuration.BehaviorExtensionElement> 对象来将安装行为对象添加到相应的行为集合中，这样便能使用应用程序配置文件插入该行为。</span><span class="sxs-lookup"><span data-stu-id="2fc71-200">Then the installing behavior object is added to the appropriate collection of behaviors either programmatically or by implementing a custom <xref:System.ServiceModel.Configuration.BehaviorExtensionElement> object to enable the behavior to be inserted using an application configuration file.</span></span>

<span data-ttu-id="2fc71-201">双工客户端（实现由双工服务指定的回调协定的客户端）也拥有一个可使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 属性访问的 <xref:System.ServiceModel.Dispatcher.ClientRuntime.CallbackDispatchRuntime%2A> 对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-201">Duplex clients (clients that implement a callback contract specified by a duplex service) also have a <xref:System.ServiceModel.Dispatcher.DispatchRuntime> object that can be accessed using the <xref:System.ServiceModel.Dispatcher.ClientRuntime.CallbackDispatchRuntime%2A> property.</span></span>

### <a name="using-the-dispatchoperation-class"></a><span data-ttu-id="2fc71-202">使用 DispatchOperation 类</span><span class="sxs-lookup"><span data-stu-id="2fc71-202">Using the DispatchOperation Class</span></span>

<span data-ttu-id="2fc71-203"><xref:System.ServiceModel.Dispatcher.DispatchOperation> 类是运行时修改位置，并且是仅限定为一个服务操作的自定义扩展的位置。</span><span class="sxs-lookup"><span data-stu-id="2fc71-203">The <xref:System.ServiceModel.Dispatcher.DispatchOperation> class is the location for run-time modifications and the insertion point for custom extensions that are scoped to only one service operation.</span></span> <span data-ttu-id="2fc71-204">（若要修改协定中的所有消息的服务运行时行为，请使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime> 类。）</span><span class="sxs-lookup"><span data-stu-id="2fc71-204">(To modify service run-time behavior for all messages in a contract, use the <xref:System.ServiceModel.Dispatcher.DispatchRuntime> class.)</span></span>

<span data-ttu-id="2fc71-205">使用自定义服务行为对象安装 <xref:System.ServiceModel.Dispatcher.DispatchOperation> 修改。</span><span class="sxs-lookup"><span data-stu-id="2fc71-205">Install <xref:System.ServiceModel.Dispatcher.DispatchOperation> modifications using a custom service behavior object.</span></span>

<span data-ttu-id="2fc71-206">使用 <xref:System.ServiceModel.Dispatcher.DispatchRuntime.Operations%2A> 属性可以查找表示特定服务操作的 <xref:System.ServiceModel.Dispatcher.DispatchOperation> 对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-206">Use the <xref:System.ServiceModel.Dispatcher.DispatchRuntime.Operations%2A> property to locate the <xref:System.ServiceModel.Dispatcher.DispatchOperation> object that represents a particular service operation.</span></span>

<span data-ttu-id="2fc71-207">下面的属性控制操作级别上的运行时执行：</span><span class="sxs-lookup"><span data-stu-id="2fc71-207">The following properties control runtime execution at the operation level:</span></span>

- <span data-ttu-id="2fc71-208"><xref:System.ServiceModel.Dispatcher.DispatchOperation.Action%2A>、<xref:System.ServiceModel.Dispatcher.DispatchOperation.ReplyAction%2A>、<xref:System.ServiceModel.Dispatcher.DispatchOperation.FaultContractInfos%2A>、<xref:System.ServiceModel.Dispatcher.DispatchOperation.IsOneWay%2A>、<xref:System.ServiceModel.Dispatcher.DispatchOperation.IsTerminating%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchOperation.Name%2A> 属性可获取该操作的各个值。</span><span class="sxs-lookup"><span data-stu-id="2fc71-208">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.Action%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.ReplyAction%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.FaultContractInfos%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.IsOneWay%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.IsTerminating%2A>, and <xref:System.ServiceModel.Dispatcher.DispatchOperation.Name%2A> properties obtain the respective values for the operation.</span></span>

- <span data-ttu-id="2fc71-209"><xref:System.ServiceModel.Dispatcher.DispatchOperation.TransactionAutoComplete%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchOperation.TransactionRequired%2A> 指定事务行为。</span><span class="sxs-lookup"><span data-stu-id="2fc71-209">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.TransactionAutoComplete%2A> and <xref:System.ServiceModel.Dispatcher.DispatchOperation.TransactionRequired%2A> specify transaction behavior.</span></span>

- <span data-ttu-id="2fc71-210"><xref:System.ServiceModel.Dispatcher.DispatchOperation.ReleaseInstanceBeforeCall%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchOperation.ReleaseInstanceAfterCall%2A> 属性可以控制用户定义的服务对象的、相对于 <xref:System.ServiceModel.InstanceContext> 的生存期。</span><span class="sxs-lookup"><span data-stu-id="2fc71-210">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.ReleaseInstanceBeforeCall%2A> and <xref:System.ServiceModel.Dispatcher.DispatchOperation.ReleaseInstanceAfterCall%2A> properties control the lifetime of the user-defined service object relative to the <xref:System.ServiceModel.InstanceContext>.</span></span>

- <span data-ttu-id="2fc71-211">使用 <xref:System.ServiceModel.Dispatcher.DispatchOperation.DeserializeRequest%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.SerializeReply%2A> 和 <xref:System.ServiceModel.Dispatcher.DispatchOperation.Formatter%2A> 属性可以显式控制从消息到对象以及从对象到消息的转换。</span><span class="sxs-lookup"><span data-stu-id="2fc71-211">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.DeserializeRequest%2A>, <xref:System.ServiceModel.Dispatcher.DispatchOperation.SerializeReply%2A>, and the <xref:System.ServiceModel.Dispatcher.DispatchOperation.Formatter%2A> properties enable explicit control over the conversion from messages to objects and objects to messages.</span></span>

- <span data-ttu-id="2fc71-212"><xref:System.ServiceModel.Dispatcher.DispatchOperation.Impersonation%2A> 属性指定操作模拟级别。</span><span class="sxs-lookup"><span data-stu-id="2fc71-212">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.Impersonation%2A> property specifies the operation impersonation level.</span></span>

- <span data-ttu-id="2fc71-213"><xref:System.ServiceModel.Dispatcher.DispatchOperation.CallContextInitializers%2A> 属性插入操作的自定义调用上下文扩展。</span><span class="sxs-lookup"><span data-stu-id="2fc71-213">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.CallContextInitializers%2A> property inserts custom call context extensions for the operation.</span></span>

- <span data-ttu-id="2fc71-214"><xref:System.ServiceModel.Dispatcher.DispatchOperation.AutoDisposeParameters%2A> 属性控制销毁参数对象的时间。</span><span class="sxs-lookup"><span data-stu-id="2fc71-214">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.AutoDisposeParameters%2A> property controls when parameter objects are destroyed.</span></span>

- <span data-ttu-id="2fc71-215">使用 <xref:System.ServiceModel.Dispatcher.DispatchOperation.Invoker%2A> 属性可以插入自定义调用程序对象。</span><span class="sxs-lookup"><span data-stu-id="2fc71-215">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.Invoker%2A> property to insert a custom invoker object.</span></span>

- <span data-ttu-id="2fc71-216">使用 <xref:System.ServiceModel.Dispatcher.DispatchOperation.ParameterInspectors%2A> 属性可以插入自定义参数检查器，您可以使用该检查器来检查或修改参数以及返回值。</span><span class="sxs-lookup"><span data-stu-id="2fc71-216">The <xref:System.ServiceModel.Dispatcher.DispatchOperation.ParameterInspectors%2A> property enables you to insert a custom parameter inspector that you can use to inspect or modify parameters and return values.</span></span>

## <a name="see-also"></a><span data-ttu-id="2fc71-217">请参阅</span><span class="sxs-lookup"><span data-stu-id="2fc71-217">See also</span></span>

- <xref:System.ServiceModel.Dispatcher.DispatchRuntime>
- <xref:System.ServiceModel.Dispatcher.DispatchOperation>
- [<span data-ttu-id="2fc71-218">如何：检查和修改服务上的消息</span><span class="sxs-lookup"><span data-stu-id="2fc71-218">How to: Inspect and Modify Messages on the Service</span></span>](how-to-inspect-and-modify-messages-on-the-service.md)
- [<span data-ttu-id="2fc71-219">如何：检查或修改参数</span><span class="sxs-lookup"><span data-stu-id="2fc71-219">How to: Inspect or Modify Parameters</span></span>](how-to-inspect-or-modify-parameters.md)
- [<span data-ttu-id="2fc71-220">如何：在企业中锁定终结点</span><span class="sxs-lookup"><span data-stu-id="2fc71-220">How to: Lock Down Endpoints in the Enterprise</span></span>](how-to-lock-down-endpoints-in-the-enterprise.md)

---
description: 了解有关分布式事务的详细信息
title: 分布式事务
ms.date: 03/30/2017
ms.assetid: 718b257c-bcb2-408e-b004-a7b0adb1c176
ms.openlocfilehash: 611fe4e2139e69e9501a3ea04a6aa62425e06728
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99651114"
---
# <a name="distributed-transactions"></a><span data-ttu-id="a3d91-103">分布式事务</span><span class="sxs-lookup"><span data-stu-id="a3d91-103">Distributed Transactions</span></span>

<span data-ttu-id="a3d91-104">事务是一组相关的任务，作为独立于其他任务的独立单元成功（提交）或失败（中止）。</span><span class="sxs-lookup"><span data-stu-id="a3d91-104">A transaction is a set of related tasks that either succeeds (commit) or fails (abort) as a unit, among other things.</span></span> <span data-ttu-id="a3d91-105">分布式事务是影响多个资源的事务。</span><span class="sxs-lookup"><span data-stu-id="a3d91-105">A *distributed transaction* is a transaction that affects several resources.</span></span> <span data-ttu-id="a3d91-106">要提交分布式事务，所有参与者都必须保证对数据的任何更改是永久的。</span><span class="sxs-lookup"><span data-stu-id="a3d91-106">For a distributed transaction to commit, all participants must guarantee that any change to data will be permanent.</span></span> <span data-ttu-id="a3d91-107">即使发生系统崩溃或其他不可预见的事件，更改也必须是永久的。</span><span class="sxs-lookup"><span data-stu-id="a3d91-107">Changes must persist despite system crashes or other unforeseen events.</span></span> <span data-ttu-id="a3d91-108">即使只有一个参与者无法保证这一点，整个事务也将失败，在事务范围内对数据的任何更改均将回滚。</span><span class="sxs-lookup"><span data-stu-id="a3d91-108">If even a single participant fails to make this guarantee, the entire transaction fails, and any changes to data within the scope of the transaction are rolled back.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="a3d91-109">如果 `DataReader` 在事务处于活动状态时启动，此时若尝试提交或回滚事务，将会引发异常。</span><span class="sxs-lookup"><span data-stu-id="a3d91-109">An exception will be thrown if you attempt to commit or roll back a transaction if a `DataReader` is started while the transaction is active.</span></span>  
  
## <a name="working-with-systemtransactions"></a><span data-ttu-id="a3d91-110">使用 System.Transactions</span><span class="sxs-lookup"><span data-stu-id="a3d91-110">Working with System.Transactions</span></span>  

 <span data-ttu-id="a3d91-111">在 .NET Framework 中，分布式事务通过 <xref:System.Transactions> 命名空间中的 API 进行管理。</span><span class="sxs-lookup"><span data-stu-id="a3d91-111">In the .NET Framework, distributed transactions are managed through the API in the <xref:System.Transactions> namespace.</span></span> <span data-ttu-id="a3d91-112">如果涉及多个永久资源管理器，<xref:System.Transactions> API 会将分布式事务处理委托给事务监视器，例如 Microsoft 分布式事务协调程序 (MS DTC)。</span><span class="sxs-lookup"><span data-stu-id="a3d91-112">The <xref:System.Transactions> API will delegate distributed transaction handling to a transaction monitor such as the Microsoft Distributed Transaction Coordinator (MS DTC) when multiple persistent resource managers are involved.</span></span> <span data-ttu-id="a3d91-113">有关详细信息，请参阅[事务基础知识](../transactions/transaction-fundamentals.md)。</span><span class="sxs-lookup"><span data-stu-id="a3d91-113">For more information, see [Transaction Fundamentals](../transactions/transaction-fundamentals.md).</span></span>  
  
 <span data-ttu-id="a3d91-114">ADO.NET 2.0 引入了对使用 `EnlistTransaction` 方法在分布式事务中进行登记的支持，该方法会登记 <xref:System.Transactions.Transaction> 实例中的连接。</span><span class="sxs-lookup"><span data-stu-id="a3d91-114">ADO.NET 2.0 introduced support for enlisting in a distributed transaction using the `EnlistTransaction` method, which enlists a connection in a <xref:System.Transactions.Transaction> instance.</span></span> <span data-ttu-id="a3d91-115">在以前版本的 ADO.NET 中，分布式事务中的显式登记使用连接的 `EnlistDistributedTransaction` 方法执行，以登记 <xref:System.EnterpriseServices.ITransaction> 实例中的连接，为了向后兼容，也支持该方法。</span><span class="sxs-lookup"><span data-stu-id="a3d91-115">In previous versions of ADO.NET, explicit enlistment in distributed transactions was performed using the `EnlistDistributedTransaction` method of a connection to enlist a connection in a <xref:System.EnterpriseServices.ITransaction> instance, which is supported for backwards compatibility.</span></span> <span data-ttu-id="a3d91-116">有关企业服务事务的详细信息，请参阅[与企业服务和 COM+ 事务的互操作性](../transactions/interoperability-with-enterprise-services-and-com-transactions.md)。</span><span class="sxs-lookup"><span data-stu-id="a3d91-116">For more information on Enterprise Services transactions, see [Interoperability with Enterprise Services and COM+ Transactions](../transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
 <span data-ttu-id="a3d91-117">在针对 SQL Server 数据库将 <xref:System.Transactions> 事务与用于 SQL Server 的 .NET Framework 提供程序结合使用时，将自动创建一个轻型 <xref:System.Transactions.Transaction>。</span><span class="sxs-lookup"><span data-stu-id="a3d91-117">When using a <xref:System.Transactions> transaction with the .NET Framework Provider for SQL Server against a SQL Server database, a lightweight <xref:System.Transactions.Transaction> will automatically be used.</span></span> <span data-ttu-id="a3d91-118">该事务可以根据需要提升为完全分布式事务。</span><span class="sxs-lookup"><span data-stu-id="a3d91-118">The transaction can then be promoted to a full distributed transaction on an as-needed basis.</span></span> <span data-ttu-id="a3d91-119">有关详细信息，请参阅 [System. 事务与 SQL Server 的集成](system-transactions-integration-with-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a3d91-119">For more information, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="a3d91-120">默认情况下，Oracle 数据库可以同时参与的分布式事务的最大数目设置为 10。</span><span class="sxs-lookup"><span data-stu-id="a3d91-120">The maximum number of distributed transactions that an Oracle database can participate in at one time is set to 10 by default.</span></span> <span data-ttu-id="a3d91-121">第 10 个事务之后，连接到 Oracle 数据库时将会引发异常。</span><span class="sxs-lookup"><span data-stu-id="a3d91-121">After the 10th transaction when connected to an Oracle database, an exception is thrown.</span></span> <span data-ttu-id="a3d91-122">Oracle 不支持分布式事务内的 `DDL`。</span><span class="sxs-lookup"><span data-stu-id="a3d91-122">Oracle does not support `DDL` inside of a distributed transaction.</span></span>  
  
## <a name="automatically-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="a3d91-123">自动在分布式事务中登记</span><span class="sxs-lookup"><span data-stu-id="a3d91-123">Automatically Enlisting in a Distributed Transaction</span></span>  

 <span data-ttu-id="a3d91-124">自动登记是将 ADO.NET 连接与 `System.Transactions` 集成的默认（和首选）方法。</span><span class="sxs-lookup"><span data-stu-id="a3d91-124">Automatic enlistment is the default (and preferred) way of integrating ADO.NET connections with `System.Transactions`.</span></span> <span data-ttu-id="a3d91-125">如果连接对象确定事务处于活动状态，用 `System.Transaction` 术语来说是指 `Transaction.Current` 不为 Null，则连接对象会自动在现有分布式事务中登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-125">A connection object will automatically enlist in an existing distributed transaction if it determines that a transaction is active, which, in `System.Transaction` terms, means that `Transaction.Current` is not null.</span></span> <span data-ttu-id="a3d91-126">自动事务登记在连接打开时进行。</span><span class="sxs-lookup"><span data-stu-id="a3d91-126">Automatic transaction enlistment occurs when the connection is opened.</span></span> <span data-ttu-id="a3d91-127">之后，即使在事务范围内执行命令，也不会进行自动事务登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-127">It will not happen after that even if a command is executed inside of a transaction scope.</span></span> <span data-ttu-id="a3d91-128">可以在现有事务中禁用自动登记，方法是将 `Enlist=false` 指定为 <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType> 的连接字符串参数，或将 `OLE DB Services=-7` 指定为 <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType> 的连接字符串参数。</span><span class="sxs-lookup"><span data-stu-id="a3d91-128">You can disable auto-enlistment in existing transactions by specifying `Enlist=false` as a connection string parameter for a <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType>, or `OLE DB Services=-7` as a connection string parameter for an <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="a3d91-129">有关 Oracle 和 ODBC 连接字符串参数的更多信息，请参见 <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> 和 <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="a3d91-129">For more information on Oracle and ODBC connection string parameters, see <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> and <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span>  
  
## <a name="manually-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="a3d91-130">手动在分布式事务中登记</span><span class="sxs-lookup"><span data-stu-id="a3d91-130">Manually Enlisting in a Distributed Transaction</span></span>  

 <span data-ttu-id="a3d91-131">如果禁用了自动登记或者您需要登记在连接打开后启动的事务，则可以使用所用提供程序的 `EnlistTransaction` 对象的 <xref:System.Data.Common.DbConnection> 方法，在现有分布式事务中登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-131">If auto-enlistment is disabled or you need to enlist a transaction that was started after the connection was opened, you can enlist in an existing distributed transaction using the `EnlistTransaction` method of the <xref:System.Data.Common.DbConnection> object for the provider you are working with.</span></span> <span data-ttu-id="a3d91-132">在现有分布式事务中登记可以确保当提交或回滚了事务时，也提交或回滚对数据源所做作的代码修改。</span><span class="sxs-lookup"><span data-stu-id="a3d91-132">Enlisting in an existing distributed transaction ensures that, if the transaction is committed or rolled back, modifications made by the code at the data source will be committed or rolled back as well.</span></span>  
  
 <span data-ttu-id="a3d91-133">在分布式事务中登记尤其适用于为业务对象建立池连接。</span><span class="sxs-lookup"><span data-stu-id="a3d91-133">Enlisting in distributed transactions is particularly applicable when pooling business objects.</span></span> <span data-ttu-id="a3d91-134">如果业务对象使用打开的连接建立池连接，自动事务登记只有在该连接打开时才会进行。</span><span class="sxs-lookup"><span data-stu-id="a3d91-134">If a business object is pooled with an open connection, automatic transaction enlistment only occurs when that connection is opened.</span></span> <span data-ttu-id="a3d91-135">如果使用池中的业务对象执行多个事务，则该对象的打开连接不自动登记在新启动的事务中。</span><span class="sxs-lookup"><span data-stu-id="a3d91-135">If multiple transactions are performed using the pooled business object, the open connection for that object will not automatically enlist in newly initiated transactions.</span></span> <span data-ttu-id="a3d91-136">在这种情况下，可以对该连接禁用自动事务登记，并使用 `EnlistTransaction` 在事务中登记连接。</span><span class="sxs-lookup"><span data-stu-id="a3d91-136">In this case, you can disable automatic transaction enlistment for the connection and enlist the connection in transactions using `EnlistTransaction`.</span></span>  
  
 <span data-ttu-id="a3d91-137">`EnlistTransaction` 使用类型为 <xref:System.Transactions.Transaction> 的单一参数，该参数引用现有的事务。</span><span class="sxs-lookup"><span data-stu-id="a3d91-137">`EnlistTransaction` takes a single argument of type <xref:System.Transactions.Transaction> that is a reference to the existing transaction.</span></span> <span data-ttu-id="a3d91-138">在调用连接的 `EnlistTransaction` 方法之后，所有使用该连接在数据源上进行的修改均将加入事务中。</span><span class="sxs-lookup"><span data-stu-id="a3d91-138">After calling the connection's `EnlistTransaction` method, all modifications made at the data source using the connection are included in the transaction.</span></span> <span data-ttu-id="a3d91-139">传递空值将取消该连接在当前分布式事务登记中的登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-139">Passing a null value unenlists the connection from its current distributed transaction enlistment.</span></span> <span data-ttu-id="a3d91-140">注意，在调用 `EnlistTransaction` 之前连接必须打开。</span><span class="sxs-lookup"><span data-stu-id="a3d91-140">Note that the connection must be opened before calling `EnlistTransaction`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="a3d91-141">在某个事务中显式登记了连接之后，在该事务完成之前，连接将无法取消登记或在另一个事务中登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-141">Once a connection is explicitly enlisted on a transaction, it cannot be un-enlisted or enlisted in another transaction until the first transaction finishes.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="a3d91-142">如果连接已使用连接的 `EnlistTransaction` 方法开始了某个事务，<xref:System.Data.Common.DbConnection.BeginTransaction%2A> 将引发异常。</span><span class="sxs-lookup"><span data-stu-id="a3d91-142">`EnlistTransaction` throws an exception if the connection has already begun a transaction using the connection's <xref:System.Data.Common.DbConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="a3d91-143">但是，如果事务是在数据源上开始的本地事务（例如使用 <xref:System.Data.SqlClient.SqlCommand> 显式执行 BEGIN TRANSACTION 语句），`EnlistTransaction` 将回滚该本地事务并根据请求在现有分布式事务中登记。</span><span class="sxs-lookup"><span data-stu-id="a3d91-143">However, if the transaction is a local transaction started at the data source (for example, executing the BEGIN TRANSACTION statement explicitly using a <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` will roll back the local transaction and enlist in the existing distributed transaction as requested.</span></span> <span data-ttu-id="a3d91-144">你不会接收本地事务已回滚的通知，必须管理任何未使用 <xref:System.Data.Common.DbConnection.BeginTransaction%2A> 开始的本地事务。</span><span class="sxs-lookup"><span data-stu-id="a3d91-144">You will not receive notice that the local transaction was rolled back, and must manage any local transactions not started using <xref:System.Data.Common.DbConnection.BeginTransaction%2A>.</span></span> <span data-ttu-id="a3d91-145">如果您将用于 SQL Server 的 .NET Framework 数据提供程序 (`SqlClient`) 与 SQL Server 结合使用，则尝试登记会引发异常。</span><span class="sxs-lookup"><span data-stu-id="a3d91-145">If you are using the .NET Framework Data Provider for SQL Server (`SqlClient`) with SQL Server, an attempt to enlist will throw an exception.</span></span> <span data-ttu-id="a3d91-146">所有其他情况将无法发现。</span><span class="sxs-lookup"><span data-stu-id="a3d91-146">All other cases will go undetected.</span></span>  
  
## <a name="promotable-transactions-in-sql-server"></a><span data-ttu-id="a3d91-147">SQL Server 中的可提升事务</span><span class="sxs-lookup"><span data-stu-id="a3d91-147">Promotable Transactions in SQL Server</span></span>  

 <span data-ttu-id="a3d91-148">SQL Server 支持可提升的事务，在此类事务中，本地轻型事务可以仅在需要时自动提升为分布式事务。</span><span class="sxs-lookup"><span data-stu-id="a3d91-148">SQL Server supports promotable transactions in which a local lightweight transaction can be automatically promoted to a distributed transaction only if it is required.</span></span> <span data-ttu-id="a3d91-149">可提升的事务不会调用分布式事务增加的系统开销，除非需要增加的系统开销。</span><span class="sxs-lookup"><span data-stu-id="a3d91-149">A promotable transaction does not invoke the added overhead of a distributed transaction unless the added overhead is required.</span></span> <span data-ttu-id="a3d91-150">有关详细信息和代码示例，请参阅 [System. 事务与 SQL Server 的集成](system-transactions-integration-with-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="a3d91-150">For more information and a code sample, see [System.Transactions Integration with SQL Server](system-transactions-integration-with-sql-server.md).</span></span>  
  
## <a name="configuring-distributed-transactions"></a><span data-ttu-id="a3d91-151">配置分布式事务</span><span class="sxs-lookup"><span data-stu-id="a3d91-151">Configuring Distributed Transactions</span></span>  

 <span data-ttu-id="a3d91-152">为了使用分布式事务，您可能需要在网络上启用 MS DTC。</span><span class="sxs-lookup"><span data-stu-id="a3d91-152">You may need to enable the MS DTC over the network in order to use distributed transactions.</span></span> <span data-ttu-id="a3d91-153">如果已启用 Windows 防火墙，则必须允许 MS DTC 服务使用网络或打开 MS DTC 端口。</span><span class="sxs-lookup"><span data-stu-id="a3d91-153">If have the Windows Firewall enabled, you must allow the MS DTC service to use the network or open the MS DTC port.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a3d91-154">另请参阅</span><span class="sxs-lookup"><span data-stu-id="a3d91-154">See also</span></span>

- [<span data-ttu-id="a3d91-155">事务和并发</span><span class="sxs-lookup"><span data-stu-id="a3d91-155">Transactions and Concurrency</span></span>](transactions-and-concurrency.md)
- [<span data-ttu-id="a3d91-156">System.object 与 SQL Server 的集成</span><span class="sxs-lookup"><span data-stu-id="a3d91-156">System.Transactions Integration with SQL Server</span></span>](system-transactions-integration-with-sql-server.md)
- [<span data-ttu-id="a3d91-157">ADO.NET 概述</span><span class="sxs-lookup"><span data-stu-id="a3d91-157">ADO.NET Overview</span></span>](ado-net-overview.md)

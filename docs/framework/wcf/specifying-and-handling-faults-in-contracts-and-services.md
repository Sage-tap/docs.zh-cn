---
description: 了解详细信息：在协定和服务中指定和处理错误
title: 在协定和服务中指定和处理错误
ms.date: 03/30/2017
helpviewer_keywords:
- handling faults [WCF]
ms.assetid: a9696563-d404-4905-942d-1e0834c26dea
ms.openlocfilehash: 32a1c795d2be964ff5da259b70a5695ddedfadb2
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99676386"
---
# <a name="specifying-and-handling-faults-in-contracts-and-services"></a><span data-ttu-id="3204a-103">在协定和服务中指定和处理错误</span><span class="sxs-lookup"><span data-stu-id="3204a-103">Specifying and Handling Faults in Contracts and Services</span></span>

<span data-ttu-id="3204a-104">Windows Communication Foundation (WCF) 应用程序通过将托管异常对象映射到 SOAP 错误对象，将 SOAP 错误对象映射到托管异常对象来处理错误情况。</span><span class="sxs-lookup"><span data-stu-id="3204a-104">Windows Communication Foundation (WCF) applications handle error situations by mapping managed exception objects to SOAP fault objects and SOAP fault objects to managed exception objects.</span></span> <span data-ttu-id="3204a-105">本节中的主题讨论如何设计协定以将错误条件作为自定义 SOAP 错误公开、如何作为服务实现的一部分返回这些错误，以及客户端如何捕捉这些错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-105">The topics in this section discuss how to design contracts to expose error conditions as custom SOAP faults, how to return such faults as part of service implementation, and how clients catch such faults.</span></span>

## <a name="error-handling-overview"></a><span data-ttu-id="3204a-106">错误处理概述</span><span class="sxs-lookup"><span data-stu-id="3204a-106">Error Handling Overview</span></span>

<span data-ttu-id="3204a-107">在所有托管应用程序中，处理错误由 <xref:System.Exception> 对象表示。</span><span class="sxs-lookup"><span data-stu-id="3204a-107">In all managed applications, processing errors are represented by <xref:System.Exception> objects.</span></span> <span data-ttu-id="3204a-108">在基于 SOAP 的应用程序（例如 WCF 应用程序）中，服务方法使用 SOAP 错误消息来传递处理错误信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-108">In SOAP-based applications such as WCF applications, service methods communicate processing error information using SOAP fault messages.</span></span> <span data-ttu-id="3204a-109">SOAP 错误是包括在服务操作元数据中的消息类型，因此会创建一个错误协定，客户端可使用该协定来使操作更加可靠或更具交互性。</span><span class="sxs-lookup"><span data-stu-id="3204a-109">SOAP faults are message types that are included in the metadata for a service operation and therefore create a fault contract that clients can use to make their operation more robust or interactive.</span></span> <span data-ttu-id="3204a-110">此外，因为 SOAP 错误是以 XML 形式表示的客户端，所以它是高度可互操作的类型系统，可供任何 SOAP 平台上的客户端使用，从而提高 WCF 应用程序的范围。</span><span class="sxs-lookup"><span data-stu-id="3204a-110">In addition, because SOAP faults are expressed to clients in XML form, it is a highly interoperable type system that clients on any SOAP platform can use, increasing the reach of your WCF application.</span></span>

<span data-ttu-id="3204a-111">因为 WCF 应用程序以这两种类型的错误系统运行，所以，发送到客户端的任何托管异常信息都必须从异常转换为服务上的 SOAP 错误，发送，并从 SOAP 错误转换为 WCF 客户端中的错误异常。</span><span class="sxs-lookup"><span data-stu-id="3204a-111">Because WCF applications run under both types of error systems, any managed exception information that is sent to the client must be converted from exceptions into SOAP faults on the service, sent, and converted from SOAP faults to fault exceptions in WCF clients.</span></span> <span data-ttu-id="3204a-112">对于双工客户端，客户端协定还可以将 SOAP 错误发送回服务。</span><span class="sxs-lookup"><span data-stu-id="3204a-112">In the case of duplex clients, client contracts can also send SOAP faults back to a service.</span></span> <span data-ttu-id="3204a-113">在任一种情况下，您都可以使用默认的服务异常行为，或者可以显式控制是否（以及如何）将异常映射到错误消息。</span><span class="sxs-lookup"><span data-stu-id="3204a-113">In either case, you can use the default service exception behaviors, or you can explicitly control whether—and how—exceptions are mapped to fault messages.</span></span>

<span data-ttu-id="3204a-114">可以发送两种类型的 SOAP 错误：已 *声明* 并未 *声明*。</span><span class="sxs-lookup"><span data-stu-id="3204a-114">Two types of SOAP faults can be sent: *declared* and *undeclared*.</span></span> <span data-ttu-id="3204a-115">已声明的 SOAP 错误是指其中的某个操作具有 <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType> 属性（用于指定自定义 SOAP 错误类型）的错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-115">Declared SOAP faults are those in which an operation has a <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType> attribute that specifies a custom SOAP fault type.</span></span> <span data-ttu-id="3204a-116">未 *声明* 未在操作的协定中指定 SOAP 错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-116">*Undeclared* SOAP faults are not specified in the contract for an operation.</span></span>

<span data-ttu-id="3204a-117">强烈建议服务操作使用 <xref:System.ServiceModel.FaultContractAttribute> 属性来声明其错误，以正式指定在正常操作过程中客户端应该可以接收的所有 SOAP 错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-117">It is strongly recommended that service operations declare their faults by using the <xref:System.ServiceModel.FaultContractAttribute> attribute to formally specify all SOAP faults that a client can expect to receive in the normal course of an operation.</span></span> <span data-ttu-id="3204a-118">此外，还建议在 SOAP 错误中仅返回客户端必须了解的信息，以将信息泄露的风险降至最低。</span><span class="sxs-lookup"><span data-stu-id="3204a-118">It is also recommended that you return in a SOAP fault only the information that a client must know to minimize information disclosure.</span></span>

<span data-ttu-id="3204a-119">通常，服务（以及双工客户端）使用下列步骤将错误处理成功地集成到其应用程序中：</span><span class="sxs-lookup"><span data-stu-id="3204a-119">Typically, services (and duplex clients) take the following steps to successfully integrate error handling into their applications:</span></span>

- <span data-ttu-id="3204a-120">将异常条件映射到自定义 SOAP 错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-120">Map exception conditions to custom SOAP faults.</span></span>

- <span data-ttu-id="3204a-121">客户端和服务将 SOAP 错误作为异常进行发送和接收。</span><span class="sxs-lookup"><span data-stu-id="3204a-121">Clients and services send and receive SOAP faults as exceptions.</span></span>

<span data-ttu-id="3204a-122">此外，WCF 客户端和服务可以出于调试目的使用未声明的 soap 错误，并且可以扩展默认的错误行为。</span><span class="sxs-lookup"><span data-stu-id="3204a-122">In addition, WCF clients and services can use undeclared soap faults for debugging purposes and can extend the default error behavior.</span></span> <span data-ttu-id="3204a-123">下面的部分讨论这些任务和概念。</span><span class="sxs-lookup"><span data-stu-id="3204a-123">The following sections discuss these tasks and concepts.</span></span>

## <a name="map-exceptions-to-soap-faults"></a><span data-ttu-id="3204a-124">将异常映射到 SOAP 错误</span><span class="sxs-lookup"><span data-stu-id="3204a-124">Map Exceptions to SOAP Faults</span></span>

<span data-ttu-id="3204a-125">创建用于处理错误条件的操作的第一步是：决定在什么条件下应向客户端应用程序通知有关错误的信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-125">The first step in creating an operation that handles error conditions is to decide under what conditions a client application should be informed about errors.</span></span> <span data-ttu-id="3204a-126">某些操作具有特定于其功能的错误条件。</span><span class="sxs-lookup"><span data-stu-id="3204a-126">Some operations have error conditions specific to their functionality.</span></span> <span data-ttu-id="3204a-127">例如，`PurchaseOrder` 操作可能会向不再允许其发起采购订单的用户返回特定信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-127">For example, a `PurchaseOrder` operation might return specific information to customers who are no longer permitted to initiate a purchase order.</span></span> <span data-ttu-id="3204a-128">在其他情况下（如 `Calculator` 服务），一个更宽泛的 `MathFault` SOAP 错误也许可以描述整个服务内的所有错误条件。</span><span class="sxs-lookup"><span data-stu-id="3204a-128">In other cases, such as a `Calculator` service, a more general `MathFault` SOAP fault may be able to describe all error conditions across an entire service.</span></span> <span data-ttu-id="3204a-129">在标识服务客户端的错误条件之后，可以构造一个自定义 SOAP 错误，并可以将操作标记为在出现相应的 SOAP 错误条件时返回该 SOAP 错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-129">Once the error conditions of clients of your service are identified, a custom SOAP fault can be constructed and the operation can be marked as returning that SOAP fault when its corresponding error condition arises.</span></span>

<span data-ttu-id="3204a-130">有关开发服务或客户端的这一步的详细信息，请参阅 [定义和指定错误](defining-and-specifying-faults.md)。</span><span class="sxs-lookup"><span data-stu-id="3204a-130">For more information about this step of developing your service or client, see [Defining and Specifying Faults](defining-and-specifying-faults.md).</span></span>

## <a name="clients-and-services-handle-soap-faults-as-exceptions"></a><span data-ttu-id="3204a-131">客户端和服务将 SOAP 错误作为异常进行处理</span><span class="sxs-lookup"><span data-stu-id="3204a-131">Clients and Services Handle SOAP Faults as Exceptions</span></span>

<span data-ttu-id="3204a-132">WCF 应用程序中成功的错误处理的第一步是确定操作错误条件，定义自定义 SOAP 错误，并将这些操作标记为返回这些错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-132">Identifying operation error conditions, defining custom SOAP faults, and marking those operations as returning those faults are the first steps in successful error handling in WCF applications.</span></span> <span data-ttu-id="3204a-133">下一步是正确实现这些错误的发送和接收。</span><span class="sxs-lookup"><span data-stu-id="3204a-133">The next step is to properly implement the sending and receiving of these faults.</span></span> <span data-ttu-id="3204a-134">通常，服务会发送错误以通知客户端应用程序有关错误条件的情况，但是双工客户端也可以向服务发送 SOAP 错误。</span><span class="sxs-lookup"><span data-stu-id="3204a-134">Typically services send faults to inform client applications about error conditions, but duplex clients can also send SOAP faults to services.</span></span>

<span data-ttu-id="3204a-135">有关详细信息，请参阅 [发送和接收错误](sending-and-receiving-faults.md)。</span><span class="sxs-lookup"><span data-stu-id="3204a-135">For more information, see [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

## <a name="undeclared-soap-faults-and-debugging"></a><span data-ttu-id="3204a-136">未声明的 SOAP 错误和调试</span><span class="sxs-lookup"><span data-stu-id="3204a-136">Undeclared SOAP Faults and Debugging</span></span>

<span data-ttu-id="3204a-137">已声明的 SOAP 错误对于生成可靠的并可互操作的分布式应用程序非常有用。</span><span class="sxs-lookup"><span data-stu-id="3204a-137">Declared SOAP faults are extremely useful for building robust, interoperable, distributed applications.</span></span> <span data-ttu-id="3204a-138">但在某些情况下，服务（或双工客户端）发送未声明的 SOAP 错误（即在相应操作的 Web 服务描述语言 (WSDL) 中未提及的错误）也很有用。</span><span class="sxs-lookup"><span data-stu-id="3204a-138">However, in some cases it is useful for a service (or duplex client) to send an undeclared SOAP fault, one that is not mentioned in the Web Services Description Language (WSDL) for that operation.</span></span> <span data-ttu-id="3204a-139">例如，在开发服务时可能会出现意外情况，此时就可以将相关信息发送回客户端以方便调试。</span><span class="sxs-lookup"><span data-stu-id="3204a-139">For example, when developing a service, unexpected situations can occur in which it is useful for debugging purposes to send information back to the client.</span></span> <span data-ttu-id="3204a-140">此外，还可以将 <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 属性或 <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 属性设置为， `true` 以允许 WCF 客户端获取有关内部服务操作异常的信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-140">In addition, you can set the <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property or the <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property to `true` to permit WCF clients to obtain information about internal service operation exceptions.</span></span> <span data-ttu-id="3204a-141">发送 [和接收错误](sending-and-receiving-faults.md)中描述了发送单个错误和设置调试行为属性。</span><span class="sxs-lookup"><span data-stu-id="3204a-141">Both sending individual faults and setting the debugging behavior properties are described in [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3204a-142">因为托管异常可以公开内部应用程序信息，所以将 <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 或设置 <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 为 `true` 可以允许 WCF 客户端获取有关内部服务操作异常的信息，包括个人身份信息或其他敏感信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-142">Because managed exceptions can expose internal application information, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` can permit WCF clients to obtain information about internal service operation exceptions, including personally identifiable or other sensitive information.</span></span>
>
> <span data-ttu-id="3204a-143">因此，建议将 <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 或 <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 设置为 `true` 仅用作一种临时调试应用程序的方法。</span><span class="sxs-lookup"><span data-stu-id="3204a-143">Therefore, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` is recommended only as a way to temporarily debug a service application.</span></span> <span data-ttu-id="3204a-144">此外，以这种方式返回未处理的托管异常的方法的 WSDL 并不包含类型为 <xref:System.ServiceModel.FaultException%601> 的 <xref:System.ServiceModel.ExceptionDetail> 的协定。</span><span class="sxs-lookup"><span data-stu-id="3204a-144">In addition, the WSDL for a method that returns unhandled managed exceptions in this way does not contain the contract for the <xref:System.ServiceModel.FaultException%601> of type <xref:System.ServiceModel.ExceptionDetail>.</span></span> <span data-ttu-id="3204a-145">客户端必须预见到 (将未知 SOAP 错误作为对象返回给 WCF 客户端 <xref:System.ServiceModel.FaultException?displayProperty=nameWithType>) 才能正确获取调试信息。</span><span class="sxs-lookup"><span data-stu-id="3204a-145">Clients must expect the possibility of an unknown SOAP fault (returned to WCF clients as <xref:System.ServiceModel.FaultException?displayProperty=nameWithType> objects) to obtain the debugging information properly.</span></span>

## <a name="customizing-error-handling-with-ierrorhandler"></a><span data-ttu-id="3204a-146">使用 IErrorHandler 自定义错误处理</span><span class="sxs-lookup"><span data-stu-id="3204a-146">Customizing Error Handling with IErrorHandler</span></span>

<span data-ttu-id="3204a-147">如果对于自定义在发生应用程序级别的异常时发送给客户端的响应消息有特殊要求，或者对于在返回响应消息之后执行某些自定义处理有特殊的要求，请实现 <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> 接口。</span><span class="sxs-lookup"><span data-stu-id="3204a-147">If you have special requirements to either customize the response message to the client when an application-level exception happens or perform some custom processing after the response message is returned, implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> interface.</span></span>

## <a name="fault-serialization-issues"></a><span data-ttu-id="3204a-148">错误的序列化问题</span><span class="sxs-lookup"><span data-stu-id="3204a-148">Fault Serialization Issues</span></span>

<span data-ttu-id="3204a-149">在反序列化错误协定时，WCF 首先尝试将 SOAP 消息中的错误协定名称与错误协定类型相匹配。</span><span class="sxs-lookup"><span data-stu-id="3204a-149">When deserializing a fault contract, WCF first attempts to match the fault contract name in the SOAP message with the fault contract type.</span></span> <span data-ttu-id="3204a-150">如果找不到精确匹配项，它将按字母顺序在可用错误协定列表中搜索兼容类型。</span><span class="sxs-lookup"><span data-stu-id="3204a-150">If it cannot find an exact match it will then search the list of available fault contracts in alphabetical order for a compatible type.</span></span> <span data-ttu-id="3204a-151">如果两个错误协定是兼容类型（例如，一个是另一个的子类），则可能会使用错误类型对错误进行反序列化。</span><span class="sxs-lookup"><span data-stu-id="3204a-151">If two fault contracts are compatible types (one is a subclass of another, for example) the wrong type may be used to de-serialize the fault.</span></span> <span data-ttu-id="3204a-152">仅当错误协定未指定名称、命名空间和操作时，才会发生此状况。</span><span class="sxs-lookup"><span data-stu-id="3204a-152">This only occurs if the fault contract does not specify a name, namespace, and action.</span></span> <span data-ttu-id="3204a-153">若要防止此问题发生，则通过指定名称、命名空间和操作特性来始终完全限定错误协定。</span><span class="sxs-lookup"><span data-stu-id="3204a-153">To prevent this issue from occurring, always fully qualify fault contracts by specifying the name, namespace, and action attributes.</span></span> <span data-ttu-id="3204a-154">此外，如果您定义了许多派生自共享基类的相关错误协定，请确保使用 `[DataMember(IsRequired=true)]` 标记所有新成员。</span><span class="sxs-lookup"><span data-stu-id="3204a-154">Additionally if you have defined a number of related fault contracts derived from a shared base class, make sure to mark any new members with `[DataMember(IsRequired=true)]`.</span></span> <span data-ttu-id="3204a-155">有关此 `IsRequired` 特性的更多信息，请参见 <xref:System.Runtime.Serialization.DataMemberAttribute>。</span><span class="sxs-lookup"><span data-stu-id="3204a-155">For more information on this `IsRequired` attribute see, <xref:System.Runtime.Serialization.DataMemberAttribute>.</span></span> <span data-ttu-id="3204a-156">这将防止基类成为兼容类型，并强制将错误反序列化为正确的派生类型。</span><span class="sxs-lookup"><span data-stu-id="3204a-156">This will prevent a base class from being a compatible type and force the fault to be deserialized into the correct derived type.</span></span>

## <a name="see-also"></a><span data-ttu-id="3204a-157">请参阅</span><span class="sxs-lookup"><span data-stu-id="3204a-157">See also</span></span>

- <xref:System.ServiceModel.FaultException>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.FaultException>
- <xref:System.Xml.Serialization.XmlSerializer>
- <xref:System.ServiceModel.XmlSerializerFormatAttribute>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.CommunicationException>
- <xref:System.ServiceModel.FaultContractAttribute.Action%2A>
- <xref:System.ServiceModel.FaultException.Code%2A>
- <xref:System.ServiceModel.FaultException.Reason%2A>
- <xref:System.ServiceModel.FaultCode.SubCode%2A>
- <xref:System.ServiceModel.OperationContractAttribute.IsOneWay%2A>
- [<span data-ttu-id="3204a-158">定义和指定错误</span><span class="sxs-lookup"><span data-stu-id="3204a-158">Defining and Specifying Faults</span></span>](defining-and-specifying-faults.md)

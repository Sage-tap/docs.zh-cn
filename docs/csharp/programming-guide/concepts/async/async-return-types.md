---
title: 异步返回类型 (C#)
description: 了解在 C# 中异步方法可以具有的返回类型，以及每种类型的代码示例和其他资源。
ms.date: 08/19/2020
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 53eb3bedebb99cd829101eee4c2e190c0fb952bf
ms.sourcegitcommit: 1dbe25ff484a02025d5c34146e517c236f7161fb
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/19/2021
ms.locfileid: "104653447"
---
# <a name="async-return-types-c"></a><span data-ttu-id="c5fc9-103">异步返回类型 (C#)</span><span class="sxs-lookup"><span data-stu-id="c5fc9-103">Async return types (C#)</span></span>

<span data-ttu-id="c5fc9-104">异步方法可以具有以下返回类型：</span><span class="sxs-lookup"><span data-stu-id="c5fc9-104">Async methods can have the following return types:</span></span>

- <span data-ttu-id="c5fc9-105"><xref:System.Threading.Tasks.Task>（对于执行操作但不返回任何值的异步方法）。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-105"><xref:System.Threading.Tasks.Task>, for an async method that performs an operation but returns no value.</span></span>
- <span data-ttu-id="c5fc9-106"><xref:System.Threading.Tasks.Task%601>（对于返回值的异步方法）。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-106"><xref:System.Threading.Tasks.Task%601>, for an async method that returns a value.</span></span>
- <span data-ttu-id="c5fc9-107">`void`（对于事件处理程序）。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-107">`void`, for an event handler.</span></span>
- <span data-ttu-id="c5fc9-108">从 C# 7.0 开始，任何具有可访问的 `GetAwaiter` 方法的类型。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-108">Starting with C# 7.0, any type that has an accessible `GetAwaiter` method.</span></span> <span data-ttu-id="c5fc9-109">`GetAwaiter` 方法返回的对象必须实现 <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> 接口。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-109">The object returned by the `GetAwaiter` method must implement the <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> interface.</span></span>
- <span data-ttu-id="c5fc9-110">从 C# 8.0 开始，<xref:System.Collections.Generic.IAsyncEnumerable%601> 返回异步流的异步方法  。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-110">Starting with C# 8.0, <xref:System.Collections.Generic.IAsyncEnumerable%601>, for an async method that returns an *async stream*.</span></span>

<span data-ttu-id="c5fc9-111">有关异步方法的详细信息，请参阅[使用 Async 和 Await 的异步编程 (C#)](./index.md)。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-111">For more information about async methods, see [Asynchronous programming with async and await (C#)](./index.md).</span></span>

<span data-ttu-id="c5fc9-112">还存在特定于 Windows 工作负载的其他几种类型：</span><span class="sxs-lookup"><span data-stu-id="c5fc9-112">Several other types also exist that are specific to Windows workloads:</span></span>

- <span data-ttu-id="c5fc9-113"><xref:System.Windows.Threading.DispatcherOperation>，适用于仅限于 Windows 的异步操作。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-113"><xref:System.Windows.Threading.DispatcherOperation>, for async operations limited to Windows.</span></span>
- <span data-ttu-id="c5fc9-114"><xref:Windows.Foundation.IAsyncAction>，适用于 UWP 中不返回值的异步操作。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-114"><xref:Windows.Foundation.IAsyncAction>, for async actions in UWP that do not return a value.</span></span>
- <span data-ttu-id="c5fc9-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601>，适用于 UWP 中只报告进程但不返回值的异步操作。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601>, for async actions in UWP that report progress but do not return a value.</span></span>
- <span data-ttu-id="c5fc9-116"><xref:Windows.Foundation.IAsyncOperation%601>，适用于 UWP 中返回值的异步操作。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-116"><xref:Windows.Foundation.IAsyncOperation%601>, for async operations in UWP that return a value.</span></span>
- <span data-ttu-id="c5fc9-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602>，适用于 UWP 中既报告进程又返回值的异步操作。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602>, for async operations in UWP that report progress and return a value.</span></span>

## <a name="task-return-type"></a><span data-ttu-id="c5fc9-118">Task 返回类型</span><span class="sxs-lookup"><span data-stu-id="c5fc9-118">Task return type</span></span>

<span data-ttu-id="c5fc9-119">不包含 `return` 语句的异步方法或包含不返回操作数的 `return` 语句的异步方法通常具有返回类型 <xref:System.Threading.Tasks.Task>。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-119">Async methods that don't contain a `return` statement or that contain a `return` statement that doesn't return an operand usually have a return type of <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="c5fc9-120">如果此类方法同步运行，它们将返回 `void`。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-120">Such methods return `void` if they run synchronously.</span></span> <span data-ttu-id="c5fc9-121">如果在异步方法中使用 <xref:System.Threading.Tasks.Task> 返回类型，调用方法可以使用 `await` 运算符暂停调用方的完成，直至被调用的异步方法结束。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-121">If you use a <xref:System.Threading.Tasks.Task> return type for an async method, a calling method can use an `await` operator to suspend the caller's completion until the called async method has finished.</span></span>

<span data-ttu-id="c5fc9-122">下例中的 `WaitAndApologizeAsync` 方法不包含 `return` 语句，因此该方法会返回 <xref:System.Threading.Tasks.Task> 对象。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-122">In the following example, the `WaitAndApologizeAsync` method doesn't contain a `return` statement, so the method returns a <xref:System.Threading.Tasks.Task> object.</span></span> <span data-ttu-id="c5fc9-123">返回 `Task` 可等待 `WaitAndApologizeAsync`。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-123">Returning a `Task` enables `WaitAndApologizeAsync` to be awaited.</span></span> <span data-ttu-id="c5fc9-124"><xref:System.Threading.Tasks.Task> 类型不包含 `Result` 属性，因为它不具有任何返回值。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-124">The <xref:System.Threading.Tasks.Task> type doesn't include a `Result` property because it has no return value.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2.cs" id="TaskReturn":::

<span data-ttu-id="c5fc9-125">通过使用 await 语句而不是 await 表达式等待 `WaitAndApologizeAsync`，类似于返回 void 的同步方法的调用语句。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-125">`WaitAndApologizeAsync` is awaited by using an await statement instead of an await expression, similar to the calling statement for a synchronous void-returning method.</span></span> <span data-ttu-id="c5fc9-126">Await 运算符的应用程序在这种情况下不生成值。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-126">The application of an await operator in this case doesn't produce a value.</span></span> <span data-ttu-id="c5fc9-127">当 `await` 的右操作数是 <xref:System.Threading.Tasks.Task%601> 时，`await` 表达式生成的结果为 `T`。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-127">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task%601>, the `await` expression produces a result of `T`.</span></span> <span data-ttu-id="c5fc9-128">当 `await` 的右操作数是 <xref:System.Threading.Tasks.Task> 时，`await` 及其操作数是一个语句。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-128">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task>, the `await` and its operand are a statement.</span></span>

<span data-ttu-id="c5fc9-129">可从 await 运算符的应用程序中分离对 `WaitAndApologizeAsync` 的调用，如以下代码所示。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-129">You can separate the call to `WaitAndApologizeAsync` from the application of an await operator, as the following code shows.</span></span> <span data-ttu-id="c5fc9-130">但是，请记住，`Task` 没有 `Result` 属性，并且当 await 运算符应用于 `Task` 时不产生值。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-130">However, remember that a `Task` doesn't have a `Result` property, and that no value is produced when an await operator is applied to a `Task`.</span></span>

<span data-ttu-id="c5fc9-131">以下代码将调用 `WaitAndApologizeAsync` 方法和等待此方法返回的任务分离。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-131">The following code separates calling the `WaitAndApologizeAsync` method from awaiting the task that the method returns.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2a.cs" id="AwaitTask":::

## <a name="tasktresult-return-type"></a><span data-ttu-id="c5fc9-132">Task\<TResult\> 返回类型</span><span class="sxs-lookup"><span data-stu-id="c5fc9-132">Task\<TResult\> return type</span></span>

<span data-ttu-id="c5fc9-133"><xref:System.Threading.Tasks.Task%601> 返回类型用于某种异步方法，此异步方法包含 [return](../../../language-reference/keywords/return.md) 语句，其中操作数是 `TResult`。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-133">The <xref:System.Threading.Tasks.Task%601> return type is used for an async method that contains a [return](../../../language-reference/keywords/return.md) statement in which the operand is `TResult`.</span></span>

<span data-ttu-id="c5fc9-134">在下面的示例中，`GetLeisureHoursAsync` 方法包含返回整数的 `return` 语句。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-134">In the following example, the `GetLeisureHoursAsync` method contains a `return` statement that returns an integer.</span></span> <span data-ttu-id="c5fc9-135">因此，该方法声明必须指定 `Task<int>` 的返回类型。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-135">Therefore, the method declaration must specify a return type of `Task<int>`.</span></span> <span data-ttu-id="c5fc9-136"><xref:System.Threading.Tasks.Task.FromResult%2A> 异步方法是返回 <xref:System.DateTime.DayOfWeek> 的操作的占位符。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-136">The <xref:System.Threading.Tasks.Task.FromResult%2A> async method is a placeholder for an operation that returns a <xref:System.DateTime.DayOfWeek>.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1.cs" id="LeisureHours":::

<span data-ttu-id="c5fc9-137">在 `ShowTodaysInfo` 方法中从 await 表达式内调用 `GetLeisureHoursAsync` 时，await 表达式检索存储在由 `GetLeisureHours` 方法返回的任务中的整数值（`leisureHours` 的值）。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-137">When `GetLeisureHoursAsync` is called from within an await expression in the `ShowTodaysInfo` method, the await expression retrieves the integer value (the value of `leisureHours`) that's stored in the task returned by the `GetLeisureHours` method.</span></span> <span data-ttu-id="c5fc9-138">有关 await 表达式的详细信息，请参阅 [await](../../../language-reference/operators/await.md)。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-138">For more information about await expressions, see [await](../../../language-reference/operators/await.md).</span></span>

<span data-ttu-id="c5fc9-139">通过从应用程序 `await` 中分离对 `GetLeisureHoursAsync` 的调用，可以更好地理解 `await` 如何从 `Task<T>` 检索结果，如以下代码所示。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-139">You can better understand how `await` retrieves the result from a `Task<T>` by separating the call to `GetLeisureHoursAsync` from the application of `await`, as the following code shows.</span></span> <span data-ttu-id="c5fc9-140">对非立即等待的方法 `GetLeisureHoursAsync` 的调用返回 `Task<int>`，正如你从方法声明预料的一样。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-140">A call to method `GetLeisureHoursAsync` that isn't immediately awaited returns a `Task<int>`, as you would expect from the declaration of the method.</span></span> <span data-ttu-id="c5fc9-141">该任务指派给示例中的 `getLeisureHoursTask` 变量。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-141">The task is assigned to the `getLeisureHoursTask` variable in the example.</span></span> <span data-ttu-id="c5fc9-142">因为 `getLeisureHoursTask` 是 <xref:System.Threading.Tasks.Task%601>，所以它包含类型 `TResult` 的 <xref:System.Threading.Tasks.Task%601.Result> 属性。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-142">Because `getLeisureHoursTask` is a <xref:System.Threading.Tasks.Task%601>, it contains a <xref:System.Threading.Tasks.Task%601.Result> property of type `TResult`.</span></span> <span data-ttu-id="c5fc9-143">在这种情况下，`TResult` 表示整数类型。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-143">In this case, `TResult` represents an integer type.</span></span> <span data-ttu-id="c5fc9-144">`await` 应用于 `getLeisureHoursTask`，await 表达式的计算结果为 `getLeisureHoursTask` 的 <xref:System.Threading.Tasks.Task%601.Result%2A> 属性内容。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-144">When `await` is applied to `getLeisureHoursTask`, the await expression evaluates to the contents of the <xref:System.Threading.Tasks.Task%601.Result%2A> property of `getLeisureHoursTask`.</span></span> <span data-ttu-id="c5fc9-145">此值分配给 `ret` 变量。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-145">The value is assigned to the `ret` variable.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c5fc9-146"><xref:System.Threading.Tasks.Task%601.Result%2A> 属性为阻止属性。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-146">The <xref:System.Threading.Tasks.Task%601.Result%2A> property is a blocking property.</span></span> <span data-ttu-id="c5fc9-147">如果你在其任务完成之前尝试访问它，当前处于活动状态的线程将被阻止，直到任务完成且值为可用。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-147">If you try to access it before its task is finished, the thread that's currently active is blocked until the task completes and the value is available.</span></span> <span data-ttu-id="c5fc9-148">在大多数情况下，应通过使用 `await` 访问此值，而不是直接访问属性。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-148">In most cases, you should access the value by using `await` instead of accessing the property directly.</span></span>
>
> <span data-ttu-id="c5fc9-149">上一示例通过检索 <xref:System.Threading.Tasks.Task%601.Result%2A> 属性的值来阻止主线程，从而使 `Main` 方法可在应用程序结束之前将 `message` 输出到控制台。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-149">The previous example retrieved the value of the <xref:System.Threading.Tasks.Task%601.Result%2A> property to block the main thread so that the `Main` method could print the `message` to the console before the application ended.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1a.cs" id="StoreTask":::

## <a name="void-return-type"></a><span data-ttu-id="c5fc9-150">Void 返回类型</span><span class="sxs-lookup"><span data-stu-id="c5fc9-150">Void return type</span></span>

<span data-ttu-id="c5fc9-151">在异步事件处理程序中使用 `void` 返回类型，这需要 `void` 返回类型。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-151">You use the `void` return type in asynchronous event handlers, which require a `void` return type.</span></span> <span data-ttu-id="c5fc9-152">对于事件处理程序以外的不返回值的方法，应返回 <xref:System.Threading.Tasks.Task>，因为无法等待返回 `void` 的异步方法。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-152">For methods other than event handlers that don't return a value, you should return a <xref:System.Threading.Tasks.Task> instead, because an async method that returns `void` can't be awaited.</span></span> <span data-ttu-id="c5fc9-153">此类方法的任何调用方都必须继续完成，而无需等待调用的异步方法完成。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-153">Any caller of such a method must continue to completion without waiting for the called async method to finish.</span></span> <span data-ttu-id="c5fc9-154">调用方必须独立于异步方法生成的任何值或异常。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-154">The caller must be independent of any values or exceptions that the async method generates.</span></span>

<span data-ttu-id="c5fc9-155">返回 void 的异步方法的调用方无法捕获从该方法引发的异常，且此类未经处理的异常可能会导致应用程序故障。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-155">The caller of a void-returning async method can't catch exceptions thrown from the method, and such unhandled exceptions are likely to cause your application to fail.</span></span> <span data-ttu-id="c5fc9-156">如果返回 <xref:System.Threading.Tasks.Task> 或 <xref:System.Threading.Tasks.Task%601> 的方法引发异常，则该异常存储在返回的任务中。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-156">If a method that returns a <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> throws an exception, the exception is stored in the returned task.</span></span> <span data-ttu-id="c5fc9-157">等待任务时，将重新引发异常。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-157">The exception is rethrown when the task is awaited.</span></span> <span data-ttu-id="c5fc9-158">因此，请确保可以产生异常的任何异步方法都具有返回类型 <xref:System.Threading.Tasks.Task> 或 <xref:System.Threading.Tasks.Task%601>，并确保会等待对方法的调用。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-158">Therefore, make sure that any async method that can produce an exception has a return type of <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> and that calls to the method are awaited.</span></span>

<span data-ttu-id="c5fc9-159">有关如何在异步方法中捕获异常的详细信息，请参阅 [try-catch](../../../language-reference/keywords/try-catch.md) 文中的[异步方法中的异常](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods)部分。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-159">For more information about how to catch exceptions in async methods, see the [Exceptions in async methods](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) section of the [try-catch](../../../language-reference/keywords/try-catch.md) article.</span></span>

<span data-ttu-id="c5fc9-160">以下示例演示异步事件处理程序的行为。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-160">The following example shows the behavior of an async event handler.</span></span> <span data-ttu-id="c5fc9-161">在本示例代码中，异步事件处理程序必须在完成时通知主线程。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-161">In the example code, an async event handler must let the main thread know when it finishes.</span></span> <span data-ttu-id="c5fc9-162">然后，主线程可在退出程序之前等待异步事件处理程序完成。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-162">Then the main thread can wait for an async event handler to complete before exiting the program.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns3.cs":::

## <a name="generalized-async-return-types-and-valuetasktresult"></a><span data-ttu-id="c5fc9-163">通用的异步返回类型和 ValueTask\<TResult\></span><span class="sxs-lookup"><span data-stu-id="c5fc9-163">Generalized async return types and ValueTask\<TResult\></span></span>

<span data-ttu-id="c5fc9-164">从 C# 7.0 起，异步方法可以返回具有返回 awaiter 类型实例的可访问 `GetAwaiter` 方法的所有类型。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-164">Starting with C# 7.0, an async method can return any type that has an accessible `GetAwaiter` method that returns an instance of an *awaiter type*.</span></span> <span data-ttu-id="c5fc9-165">此外，`GetAwaiter` 方法返回的类型必须具有 <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType> 特性。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-165">In addition, the type returned from the `GetAwaiter` method must have the <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType> attribute.</span></span> <span data-ttu-id="c5fc9-166">有关详细信息，请参阅[类似任务的返回类型](../../../../../_csharplang/proposals/csharp-7.0/task-types.md)的功能说明。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-166">You can learn more in the feature spec for [Task like return types](../../../../../_csharplang/proposals/csharp-7.0/task-types.md).</span></span>

<span data-ttu-id="c5fc9-167">此功能与 [awaitable 表达式](../../../../../_csharplang/spec/expressions.md#awaitable-expressions)相辅相成，后者描述 `await` 操作数的要求。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-167">This feature is the complement to [awaitable expressions](../../../../../_csharplang/spec/expressions.md#awaitable-expressions), which describes the requirements for the operand of `await`.</span></span> <span data-ttu-id="c5fc9-168">编译器可以使用通用异步返回类型生成返回不同类型的 `async` 方法。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-168">Generalized async return types enable the compiler to generate `async` methods that return different types.</span></span> <span data-ttu-id="c5fc9-169">通用异步返回类型通过 .NET 库实现性能改进。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-169">Generalized async return types enabled performance improvements in the .NET libraries.</span></span> <span data-ttu-id="c5fc9-170"><xref:System.Threading.Tasks.Task> 和 <xref:System.Threading.Tasks.Task%601> 是引用类型，因此，性能关键路径中的内存分配会对性能产生负面影响，尤其当分配出现在紧凑循环中时。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-170">Because <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> are reference types, memory allocation in performance-critical paths, particularly when allocations occur in tight loops, can adversely affect performance.</span></span> <span data-ttu-id="c5fc9-171">支持通用返回类型意味着可返回轻量值类型（而不是引用类型），从而避免额外的内存分配。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-171">Support for generalized return types means that you can return a lightweight value type instead of a reference type to avoid additional memory allocations.</span></span>

<span data-ttu-id="c5fc9-172">.NET 提供 <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> 结构作为返回任务的通用值的轻量实现。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-172">.NET provides the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> structure as a lightweight implementation of a generalized task-returning value.</span></span> <span data-ttu-id="c5fc9-173">要使用 <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> 类型，必须向项目添加 `System.Threading.Tasks.Extensions` NuGet 包。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-173">To use the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> type, you must add the `System.Threading.Tasks.Extensions` NuGet package to your project.</span></span> <span data-ttu-id="c5fc9-174">如下示例使用 <xref:System.Threading.Tasks.ValueTask%601> 结构检索两个骰子的值。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-174">The following example uses the <xref:System.Threading.Tasks.ValueTask%601> structure to retrieve the value of two dice rolls.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-valuetask.cs":::

<span data-ttu-id="c5fc9-175">编写通用异步返回类型是一种高级方案，旨在用于非常特定的环境中。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-175">Writing a generalized async return type is an advanced scenario, and is targeted for use in very specific environments.</span></span> <span data-ttu-id="c5fc9-176">请考虑改用 `Task`、`Task<T>` 和 `ValueTask<T>` 类型，它们覆盖了大多数的异步代码方案。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-176">Consider using the `Task`, `Task<T>` and `ValueTask<T>` types instead, which cover most scenarios for asynchronous code.</span></span>

## <a name="async-streams-with-iasyncenumerablet"></a><span data-ttu-id="c5fc9-177">使用 IAsyncEnumerable\<T\> 的异步流</span><span class="sxs-lookup"><span data-stu-id="c5fc9-177">Async streams with IAsyncEnumerable\<T\></span></span>

<span data-ttu-id="c5fc9-178">从 C# 8.0 开始，异步方法可能返回异步流，由 <xref:System.Collections.Generic.IAsyncEnumerable%601> 表示  。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-178">Starting with C# 8.0, an async method may return an *async stream*, represented by <xref:System.Collections.Generic.IAsyncEnumerable%601>.</span></span> <span data-ttu-id="c5fc9-179">异步流提供了一种方法，来枚举在具有重复异步调用的块中生成元素时从流中读取的项。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-179">An async stream provides a way to enumerate items read from a stream when elements are generated in chunks with repeated asynchronous calls.</span></span> <span data-ttu-id="c5fc9-180">以下示例显示生成异步流的异步方法：</span><span class="sxs-lookup"><span data-stu-id="c5fc9-180">The following example shows an async method that generates an async stream:</span></span>

:::code language="csharp" source="snippets/async-return-types/AsyncStreams.cs" id="GenerateAsyncStream":::

<span data-ttu-id="c5fc9-181">前面的示例异步读取字符串中的行。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-181">The preceding example reads lines from a string asynchronously.</span></span> <span data-ttu-id="c5fc9-182">读取每一行后，代码将枚举字符串中的每个单词。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-182">Once each line is read, the code enumerates each word in the string.</span></span> <span data-ttu-id="c5fc9-183">调用方将使用 `await foreach` 语句枚举每个单词。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-183">Callers would enumerate each word using the `await foreach` statement.</span></span> <span data-ttu-id="c5fc9-184">当需要从源字符串异步读取下一行时，该方法将等待。</span><span class="sxs-lookup"><span data-stu-id="c5fc9-184">The method awaits when it needs to asynchronously read the next line from the source string.</span></span>

## <a name="see-also"></a><span data-ttu-id="c5fc9-185">请参阅</span><span class="sxs-lookup"><span data-stu-id="c5fc9-185">See also</span></span>

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- [<span data-ttu-id="c5fc9-186">在异步任务完成时对其进行处理</span><span class="sxs-lookup"><span data-stu-id="c5fc9-186">Process asynchronous tasks as they complete</span></span>](start-multiple-async-tasks-and-process-them-as-they-complete.md)
- [<span data-ttu-id="c5fc9-187">使用 Async 和 Await 的异步编程 (C#)</span><span class="sxs-lookup"><span data-stu-id="c5fc9-187">Asynchronous programming with async and await (C#)</span></span>](index.md)
- [<span data-ttu-id="c5fc9-188">async</span><span class="sxs-lookup"><span data-stu-id="c5fc9-188">async</span></span>](../../../language-reference/keywords/async.md)
- [<span data-ttu-id="c5fc9-189">await</span><span class="sxs-lookup"><span data-stu-id="c5fc9-189">await</span></span>](../../../language-reference/operators/await.md)

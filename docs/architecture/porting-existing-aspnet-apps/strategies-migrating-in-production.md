---
title: 在生产环境中运行时的迁移策略
description: 不能 tenable 将大型应用从 ASP.NET MVC 迁移到一次 ASP.NET Core。 了解将应用程序迁移到 ASP.NET Core，同时使其在现有用户的工作和生产环境中运行的策略。
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 4910984cb281139493aa5424809ba3eedab776e9
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401057"
---
# <a name="strategies-for-migrating-while-running-in-production"></a><span data-ttu-id="45e90-104">在生产环境中运行时的迁移策略</span><span class="sxs-lookup"><span data-stu-id="45e90-104">Strategies for migrating while running in production</span></span>

<span data-ttu-id="45e90-105">许多团队都有他们计划迁移到 .NET Core 的 .NET Framework 应用程序，但该应用程序非常大，需要很长时间才能完成迁移。</span><span class="sxs-lookup"><span data-stu-id="45e90-105">Many teams have .NET Framework apps they plan to migrate to .NET Core, but the app is so large that the migration requires a significant amount of time to complete.</span></span> <span data-ttu-id="45e90-106">原始应用需要在一段时间完成迁移的情况下进行。</span><span class="sxs-lookup"><span data-stu-id="45e90-106">The original app needs to live on while the migration is done piece by piece.</span></span> <span data-ttu-id="45e90-107">需要有一种方法来使应用程序的新旧版本和新版本协同工作，或者将旧版本迁移为就地迁移，而不需要进行任何分解。</span><span class="sxs-lookup"><span data-stu-id="45e90-107">There needs to be a way for the old and new versions of the app to work together side-by-side, or for the old version to be migrated in-place, at least some of the way, without breaking it.</span></span> <span data-ttu-id="45e90-108">团队可以使用多种不同的策略来支持这些目标。</span><span class="sxs-lookup"><span data-stu-id="45e90-108">Teams can employ many different strategies to support these goals.</span></span>

## <a name="refactor-the-net-framework-solution"></a><span data-ttu-id="45e90-109">重构 .NET Framework 解决方案</span><span class="sxs-lookup"><span data-stu-id="45e90-109">Refactor the .NET Framework solution</span></span>

<span data-ttu-id="45e90-110">如果你打算将 .NET Framework 应用移植到 .NET Core，就是一个不错的开端。</span><span class="sxs-lookup"><span data-stu-id="45e90-110">A good place to start if you plan to port a .NET Framework app to .NET Core is to refactor it to work better with .NET Core.</span></span> <span data-ttu-id="45e90-111">这意味着更新单个类库以面向 .NET Standard，并将尽可能多的逻辑移出 ASP.NET MVC 项目并移入这些类库中。</span><span class="sxs-lookup"><span data-stu-id="45e90-111">This means updating individual class libraries to target .NET Standard and moving as much logic out of your ASP.NET MVC projects and into these class libraries.</span></span> <span data-ttu-id="45e90-112">.NET Standard 库中的任何代码都应当相对于从 .NET Framework 到 .NET Core 进行相对轻松地移动。</span><span class="sxs-lookup"><span data-stu-id="45e90-112">Any code you have in .NET Standard libraries should move relatively easily from .NET Framework to .NET Core.</span></span>

<span data-ttu-id="45e90-113">重构时，请确保遵循良好的重构基础知识。</span><span class="sxs-lookup"><span data-stu-id="45e90-113">When refactoring, make sure you're following good refactoring fundamentals.</span></span> <span data-ttu-id="45e90-114">例如，创建在开始重构之前验证系统功能的测试。</span><span class="sxs-lookup"><span data-stu-id="45e90-114">For example, create tests that verify what the system does before you start refactoring.</span></span> <span data-ttu-id="45e90-115">完成后，请运行这些测试，确认没有更改系统的行为。</span><span class="sxs-lookup"><span data-stu-id="45e90-115">Run these tests when you're done to confirm you didn't change the system's behavior.</span></span> <span data-ttu-id="45e90-116">如果还没有可以依赖的合适的自动测试，则可能需要向系统中添加特性测试。</span><span class="sxs-lookup"><span data-stu-id="45e90-116">You may need to add characterization tests to the system if you don't already have a good suite of automated tests you can rely on.</span></span>

## <a name="extract-front-end-assets-to-a-cdn"></a><span data-ttu-id="45e90-117">将前端资产提取到 CDN</span><span class="sxs-lookup"><span data-stu-id="45e90-117">Extract front-end assets to a CDN</span></span>

<span data-ttu-id="45e90-118">如果 .NET Framework 应用包含大量静态资产（如脚本、CSS 文件或映像），则可以将这些资源迁移到单独的 CDN。</span><span class="sxs-lookup"><span data-stu-id="45e90-118">If your .NET Framework apps include a lot of static assets, like scripts, CSS files, or images, you may be able to migrate these to a separate CDN.</span></span> <span data-ttu-id="45e90-119">然后，更新现有应用程序以引用这些资产的 CDN 链接。</span><span class="sxs-lookup"><span data-stu-id="45e90-119">Then, update the existing app to reference the CDN links for these assets.</span></span> <span data-ttu-id="45e90-120">当你将应用程序移植到 .NET Core 时，这些静态文件将不会成为迁移的一部分，你只需在 ASP.NET Core 应用的 CDN 中继续引用这些静态文件。</span><span class="sxs-lookup"><span data-stu-id="45e90-120">When you port the app to .NET Core, these static files won't be part of the migration, and you'll just continue referencing them from the CDN in the ASP.NET Core app.</span></span>

## <a name="extract-and-migrate-individual-microservices"></a><span data-ttu-id="45e90-121">提取和迁移单个微服务</span><span class="sxs-lookup"><span data-stu-id="45e90-121">Extract and migrate individual microservices</span></span>

<span data-ttu-id="45e90-122">大型 .NET Framework 应用可能已经包含单独的可单独迁移的前端系统。</span><span class="sxs-lookup"><span data-stu-id="45e90-122">Large .NET Framework apps may already be comprised of separate front-end systems that can be migrated individually.</span></span> <span data-ttu-id="45e90-123">或者它们可能是迁移到微服务体系结构的候选项，其中一些现有的 ASP.NET MVC 应用程序将被拉入到新的 ASP.NET Core 微服务实现中。</span><span class="sxs-lookup"><span data-stu-id="45e90-123">Or they may be candidates for migration to a microservices architecture, with some pieces of existing ASP.NET MVC apps being pulled out into new ASP.NET Core microservice implementations.</span></span> <span data-ttu-id="45e90-124">可以在关联的电子书， [.Net 微服务：用于容器化 .Net 应用程序的体系结构](https://aka.ms/microservicesebook)中了解有关微服务的详细信息。</span><span class="sxs-lookup"><span data-stu-id="45e90-124">You can learn more about microservices in the associated ebook, [.NET Microservices: Architecture for Containerized .NET Applications](https://aka.ms/microservicesebook).</span></span>

<span data-ttu-id="45e90-125">例如，现有应用程序可能有一组与用户登录和注册相关的功能。</span><span class="sxs-lookup"><span data-stu-id="45e90-125">For example, the existing app might have a set of features it uses related to user sign-in and registration.</span></span> <span data-ttu-id="45e90-126">这些可能会迁移到单独的微服务，可以使用 ASP.NET Core 生成和部署该，然后将其集成到旧 .NET Framework 应用中。</span><span class="sxs-lookup"><span data-stu-id="45e90-126">These could be migrated to a separate microservice, which could be built and deployed using ASP.NET Core and then integrated into the legacy .NET Framework app.</span></span> <span data-ttu-id="45e90-127">接下来，该应用程序可能有几个专用于跟踪单个用户的购物车的页面。</span><span class="sxs-lookup"><span data-stu-id="45e90-127">Next, the app might have a few pages dedicated to tracking the individual user's shopping cart.</span></span> <span data-ttu-id="45e90-128">这些页面还可以提取到其自己的单独微服务中，并再次集成到现有应用。</span><span class="sxs-lookup"><span data-stu-id="45e90-128">These pages could also be pulled out into their own separate microservice and again integrated into the existing app.</span></span> <span data-ttu-id="45e90-129">通过这种方式，原始 .NET Framework 应用将继续在生产环境中运行，但其功能越来越多，来自现代化 .NET Core 微服务。</span><span class="sxs-lookup"><span data-stu-id="45e90-129">In this way, the original .NET Framework app continues running in production, but with more and more of its features coming from modernized .NET Core microservices.</span></span>

## <a name="deploy-multiple-versions-of-the-app-side-by-side-in-iis"></a><span data-ttu-id="45e90-130">在 IIS 中并行部署应用的多个版本</span><span class="sxs-lookup"><span data-stu-id="45e90-130">Deploy multiple versions of the app side-by-side in IIS</span></span>

<span data-ttu-id="45e90-131">使用主机标头和重定向的组合，可将现有的 ASP.NET MVC 应用配置为与同一 IIS 服务器上的 ASP.NET Core 应用并行运行。</span><span class="sxs-lookup"><span data-stu-id="45e90-131">Using a combination of host headers and redirects, an existing ASP.NET MVC app can be configured to run side by side with an ASP.NET Core app on the same IIS server.</span></span> <span data-ttu-id="45e90-132">由于单个控制器等功能段会移植到 ASP.NET Core，因此它们的路由和 Url 在 IIS 中映射以面向 ASP.NET Core 网站或子应用程序 (IIS 虚拟目录不受 ASP.NET Core 应用) 支持。</span><span class="sxs-lookup"><span data-stu-id="45e90-132">As pieces of functionality, such as individual controllers, are ported to ASP.NET Core, their routes and URLs are mapped within IIS to target the ASP.NET Core web site or sub-application (IIS virtual directories aren't supported with ASP.NET Core apps).</span></span> <span data-ttu-id="45e90-133">可将 ASP.NET Core 应用托管为 IIS 子应用程序（子应用）。</span><span class="sxs-lookup"><span data-stu-id="45e90-133">An ASP.NET Core app can be hosted as an IIS sub-application (sub-app).</span></span> <span data-ttu-id="45e90-134">子应用的路径成为根应用 URL 的一部分。</span><span class="sxs-lookup"><span data-stu-id="45e90-134">The sub-app's path becomes part of the root app's URL.</span></span>

## <a name="apply-the-strangler-pattern"></a><span data-ttu-id="45e90-135">应用 Strangler 模式</span><span class="sxs-lookup"><span data-stu-id="45e90-135">Apply the Strangler pattern</span></span>

<span data-ttu-id="45e90-136">通过增量迁移功能，可以将大型 ASP.NET MVC 应用逐渐替换为新的 ASP.NET Core 应用。</span><span class="sxs-lookup"><span data-stu-id="45e90-136">Large ASP.NET MVC apps can be gradually replaced with a new ASP.NET Core app by incrementally migrating pieces of functionality.</span></span> <span data-ttu-id="45e90-137">此方法的一种方法称为 [strangler 模式](/azure/architecture/patterns/strangler)，该模式名为 for strangler vines，它 strangle 并最终拆下树。</span><span class="sxs-lookup"><span data-stu-id="45e90-137">One approach to this is called the [strangler pattern](/azure/architecture/patterns/strangler), named for strangler vines that strangle and eventually tear down trees.</span></span> <span data-ttu-id="45e90-138">此方法依赖于在现有解决方案顶部实现外观层。</span><span class="sxs-lookup"><span data-stu-id="45e90-138">This approach relies on first implementing a facade layer over top of the existing solution.</span></span> <span data-ttu-id="45e90-139">应使用新的问题方法或现成的解决方案（如 API 网关）构建此外观。</span><span class="sxs-lookup"><span data-stu-id="45e90-139">This facade should be built using the new approach to the problem, or an off-the-shelf solution such as an API gateway.</span></span>

<span data-ttu-id="45e90-140">在外观准备就绪后，可以将部分部分路由到新的 ASP.NET Core 应用。</span><span class="sxs-lookup"><span data-stu-id="45e90-140">Once the facade is in place, you can route part of it to a new ASP.NET Core app.</span></span> <span data-ttu-id="45e90-141">当你将更多的原始 .NET Framework 应用移植到 .NET Core 时，你将继续相应地更新外观层，将更多 façade's 的功能全部功能发送到新系统。</span><span class="sxs-lookup"><span data-stu-id="45e90-141">As you port more of the original .NET Framework app to .NET Core, you continue to update the facade layer accordingly, sending more of the facade's total functionality to the new system.</span></span> <span data-ttu-id="45e90-142">图3-5 显示了一段时间内 strangler 模式的进展情况。</span><span class="sxs-lookup"><span data-stu-id="45e90-142">Figure 3-5 shows the strangler pattern progression over time.</span></span>

## <a name="multi-targeting-approaches"></a><span data-ttu-id="45e90-143">多目标方法</span><span class="sxs-lookup"><span data-stu-id="45e90-143">Multi-targeting approaches</span></span>

<span data-ttu-id="45e90-144">对于面向 .NET Framework 的大型应用程序，可以通过对每个框架使用多目标和单独的代码路径，迁移到 ASP.NET Core 一段时间。</span><span class="sxs-lookup"><span data-stu-id="45e90-144">Large apps that target .NET Framework may be migrated to ASP.NET Core over time by using multi-targeting and separate code paths for each framework.</span></span> <span data-ttu-id="45e90-145">例如，在两个环境中都必须运行的代码可以使用[预 `#if` 处理器](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md)指令进行修改，以实现不同的功能，或在 .NET Framework 与 .net Core 运行时使用不同的依赖项。</span><span class="sxs-lookup"><span data-stu-id="45e90-145">For example, code that must run in both environments could be modified with [preprocessor `#if`](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md) directives to implement different functionality or use different dependencies when run in .NET Framework versus .NET Core.</span></span> <span data-ttu-id="45e90-146">另一种方法是修改项目文件，使其包含不同的文件集，以供基于的框架为目标。</span><span class="sxs-lookup"><span data-stu-id="45e90-146">Another option is to modify project files to include different sets of files based on which framework is being targeted.</span></span> <span data-ttu-id="45e90-147">项目文件可使用不同的组合模式，如 `*.core.cs` ，根据目标框架包含不同的源文件集。</span><span class="sxs-lookup"><span data-stu-id="45e90-147">Project files can use different globbing patterns, such as `*.core.cs`, to include different sets of source files depending on the framework being targeted.</span></span>

<span data-ttu-id="45e90-148">通过这些技术，可在添加新功能的同时，维护单个通用代码，并将应用的) 部分 (为使用 .NET Core。</span><span class="sxs-lookup"><span data-stu-id="45e90-148">These techniques allow a single common codebase to be maintained while new functionality is added and (parts of) the app are ported to use .NET Core.</span></span>

![图3-5](media/Figure3-5.png)

<span data-ttu-id="45e90-150">**图3-5。**</span><span class="sxs-lookup"><span data-stu-id="45e90-150">**Figure 3-5.**</span></span> <span data-ttu-id="45e90-151">一段时间内的 Strangler 模式。</span><span class="sxs-lookup"><span data-stu-id="45e90-151">The Strangler pattern over time.</span></span>

<span data-ttu-id="45e90-152">最终，整个外观层对应于新式的新式实现。</span><span class="sxs-lookup"><span data-stu-id="45e90-152">Eventually, the entire facade layer corresponds to the new, modern implementation.</span></span> <span data-ttu-id="45e90-153">此时，旧系统和人脸层都可以停用。</span><span class="sxs-lookup"><span data-stu-id="45e90-153">At this point, both the legacy system and the face layer can be retired.</span></span>

## <a name="summary"></a><span data-ttu-id="45e90-154">总结</span><span class="sxs-lookup"><span data-stu-id="45e90-154">Summary</span></span>

<span data-ttu-id="45e90-155">通常，大型 ASP.NET MVC 和 Web API 应用将不会移植到 ASP.NET Core 一次，但会随着时间增量迁移。</span><span class="sxs-lookup"><span data-stu-id="45e90-155">Frequently, large ASP.NET MVC and Web API apps won't be ported to ASP.NET Core all at once, but will migrate incrementally over time.</span></span> <span data-ttu-id="45e90-156">本部分提供了执行此增量迁移的几个策略。</span><span class="sxs-lookup"><span data-stu-id="45e90-156">This section offers several strategies for performing this incremental migration.</span></span> <span data-ttu-id="45e90-157">选择最适合你的组织和应用的)  (。</span><span class="sxs-lookup"><span data-stu-id="45e90-157">Choose the one(s) that will work best for your organization and app.</span></span>

## <a name="references"></a><span data-ttu-id="45e90-158">参考</span><span class="sxs-lookup"><span data-stu-id="45e90-158">References</span></span>

- [<span data-ttu-id="45e90-159">.NET 微服务：容器化 .NET 应用程序的体系结构</span><span class="sxs-lookup"><span data-stu-id="45e90-159">.NET Microservices: Architecture for Containerized .NET Applications</span></span>](https://aka.ms/microservicesebook)
- [<span data-ttu-id="45e90-160">eShopOnContainers Reference 微服务应用程序</span><span class="sxs-lookup"><span data-stu-id="45e90-160">eShopOnContainers Reference Microservices Application</span></span>](https://github.com/dotnet-architecture/eShopOnContainers)
- [<span data-ttu-id="45e90-161">使用 IIS 在 Windows 上托管 ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="45e90-161">Host ASP.NET Core on Windows with IIS</span></span>](/aspnet/core/host-and-deploy/iis/)
- [<span data-ttu-id="45e90-162">绞杀者模式</span><span class="sxs-lookup"><span data-stu-id="45e90-162">Strangler pattern</span></span>](/azure/architecture/patterns/strangler)

>[!div class="step-by-step"]
><span data-ttu-id="45e90-163">[上一页](understand-update-dependencies.md)
>[下一页](example-migration-eshop.md)</span><span class="sxs-lookup"><span data-stu-id="45e90-163">[Previous](understand-update-dependencies.md)
[Next](example-migration-eshop.md)</span></span>

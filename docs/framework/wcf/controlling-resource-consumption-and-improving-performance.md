---
description: 了解详细信息：控制资源消耗和提高性能
title: 控制资源使用并提高性能
ms.date: 03/30/2017
ms.assetid: 9a829669-5f76-4c88-80ec-92d0c62c0660
ms.openlocfilehash: df2a2ae8235acecd269644690546098f36bf73c8
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99794450"
---
# <a name="controlling-resource-consumption-and-improving-performance"></a><span data-ttu-id="c08db-103">控制资源使用并提高性能</span><span class="sxs-lookup"><span data-stu-id="c08db-103">Controlling Resource Consumption and Improving Performance</span></span>

<span data-ttu-id="c08db-104">本主题介绍 Windows Communication Foundation (WCF) 体系结构的不同区域中的各种属性，这些属性可用于控制资源消耗并影响性能指标。</span><span class="sxs-lookup"><span data-stu-id="c08db-104">This topic describes various properties in different areas of the Windows Communication Foundation (WCF) architecture that work to control resource consumption and affect performance metrics.</span></span>

## <a name="properties-that-constrain-resource-consumption-in-wcf"></a><span data-ttu-id="c08db-105">WCF 中约束资源使用的属性</span><span class="sxs-lookup"><span data-stu-id="c08db-105">Properties that Constrain Resource Consumption in WCF</span></span>

 <span data-ttu-id="c08db-106">Windows Communication Foundation (WCF) 出于安全或性能目的对某些类型的进程应用约束。</span><span class="sxs-lookup"><span data-stu-id="c08db-106">Windows Communication Foundation (WCF) applies constraints on certain types of processes for either security or performance purposes.</span></span> <span data-ttu-id="c08db-107">这些约束有两种主要形式，即：配额和控制器。</span><span class="sxs-lookup"><span data-stu-id="c08db-107">These constraints come in two main forms, either quotas and throttles.</span></span> <span data-ttu-id="c08db-108">*配额* 是指在达到或超过系统时触发即时异常的限制。</span><span class="sxs-lookup"><span data-stu-id="c08db-108">*Quotas* are limits that when reached or exceeded trigger an immediate exception at some point in the system.</span></span> <span data-ttu-id="c08db-109">*限制是不* 会立即导致引发异常的限制。</span><span class="sxs-lookup"><span data-stu-id="c08db-109">*Throttles* are limits that do not immediately cause an exception to be thrown.</span></span> <span data-ttu-id="c08db-110">达到控制器限制时，处理仍将继续进行，但不会超过该控制器值所设置的限制。</span><span class="sxs-lookup"><span data-stu-id="c08db-110">Instead, when a throttle limit is reached, processing continues but within the limits set by that throttle value.</span></span> <span data-ttu-id="c08db-111">这一受限处理可能会在另外某处引发异常，但这取决于具体的应用程序。</span><span class="sxs-lookup"><span data-stu-id="c08db-111">This limited processing might trigger an exception elsewhere, but this depends upon the application.</span></span>

 <span data-ttu-id="c08db-112">除了配额与控制器之间存在区别之外，序列化级别、传输级别以及应用程序级别中也分别存在一些约束属性。</span><span class="sxs-lookup"><span data-stu-id="c08db-112">In addition to the distinction between quotas and throttles, some constraining properties are located at the serialization level, some at the transport level, and some at the application level.</span></span> <span data-ttu-id="c08db-113">例如，配额 <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType>（由所有系统提供的传输绑定元素实现）默认情况下设置为 65,536 字节，以阻止恶意客户端通过导致过度的内存使用来对服务发起拒绝服务攻击。</span><span class="sxs-lookup"><span data-stu-id="c08db-113">For example, the quota <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType>, which is implemented by all system-supplied transport binding elements, is set to 65,536 bytes by default to hinder malicious clients from engaging in denial-of-service attacks against a service by causing excessive memory consumption.</span></span> <span data-ttu-id="c08db-114">（通常，您可以通过降低这一值来提高性能）。</span><span class="sxs-lookup"><span data-stu-id="c08db-114">(Typically, you can increase performance by lowering this value.)</span></span>

 <span data-ttu-id="c08db-115">序列化配额的一个示例是 <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> 属性，该属性指定序列化程序在一次 <xref:System.Runtime.Serialization.DataContractSerializer.ReadObject%2A> 方法调用中序列化或反序列化的对象的最大数目。</span><span class="sxs-lookup"><span data-stu-id="c08db-115">An example of a serialization quota is the <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property, which specifies the maximum number of objects that the serializer serializes or deserializes in a single <xref:System.Runtime.Serialization.DataContractSerializer.ReadObject%2A> method call.</span></span> <span data-ttu-id="c08db-116">应用程序级控制器的一个示例是 <xref:System.ServiceModel.Dispatcher.ServiceThrottle.MaxConcurrentSessions%2A?displayProperty=nameWithType> 属性，该属性默认情况下将并发会话通道连接的数目限定为不超过 10 个。</span><span class="sxs-lookup"><span data-stu-id="c08db-116">An example of an application-level throttle is the <xref:System.ServiceModel.Dispatcher.ServiceThrottle.MaxConcurrentSessions%2A?displayProperty=nameWithType> property, which by default restricts the number of concurrent sessionful channel connections to 10.</span></span> <span data-ttu-id="c08db-117">（与配额不同，如果达到此控制器值，应用程序会继续处理，但不接受新的会话通道，也就是说，在其中某个会话通道终止之前，新客户端将无法连接。）</span><span class="sxs-lookup"><span data-stu-id="c08db-117">(Unlike the quotas, if this throttle value is reached, the application continues processing but accepts no new sessionful channels, which means that new clients cannot connect until one of the other sessionful channels is ended.)</span></span>

 <span data-ttu-id="c08db-118">这些控制机制旨在针对某些类型的攻击提供现成的缓解，或者改善内存需求量、启动时间等性能指标。</span><span class="sxs-lookup"><span data-stu-id="c08db-118">These controls are designed to provide an out-of-the-box mitigation against certain types of attacks or to improve performance metrics such as memory footprint, start-up time, and so on.</span></span> <span data-ttu-id="c08db-119">但是，根据不同的应用程序，这些控制机制可能会妨碍服务应用程序性能或者使应用程序根本无法工作。</span><span class="sxs-lookup"><span data-stu-id="c08db-119">However, depending on the application, these controls can impede service application performance or prevent the application from working at all.</span></span> <span data-ttu-id="c08db-120">例如，旨在传送视频的应用程序可能很容易超过默认的 <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType> 属性值。</span><span class="sxs-lookup"><span data-stu-id="c08db-120">For example, an application designed to stream video can easily exceed the default <xref:System.ServiceModel.Channels.TransportBindingElement.MaxReceivedMessageSize%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="c08db-121">本主题概述了在所有级别的 WCF 上应用于应用程序的各种控件，并介绍了获取有关某个设置是否阻碍您的应用程序的各种方式的详细信息，并介绍了更正各种问题的方法。</span><span class="sxs-lookup"><span data-stu-id="c08db-121">This topic provides an overview of the various controls applied to applications at all levels of WCF, describes various ways to obtain more information about whether a setting is hindering your application, and describes ways to correct various problems.</span></span> <span data-ttu-id="c08db-122">大多数控制器以及某些配额都是在应用程序级别提供的，即使基属性是序列化约束或传输约束，也是如此。</span><span class="sxs-lookup"><span data-stu-id="c08db-122">Most throttles and some quotas are available at the application level, even when the base property is a serialization or transport constraint.</span></span> <span data-ttu-id="c08db-123">例如，可使用 Service 类的 <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> 属性来设置 <xref:System.ServiceModel.ServiceBehaviorAttribute.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> 属性。</span><span class="sxs-lookup"><span data-stu-id="c08db-123">For example, you can set the <xref:System.Runtime.Serialization.DataContractSerializer.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property using the <xref:System.ServiceModel.ServiceBehaviorAttribute.MaxItemsInObjectGraph%2A?displayProperty=nameWithType> property on the service class.</span></span>

> [!NOTE]
> <span data-ttu-id="c08db-124">如果你有特定的问题，则应首先阅读 [WCF 疑难解答快速入门](wcf-troubleshooting-quickstart.md) ，以了解你的问题 (和) 是否列出了解决方案。</span><span class="sxs-lookup"><span data-stu-id="c08db-124">If you have a particular problem, you should first read the [WCF Troubleshooting Quickstart](wcf-troubleshooting-quickstart.md) to see whether your problem (and a solution) is listed there.</span></span>

 <span data-ttu-id="c08db-125">[用于数据的安全注意事项](./feature-details/security-considerations-for-data.md)中列出了限制序列化进程的属性。</span><span class="sxs-lookup"><span data-stu-id="c08db-125">Properties that restrict serialization processes are listed in [Security Considerations for Data](./feature-details/security-considerations-for-data.md).</span></span> <span data-ttu-id="c08db-126">限制与传输相关的资源消耗的属性列在 " [传输配额](./feature-details/transport-quotas.md)" 中。</span><span class="sxs-lookup"><span data-stu-id="c08db-126">Properties that restrict the consumption of resources related to transports are listed in [Transport Quotas](./feature-details/transport-quotas.md).</span></span> <span data-ttu-id="c08db-127">限制应用程序层的资源使用的属性是 <xref:System.ServiceModel.Dispatcher.ServiceThrottle> 类的成员。</span><span class="sxs-lookup"><span data-stu-id="c08db-127">Properties that restrict the consumption of resources at the application layer are the members of the <xref:System.ServiceModel.Dispatcher.ServiceThrottle> class.</span></span>

## <a name="detecting-application-and-performance-issues-related-to-quota-settings"></a><span data-ttu-id="c08db-128">检测与配额设置有关的应用程序和性能问题</span><span class="sxs-lookup"><span data-stu-id="c08db-128">Detecting Application and Performance Issues Related to Quota Settings</span></span>

 <span data-ttu-id="c08db-129">为了在各种应用程序类型中启用基本的应用程序功能，同时针对常见安全问题提供基本保护，系统选择了上述值的默认值。</span><span class="sxs-lookup"><span data-stu-id="c08db-129">The defaults of the preceding values have been chosen to enable basic application functionality across a wide range of application types while providing basic protection against common security issues.</span></span> <span data-ttu-id="c08db-130">但是，不同的应用程序设计可能会超出一个或多个控制器设置，不过可以通过其他手段保护应用程序的安全，并使应用程序按照设计的方式工作。</span><span class="sxs-lookup"><span data-stu-id="c08db-130">However, different application designs might exceed one or more throttle settings although the application otherwise is secure and would work as designed.</span></span> <span data-ttu-id="c08db-131">在这些情况下，必须识别出超过的是哪些控制器值，是在哪一级别超过的，并确定适当的操作过程来提高应用程序的吞吐量。</span><span class="sxs-lookup"><span data-stu-id="c08db-131">In these cases, you must identify which throttle values are being exceeded and at what level, and decide on the appropriate course of action to increase application throughput.</span></span>

 <span data-ttu-id="c08db-132">通常，当编写并调试应用程序时，应当在配置文件中或者以编程方式将 <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="c08db-132">Typically, when writing the application and debugging it, you set the <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property to `true` in the configuration file or programmatically.</span></span> <span data-ttu-id="c08db-133">这会指示 WCF 将服务异常堆栈跟踪返回到客户端应用程序以供查看。</span><span class="sxs-lookup"><span data-stu-id="c08db-133">This instructs WCF to return service exception stack traces to the client application for viewing.</span></span> <span data-ttu-id="c08db-134">此功能可报告大多数的应用程序级异常，旨在显示导致出现问题的相关配额设置。</span><span class="sxs-lookup"><span data-stu-id="c08db-134">This feature reports most application-level exceptions in such a way as to display which quota settings might be involved, if that is the problem.</span></span>

 <span data-ttu-id="c08db-135">一些异常是在运行时发生的，在应用程序层不可见。它们不是使用此机制返回的，并且不能由自定义 <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> 实现来处理。</span><span class="sxs-lookup"><span data-stu-id="c08db-135">Some exceptions happen at run time below the visibility of the application layer and are not returned using this mechanism, and they might not be handled by a custom <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> implementation.</span></span> <span data-ttu-id="c08db-136">如果您使用的是像 Microsoft Visual Studio 这样的开发环境，则这些异常中的大多数都将自动显示。</span><span class="sxs-lookup"><span data-stu-id="c08db-136">If you are in a development environment like Microsoft Visual Studio, most of these exceptions are displayed automatically.</span></span> <span data-ttu-id="c08db-137">但是，某些异常可能会被开发环境设置屏蔽，如 [仅我的代码](/visualstudio/debugger/just-my-code) Visual Studio。</span><span class="sxs-lookup"><span data-stu-id="c08db-137">However, some exceptions can be masked by development environment settings such as [Just My Code](/visualstudio/debugger/just-my-code) Visual Studio.</span></span>

 <span data-ttu-id="c08db-138">不管开发环境的功能如何，你都可以使用 WCF 跟踪和消息日志记录功能来调试所有异常并调整应用程序的性能。</span><span class="sxs-lookup"><span data-stu-id="c08db-138">Regardless of the capabilities of your development environment, you can use capabilities of WCF tracing and message logging to debug all exceptions and tune the performance of your applications.</span></span> <span data-ttu-id="c08db-139">有关详细信息，请参阅 [使用跟踪对应用程序进行故障排除](./diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md)。</span><span class="sxs-lookup"><span data-stu-id="c08db-139">For more information, see [Using Tracing to Troubleshoot Your Application](./diagnostics/tracing/using-tracing-to-troubleshoot-your-application.md).</span></span>

## <a name="performance-issues-and-xmlserializer"></a><span data-ttu-id="c08db-140">性能问题和 XmlSerializer</span><span class="sxs-lookup"><span data-stu-id="c08db-140">Performance Issues and XmlSerializer</span></span>

 <span data-ttu-id="c08db-141">如果服务和客户端应用程序使用可用 <xref:System.Xml.Serialization.XmlSerializer> 进行序列化的数据类型，则会在运行时生成并编译这些数据类型的序列化代码，从而导致启动性能降低。</span><span class="sxs-lookup"><span data-stu-id="c08db-141">Services and client applications that use data types that are serializable using the <xref:System.Xml.Serialization.XmlSerializer> generate and compile serialization code for those data types at run time, which can result in slow start-up performance.</span></span>

> [!NOTE]
> <span data-ttu-id="c08db-142">预生成的序列化代码只能在客户端应用程序中使用，不能在服务中使用。</span><span class="sxs-lookup"><span data-stu-id="c08db-142">Pre-generated serialization code can be used only in client applications and not in services.</span></span>

 <span data-ttu-id="c08db-143">通过从应用程序的编译的程序集生成必要的序列化代码， [ ( # A0) ](servicemodel-metadata-utility-tool-svcutil-exe.md) 可提高这些应用程序的启动性能。</span><span class="sxs-lookup"><span data-stu-id="c08db-143">The [ServiceModel Metadata Utility Tool (Svcutil.exe)](servicemodel-metadata-utility-tool-svcutil-exe.md) can improve start-up performance for these applications by generating the necessary serialization code from the compiled assemblies for the application.</span></span> <span data-ttu-id="c08db-144">有关详细信息，请参阅 [如何：使用 XmlSerializer 改善 WCF 客户端应用程序的启动时间](./feature-details/startup-time-of-wcf-client-applications-using-the-xmlserializer.md)。</span><span class="sxs-lookup"><span data-stu-id="c08db-144">For more information, see [How to: Improve the Startup Time of WCF Client Applications using the XmlSerializer](./feature-details/startup-time-of-wcf-client-applications-using-the-xmlserializer.md).</span></span>

## <a name="performance-issues-when-hosting-wcf-services-under-aspnet"></a><span data-ttu-id="c08db-145">在 ASP.NET 下承载 WCF 服务时的性能问题</span><span class="sxs-lookup"><span data-stu-id="c08db-145">Performance Issues When Hosting WCF Services Under ASP.NET</span></span>

<span data-ttu-id="c08db-146">当在 IIS 和 ASP.NET 下承载 WCF 服务时，IIS 和 ASP.NET 的配置设置可能会影响 WCF 服务的吞吐量和内存需求量。</span><span class="sxs-lookup"><span data-stu-id="c08db-146">When a WCF service is hosted under IIS and ASP.NET, the configuration settings of IIS and ASP.NET can affect the throughput and memory footprint of the WCF service.</span></span>  <span data-ttu-id="c08db-147">有关 ASP.NET 性能的详细信息，请参阅 [改善 ASP.NET 性能](/previous-versions/msp-n-p/ff647787(v=pandp.10))。</span><span class="sxs-lookup"><span data-stu-id="c08db-147">For more information about ASP.NET performance, see [Improving ASP.NET Performance](/previous-versions/msp-n-p/ff647787(v=pandp.10)).</span></span> <span data-ttu-id="c08db-148">可能具有意外结果的一种设置为 <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A>，该设置为 <xref:System.Web.Configuration.ProcessModelSection> 的属性。</span><span class="sxs-lookup"><span data-stu-id="c08db-148">One setting that might have unintended consequences is <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A>, which is a property of the <xref:System.Web.Configuration.ProcessModelSection>.</span></span> <span data-ttu-id="c08db-149">如果应用程序具有固定量或少量的客户端，则将 <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A> 设置为 2 可能会显著提高 CPU 利用率接近 100% 的多处理器计算机上的吞吐量。</span><span class="sxs-lookup"><span data-stu-id="c08db-149">If your application has a fixed or small number of clients, setting <xref:System.Web.Configuration.ProcessModelSection.MinWorkerThreads%2A> to 2 might provide a throughput boost on a multiprocessor machine that has a CPU utilization close to 100%.</span></span> <span data-ttu-id="c08db-150">这种性能上的提高是以增加内存使用为代价的，这可能会降低可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="c08db-150">This increase in performance comes with a cost: it will also cause an increase in memory usage, which could reduce scalability.</span></span>

## <a name="see-also"></a><span data-ttu-id="c08db-151">请参阅</span><span class="sxs-lookup"><span data-stu-id="c08db-151">See also</span></span>

- [<span data-ttu-id="c08db-152">管理和诊断</span><span class="sxs-lookup"><span data-stu-id="c08db-152">Administration and Diagnostics</span></span>](./diagnostics/index.md)
- [<span data-ttu-id="c08db-153">大型数据和流</span><span class="sxs-lookup"><span data-stu-id="c08db-153">Large Data and Streaming</span></span>](./feature-details/large-data-and-streaming.md)

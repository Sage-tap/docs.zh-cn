---
title: 集中式配置
description: 使用 Azure 应用配置和 AzureKey 保管库集中使用云本机应用程序的配置。
ms.date: 01/19/2021
ms.openlocfilehash: 770c0c19a6de01250c59a586badb6a4afa2e9ae5
ms.sourcegitcommit: f2ab02d9a780819ca2e5310bbcf5cfe5b7993041
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/03/2021
ms.locfileid: "99505708"
---
# <a name="centralized-configuration"></a><span data-ttu-id="31e35-103">集中式配置</span><span class="sxs-lookup"><span data-stu-id="31e35-103">Centralized configuration</span></span>

<span data-ttu-id="31e35-104">不同于单个应用，其中的所有内容都在单个实例中运行，云本机应用程序由跨虚拟机、容器和地理区域分布的独立服务构成。</span><span class="sxs-lookup"><span data-stu-id="31e35-104">Unlike a monolithic app in which everything runs within a single instance, a cloud-native application consists of independent services distributed across virtual machines, containers, and geographic regions.</span></span> <span data-ttu-id="31e35-105">管理数十个相互依赖的服务的配置设置可能非常困难。</span><span class="sxs-lookup"><span data-stu-id="31e35-105">Managing configuration settings for dozens of interdependent services can be challenging.</span></span> <span data-ttu-id="31e35-106">不同位置上的配置设置重复的副本容易出错并且难于管理。</span><span class="sxs-lookup"><span data-stu-id="31e35-106">Duplicate copies of configuration settings across different locations are error prone and difficult to manage.</span></span> <span data-ttu-id="31e35-107">集中式配置是分布式云本机应用程序的关键要求。</span><span class="sxs-lookup"><span data-stu-id="31e35-107">Centralized configuration is a critical requirement for distributed cloud-native applications.</span></span>

<span data-ttu-id="31e35-108">如 [第1章](introduction.md)所述，Twelve-Factor 应用建议要求严格分隔代码和配置。</span><span class="sxs-lookup"><span data-stu-id="31e35-108">As discussed in [Chapter 1](introduction.md), the Twelve-Factor App recommendations require strict separation between code and configuration.</span></span> <span data-ttu-id="31e35-109">必须根据需要从应用程序外部存储配置并进行读取。</span><span class="sxs-lookup"><span data-stu-id="31e35-109">Configuration must be stored externally from the application and read-in as needed.</span></span> <span data-ttu-id="31e35-110">将配置值存储为代码中的常量或文本值是一个冲突。</span><span class="sxs-lookup"><span data-stu-id="31e35-110">Storing configuration values as constants or literal values in code is a violation.</span></span> <span data-ttu-id="31e35-111">同一应用程序中的许多服务通常使用相同的配置值。</span><span class="sxs-lookup"><span data-stu-id="31e35-111">The same configuration values are often be used by many services in the same application.</span></span> <span data-ttu-id="31e35-112">此外，我们必须跨多个环境（如开发、测试和生产）支持相同的值。</span><span class="sxs-lookup"><span data-stu-id="31e35-112">Additionally, we must support the same values across multiple environments, such as dev, testing, and production.</span></span> <span data-ttu-id="31e35-113">最佳做法是将它们存储在集中式配置存储中。</span><span class="sxs-lookup"><span data-stu-id="31e35-113">The best practice is store them in a centralized configuration store.</span></span>

<span data-ttu-id="31e35-114">Azure 云提供了几个不错的选项。</span><span class="sxs-lookup"><span data-stu-id="31e35-114">The Azure cloud presents several great options.</span></span>

## <a name="azure-app-configuration"></a><span data-ttu-id="31e35-115">Azure 应用配置</span><span class="sxs-lookup"><span data-stu-id="31e35-115">Azure App Configuration</span></span>

<span data-ttu-id="31e35-116">[Azure 应用配置](/azure/azure-app-configuration/overview) 是一项完全托管的 Azure 服务，可将非机密配置设置存储在一个安全的集中位置。</span><span class="sxs-lookup"><span data-stu-id="31e35-116">[Azure App Configuration](/azure/azure-app-configuration/overview) is a fully managed Azure service that stores non-secret configuration settings in a secure, centralized location.</span></span> <span data-ttu-id="31e35-117">存储的值可以在多个服务和应用程序之间共享。</span><span class="sxs-lookup"><span data-stu-id="31e35-117">Stored values can be shared among multiple services and applications.</span></span>

<span data-ttu-id="31e35-118">此服务易于使用，并提供了若干优点：</span><span class="sxs-lookup"><span data-stu-id="31e35-118">The service is simple to use and provides several benefits:</span></span>

- <span data-ttu-id="31e35-119">灵活键/值表示和映射</span><span class="sxs-lookup"><span data-stu-id="31e35-119">Flexible key/value representations and mappings</span></span>
- <span data-ttu-id="31e35-120">用 Azure 标签标记</span><span class="sxs-lookup"><span data-stu-id="31e35-120">Tagging with Azure labels</span></span>
- <span data-ttu-id="31e35-121">用于管理的专用 UI</span><span class="sxs-lookup"><span data-stu-id="31e35-121">Dedicated UI for management</span></span>
- <span data-ttu-id="31e35-122">敏感信息的加密</span><span class="sxs-lookup"><span data-stu-id="31e35-122">Encryption of sensitive information</span></span>
- <span data-ttu-id="31e35-123">查询和批量检索</span><span class="sxs-lookup"><span data-stu-id="31e35-123">Querying and batch retrieval</span></span>

<span data-ttu-id="31e35-124">Azure 应用配置维护7天对键值设置所做的更改。</span><span class="sxs-lookup"><span data-stu-id="31e35-124">Azure App Configuration maintains changes made to key-value settings for seven days.</span></span> <span data-ttu-id="31e35-125">使用时间点快照功能，您可以重新构造设置的历史记录，甚至可以为失败的部署进行回滚。</span><span class="sxs-lookup"><span data-stu-id="31e35-125">The point-in-time snapshot feature enables you to reconstruct the history of a setting and even rollback for a failed deployment.</span></span>

<span data-ttu-id="31e35-126">应用配置会自动缓存每个设置，以避免过多调用配置存储。</span><span class="sxs-lookup"><span data-stu-id="31e35-126">App Configuration automatically caches each setting to avoid excessive calls to the configuration store.</span></span> <span data-ttu-id="31e35-127">刷新操作会等待，直到某项设置的已缓存值过期才更新该设置，即使其值在配置存储中发生了更改。</span><span class="sxs-lookup"><span data-stu-id="31e35-127">The refresh operation waits until the cached value of a setting expires to update that setting, even when its value changes in the configuration store.</span></span> <span data-ttu-id="31e35-128">默认缓存过期时间为 30 秒。</span><span class="sxs-lookup"><span data-stu-id="31e35-128">The default cache expiration time is 30 seconds.</span></span> <span data-ttu-id="31e35-129">可以覆盖过期时间。</span><span class="sxs-lookup"><span data-stu-id="31e35-129">You can override the expiration time.</span></span>

<span data-ttu-id="31e35-130">应用配置对传输中和静态的所有配置值进行加密。</span><span class="sxs-lookup"><span data-stu-id="31e35-130">App Configuration encrypts all configuration values in transit and at rest.</span></span> <span data-ttu-id="31e35-131">键名称和标签充当检索配置数据的索引，且不进行加密。</span><span class="sxs-lookup"><span data-stu-id="31e35-131">Key names and labels are used as indexes for retrieving configuration data and aren't encrypted.</span></span>

<span data-ttu-id="31e35-132">尽管应用配置提供强化的安全性，但 Azure Key Vault 仍是存储应用程序机密的最佳位置。</span><span class="sxs-lookup"><span data-stu-id="31e35-132">Although App Configuration provides hardened security, Azure Key Vault is still the best place for storing application secrets.</span></span> <span data-ttu-id="31e35-133">Key Vault 提供硬件级加密、粒度访问策略和管理操作（如证书轮换）。</span><span class="sxs-lookup"><span data-stu-id="31e35-133">Key Vault provides hardware-level encryption, granular access policies, and management operations such as certificate rotation.</span></span> <span data-ttu-id="31e35-134">你可以创建引用存储在 Key Vault 中的密钥的应用配置值。</span><span class="sxs-lookup"><span data-stu-id="31e35-134">You can create App Configuration values that reference secrets stored in a Key Vault.</span></span>

## <a name="azure-key-vault"></a><span data-ttu-id="31e35-135">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="31e35-135">Azure Key Vault</span></span>

<span data-ttu-id="31e35-136">Key Vault 是一种托管服务，用于安全地存储和访问机密。</span><span class="sxs-lookup"><span data-stu-id="31e35-136">Key Vault is a managed service for securely storing and accessing secrets.</span></span> <span data-ttu-id="31e35-137">机密是你希望严格控制对其的访问的任何东西，例如 API 密钥、密码或证书。</span><span class="sxs-lookup"><span data-stu-id="31e35-137">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="31e35-138">保管库是机密的逻辑组。</span><span class="sxs-lookup"><span data-stu-id="31e35-138">A vault is a logical group of secrets.</span></span>

<span data-ttu-id="31e35-139">Key Vault 可以大大减少机密意外泄露的可能性。</span><span class="sxs-lookup"><span data-stu-id="31e35-139">Key Vault greatly reduces the chances that secrets may be accidentally leaked.</span></span> <span data-ttu-id="31e35-140">有了 Key Vault，应用程序开发人员就再也不需要将安全信息存储在应用程序中。</span><span class="sxs-lookup"><span data-stu-id="31e35-140">When using Key Vault, application developers no longer need to store security information in their application.</span></span> <span data-ttu-id="31e35-141">这种做法无需在代码中存储此信息。</span><span class="sxs-lookup"><span data-stu-id="31e35-141">This practice eliminates the need to store this information inside your code.</span></span> <span data-ttu-id="31e35-142">例如，如果某个应用程序需要连接到数据库，</span><span class="sxs-lookup"><span data-stu-id="31e35-142">For example, an application may need to connect to a database.</span></span> <span data-ttu-id="31e35-143">则可将连接字符串安全地存储在 Key Vault 中，而不是存储在应用代码中。</span><span class="sxs-lookup"><span data-stu-id="31e35-143">Instead of storing the connection string in the app's code, you can store it securely in Key Vault.</span></span>

<span data-ttu-id="31e35-144">应用程序可以使用 URI 安全访问其所需的信息。</span><span class="sxs-lookup"><span data-stu-id="31e35-144">Your applications can securely access the information they need by using URIs.</span></span> <span data-ttu-id="31e35-145">这些 URI 允许应用程序检索特定版本的机密。</span><span class="sxs-lookup"><span data-stu-id="31e35-145">These URIs allow the applications to retrieve specific versions of a secret.</span></span> <span data-ttu-id="31e35-146">无需编写自定义代码来保护 Key Vault 中存储的任何机密信息。</span><span class="sxs-lookup"><span data-stu-id="31e35-146">There's no need to write custom code to protect any of the secret information stored in Key Vault.</span></span>

<span data-ttu-id="31e35-147">访问 Key Vault 需要正确的调用方身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="31e35-147">Access to Key Vault requires proper caller authentication and authorization.</span></span> <span data-ttu-id="31e35-148">通常，每个云本机微服务使用 ClientId/ClientSecret 组合。</span><span class="sxs-lookup"><span data-stu-id="31e35-148">Typically, each cloud-native microservice uses a ClientId/ClientSecret combination.</span></span> <span data-ttu-id="31e35-149">将这些凭据保留在源代码管理范围内是非常重要的。</span><span class="sxs-lookup"><span data-stu-id="31e35-149">It's important to keep these credentials outside source control.</span></span> <span data-ttu-id="31e35-150">最佳做法是在应用程序的环境中对其进行设置。</span><span class="sxs-lookup"><span data-stu-id="31e35-150">A best practice is to set them in  the application's environment.</span></span> <span data-ttu-id="31e35-151">使用 [Key Vault FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol)可以实现从 AKS 的直接访问 Key Vault。</span><span class="sxs-lookup"><span data-stu-id="31e35-151">Direct access to Key Vault from AKS can be achieved using [Key Vault FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol).</span></span>

## <a name="configuration-in-eshop"></a><span data-ttu-id="31e35-152">EShop 中的配置</span><span class="sxs-lookup"><span data-stu-id="31e35-152">Configuration in eShop</span></span>

<span data-ttu-id="31e35-153">EShopOnContainers 应用程序包含每个微服务的本地应用程序设置文件。</span><span class="sxs-lookup"><span data-stu-id="31e35-153">The eShopOnContainers application includes local application settings files with each microservice.</span></span> <span data-ttu-id="31e35-154">这些文件签入到源代码管理中，但不包括诸如连接字符串或 API 密钥之类的生产机密。</span><span class="sxs-lookup"><span data-stu-id="31e35-154">These files are checked into source control, but don't include production secrets such as connection strings or API keys.</span></span> <span data-ttu-id="31e35-155">在生产环境中，可能会覆盖每个服务环境变量的各个设置。</span><span class="sxs-lookup"><span data-stu-id="31e35-155">In production, individual settings may be overwritten with per-service environment variables.</span></span> <span data-ttu-id="31e35-156">在环境变量中注入机密是对托管应用程序的一种常见做法，但并不提供中央配置存储。</span><span class="sxs-lookup"><span data-stu-id="31e35-156">Injecting secrets in environment variables is a common practice for hosted applications, but doesn't provide a central configuration store.</span></span> <span data-ttu-id="31e35-157">为了支持集中管理的配置设置，每个微服务都包含一个设置以在其使用本地设置或 Azure Key Vault 设置之间切换。</span><span class="sxs-lookup"><span data-stu-id="31e35-157">To support centralized management of configuration settings, each microservice includes a setting to toggle between its use of local settings or Azure Key Vault settings.</span></span>

## <a name="references"></a><span data-ttu-id="31e35-158">参考</span><span class="sxs-lookup"><span data-stu-id="31e35-158">References</span></span>

- [<span data-ttu-id="31e35-159">EShopOnContainers 体系结构</span><span class="sxs-lookup"><span data-stu-id="31e35-159">The eShopOnContainers Architecture</span></span>](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Architecture)
- [<span data-ttu-id="31e35-160">协调安排微服务和多容器应用程序，实现高可伸缩性和高可用性</span><span class="sxs-lookup"><span data-stu-id="31e35-160">Orchestrating microservices and multi-container applications for high scalability and availability</span></span>](../microservices/architect-microservice-container-applications/scalable-available-multi-container-microservice-applications.md)
- [<span data-ttu-id="31e35-161">Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="31e35-161">Azure API Management</span></span>](/azure/api-management/api-management-key-concepts)
- [<span data-ttu-id="31e35-162">Azure SQL 数据库概述</span><span class="sxs-lookup"><span data-stu-id="31e35-162">Azure SQL Database Overview</span></span>](/azure/sql-database/sql-database-technical-overview)
- [<span data-ttu-id="31e35-163">用于 Redis 的 Azure 缓存</span><span class="sxs-lookup"><span data-stu-id="31e35-163">Azure Cache for Redis</span></span>](https://azure.microsoft.com/services/cache/)
- [<span data-ttu-id="31e35-164">Azure Cosmos DB 的 API for MongoDB</span><span class="sxs-lookup"><span data-stu-id="31e35-164">Azure Cosmos DB's API for MongoDB</span></span>](/azure/cosmos-db/mongodb-introduction)
- [<span data-ttu-id="31e35-165">Azure 服务总线</span><span class="sxs-lookup"><span data-stu-id="31e35-165">Azure Service Bus</span></span>](/azure/service-bus-messaging/service-bus-messaging-overview)
- [<span data-ttu-id="31e35-166">Azure Monitor 概述</span><span class="sxs-lookup"><span data-stu-id="31e35-166">Azure Monitor overview</span></span>](/azure/azure-monitor/overview)
- <span data-ttu-id="31e35-167">[eShopOnContainers：在 AKS 中创建 Kubernetes 群集](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#create-kubernetes-cluster-in-aks)</span><span class="sxs-lookup"><span data-stu-id="31e35-167">[eShopOnContainers: Create Kubernetes cluster in AKS](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#create-kubernetes-cluster-in-aks)</span></span>
- [<span data-ttu-id="31e35-168">eShopOnContainers： Azure Dev Spaces</span><span class="sxs-lookup"><span data-stu-id="31e35-168">eShopOnContainers: Azure Dev Spaces</span></span>](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Azure-Dev-Spaces)
- [<span data-ttu-id="31e35-169">Azure Dev Spaces</span><span class="sxs-lookup"><span data-stu-id="31e35-169">Azure Dev Spaces</span></span>](/azure/dev-spaces/about)

>[!div class="step-by-step"]
><span data-ttu-id="31e35-170">[上一页](deploy-eshoponcontainers-azure.md)
>[下一页](scale-applications.md)</span><span class="sxs-lookup"><span data-stu-id="31e35-170">[Previous](deploy-eshoponcontainers-azure.md)
[Next](scale-applications.md)</span></span>

---
description: 了解详细信息：联合身份验证和信任关系
title: 联合与信任
ms.date: 03/30/2017
helpviewer_keywords:
- federation [WCF], and trust
ms.assetid: 4bdec4f2-f8a2-4512-bdcf-14ef54b5877a
ms.openlocfilehash: ccacb38f9542fab5522331d53dc29792318c5dea
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/06/2021
ms.locfileid: "99802939"
---
# <a name="federation-and-trust"></a><span data-ttu-id="ebb20-103">联合与信任</span><span class="sxs-lookup"><span data-stu-id="ebb20-103">Federation and Trust</span></span>

<span data-ttu-id="ebb20-104">本主题介绍与联合应用程序相关的各个方面、信任边界和配置，以及如何在 Windows Communication Foundation (WCF) 中使用已颁发的令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-104">This topic covers various aspects related to federated applications, trust boundaries and configuration, and use of issued tokens in Windows Communication Foundation (WCF).</span></span>  
  
## <a name="services-security-token-services-and-trust"></a><span data-ttu-id="ebb20-105">服务、安全令牌服务和信任</span><span class="sxs-lookup"><span data-stu-id="ebb20-105">Services, Security Token Services, and Trust</span></span>  

 <span data-ttu-id="ebb20-106">公开联合终结点的服务通常期望客户端使用特定颁发机构提供的令牌进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="ebb20-106">Services that expose federated endpoints typically expect clients to authenticate using a token provided by a specific issuer.</span></span> <span data-ttu-id="ebb20-107">使用颁发机构的正确凭据来配置服务很重要；否则，将无法通过颁发的令牌来验证签名，客户端也将无法与服务通信。</span><span class="sxs-lookup"><span data-stu-id="ebb20-107">It is important that the service is configured with the correct credentials for the issuer; otherwise, it will not be able to verify signatures over the issued tokens, and the client will be unable to communicate with the service.</span></span> <span data-ttu-id="ebb20-108">有关如何在服务上配置颁发者凭据的详细信息，请参阅 [如何：在联合身份验证服务上配置凭据](how-to-configure-credentials-on-a-federation-service.md)。</span><span class="sxs-lookup"><span data-stu-id="ebb20-108">For more information about configuring issuer credentials on the service, see [How to: Configure Credentials on a Federation Service](how-to-configure-credentials-on-a-federation-service.md).</span></span>  
  
 <span data-ttu-id="ebb20-109">同样，使用对称密钥时，密钥是针对目标服务加密的，因此，必须使用目标服务的正确凭据来配置安全令牌服务；否则，将无法针对目标服务加密密钥，客户端也将无法与服务通信。</span><span class="sxs-lookup"><span data-stu-id="ebb20-109">Similarly, when using symmetric keys, the keys are encrypted for the target service, so you must configure the security token service with the correct credentials for the target service; otherwise, it will be unable to encrypt the key for the target service, and again, the client will be unable to communicate with the service.</span></span>  
  
 <span data-ttu-id="ebb20-110">WCF 服务使用 <xref:System.ServiceModel.Channels.LocalServiceSecuritySettings.MaxClockSkew%2A> [SecurityBindingElement](../diagnostics/wmi/securitybindingelement.md) 上的属性的值，以允许客户端和服务之间的时钟偏差。</span><span class="sxs-lookup"><span data-stu-id="ebb20-110">WCF services use the value of the <xref:System.ServiceModel.Channels.LocalServiceSecuritySettings.MaxClockSkew%2A> property on the [SecurityBindingElement](../diagnostics/wmi/securitybindingelement.md) to allow for clock skew between the client and service.</span></span> <span data-ttu-id="ebb20-111">在联合中，`MaxClockSkew` 设置应用于客户端与客户端从中获得颁发的令牌的安全令牌服务之间的时钟偏差。</span><span class="sxs-lookup"><span data-stu-id="ebb20-111">In federation, the `MaxClockSkew` setting applies to clock skews between both the client and the security token service from where the client obtained the issued token.</span></span> <span data-ttu-id="ebb20-112">因此，在设置颁发的令牌的有效时间和过期时间时，安全令牌服务不需要进行时钟偏差许可。</span><span class="sxs-lookup"><span data-stu-id="ebb20-112">Therefore, security token services need not make clock-skew allowances when setting the issued token's effective and expiration times.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ebb20-113">时钟偏差的重要性随颁发的令牌的生存期的缩短而增加。</span><span class="sxs-lookup"><span data-stu-id="ebb20-113">The importance of clock skew increases as the lifetime of the issued token shortens.</span></span> <span data-ttu-id="ebb20-114">在大多数情况下，如果令牌生存期为 30 分钟或更长，则时钟偏差不是一个重要问题。</span><span class="sxs-lookup"><span data-stu-id="ebb20-114">In most cases, clock skew is not a significant issue if the token lifetime is 30 minutes or more.</span></span> <span data-ttu-id="ebb20-115">如果生存期更短或令牌的确切有效时间非常重要，则在设计时应考虑时钟偏差。</span><span class="sxs-lookup"><span data-stu-id="ebb20-115">Scenarios with shorter lifetimes or where the exact validity time of the token is important should be designed to take clock skew into account.</span></span>  
  
## <a name="federated-endpoints-and-time-outs"></a><span data-ttu-id="ebb20-116">联合终结点和超时</span><span class="sxs-lookup"><span data-stu-id="ebb20-116">Federated Endpoints and Time-Outs</span></span>  

 <span data-ttu-id="ebb20-117">客户端与联合终结点通信时，必须首先从安全令牌服务处获取适当的令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-117">When a client communicates with a federated endpoint, it must first acquire an appropriate token from a security token service.</span></span> <span data-ttu-id="ebb20-118">如果安全令牌服务公开一个联合终结点，则客户端必须首先从该终结点的颁发机构处获得令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-118">If the security token service exposes a federated endpoint, the client must first obtain a token from the issuer for that endpoint.</span></span> <span data-ttu-id="ebb20-119">每次获得令牌都需要时间，而时间取决于向最终终结点发送实际消息的整体超时。</span><span class="sxs-lookup"><span data-stu-id="ebb20-119">Each token acquisition takes time, and that time is subject to the overall time-out for sending the actual message to the final endpoint.</span></span>  
  
 <span data-ttu-id="ebb20-120">例如，客户端通道的超时值设置为 30 秒。</span><span class="sxs-lookup"><span data-stu-id="ebb20-120">For example, the time-out on the client-side channel is set to 30 seconds.</span></span> <span data-ttu-id="ebb20-121">在向最终终结点发送消息之前，需要调用两个令牌颁发机构来检索令牌，因此，每个颁发机构有 15 秒钟来颁发令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-121">Two token issuers need to be called to retrieve tokens before sending the message to the final endpoint, and each takes 15 seconds to issue a token.</span></span> <span data-ttu-id="ebb20-122">这种情况下，尝试将失败，并引发 <xref:System.TimeoutException>。</span><span class="sxs-lookup"><span data-stu-id="ebb20-122">In this case, the attempt will fail and a <xref:System.TimeoutException> is thrown.</span></span> <span data-ttu-id="ebb20-123">因此，需要将客户端通道的 <xref:System.ServiceModel.IContextChannel.OperationTimeout%2A> 值设置为一个足够大的值，以便有时间检索所有颁发的令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-123">Thus, you need to set the <xref:System.ServiceModel.IContextChannel.OperationTimeout%2A> value on the client channel to a value large enough to include the time taken to retrieve all issued tokens.</span></span> <span data-ttu-id="ebb20-124">如果没有为 <xref:System.ServiceModel.IContextChannel.OperationTimeout%2A> 属性指定一个值，则需要将 <xref:System.ServiceModel.Channels.Binding.OpenTimeout%2A> 属性和/或 <xref:System.ServiceModel.Channels.Binding.SendTimeout%2A> 属性设置为一个足够大的值，以便有时间检索所有颁发的令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-124">In the case where a value is not specified for the <xref:System.ServiceModel.IContextChannel.OperationTimeout%2A> property, the <xref:System.ServiceModel.Channels.Binding.OpenTimeout%2A> property or the <xref:System.ServiceModel.Channels.Binding.SendTimeout%2A> property (or both) need to be set to a value large enough to include the time taken to retrieve all issued tokens.</span></span>  
  
## <a name="token-lifetime-and-renewal"></a><span data-ttu-id="ebb20-125">令牌生存期和续订</span><span class="sxs-lookup"><span data-stu-id="ebb20-125">Token Lifetime and Renewal</span></span>  

 <span data-ttu-id="ebb20-126">在向服务发出初始请求时，WCF 客户端不会检查已颁发的令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-126">WCF clients do not check the issued token when making an initial request to a service.</span></span>  <span data-ttu-id="ebb20-127">相反，WCF 信任 security token service 以便使用适当的有效和过期时间颁发令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-127">Rather, WCF trusts the security token service to issue a token with appropriate effective and expiration times.</span></span> <span data-ttu-id="ebb20-128">如果客户端缓存并重用令牌，则会在后续请求时检查令牌生存期，如有必要，客户端会自动续订令牌。</span><span class="sxs-lookup"><span data-stu-id="ebb20-128">If the token is cached by the client and reused, the token lifetime is checked on subsequent requests and the client automatically renews the token if necessary.</span></span> <span data-ttu-id="ebb20-129">有关令牌缓存的详细信息，请参阅 [如何：创建联合客户端](how-to-create-a-federated-client.md)。</span><span class="sxs-lookup"><span data-stu-id="ebb20-129">For more information about token caching, see [How to: Create a Federated Client](how-to-create-a-federated-client.md).</span></span>  
  
 <span data-ttu-id="ebb20-130">如果指定较短的生存期（对于颁发的令牌或安全上下文令牌，则为30秒或更低的顺序），则可能会导致在请求颁发的令牌或协商或续订安全上下文令牌时，WCF 客户端引发协商超时或其他异常。</span><span class="sxs-lookup"><span data-stu-id="ebb20-130">Specifying short lifetimes, on the order of 30 seconds or less for issued tokens or security context tokens, may result in negotiation time-outs or other exceptions being thrown by WCF clients when requesting issued tokens or when negotiating or renewing security context tokens.</span></span>  
  
## <a name="issued-tokens-and-inclusionmode"></a><span data-ttu-id="ebb20-131">颁发的令牌和 InclusionMode</span><span class="sxs-lookup"><span data-stu-id="ebb20-131">Issued Tokens and InclusionMode</span></span>  

 <span data-ttu-id="ebb20-132">在从客户端发送到联合终结点的消息中，是否对颁发的令牌进行序列化，是由 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InclusionMode%2A> 类的 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> 属性的设置控制的。</span><span class="sxs-lookup"><span data-stu-id="ebb20-132">Whether an issued token is serialized in a message sent from a client to a federated endpoint or not is controlled by setting the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InclusionMode%2A> property of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="ebb20-133">此属性可以设置为 <xref:System.ServiceModel.Security.Tokens.SecurityTokenInclusionMode> 枚举值之一，但它在大多数联合方案中并无用处。</span><span class="sxs-lookup"><span data-stu-id="ebb20-133">This property can be set to one of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenInclusionMode> enumeration values, but it is not useful in most federated scenarios.</span></span> <span data-ttu-id="ebb20-134">如果是 `SecurityTokenInclusionMode.Never` 和 `SecurityTokenInclusionMode.AlwaysToInitiator` 值，客户端会向安全令牌服务颁发给依赖方的令牌发送一个引用。</span><span class="sxs-lookup"><span data-stu-id="ebb20-134">The `SecurityTokenInclusionMode.Never` and `SecurityTokenInclusionMode.AlwaysToInitiator` values cause the client to send a reference to the token issued by the security token service to the relying party.</span></span> <span data-ttu-id="ebb20-135">除非依赖方拥有颁发的令牌的副本，否则会因令牌引用不可解析而导致身份验证失败。</span><span class="sxs-lookup"><span data-stu-id="ebb20-135">Unless the relying party possesses a copy of the issued token, authentication will fail because the token reference is not resolvable.</span></span> <span data-ttu-id="ebb20-136">WCF `SecurityTokenInclusionMode.Once` 将视为等效于 `SecurityTokenInclusionMode.AlwaysToRecipient` 。</span><span class="sxs-lookup"><span data-stu-id="ebb20-136">WCF treats `SecurityTokenInclusionMode.Once` as equivalent to `SecurityTokenInclusionMode.AlwaysToRecipient`.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ebb20-137">请参阅</span><span class="sxs-lookup"><span data-stu-id="ebb20-137">See also</span></span>

- <xref:System.ServiceModel.Security.Tokens.SecurityTokenInclusionMode>
- [<span data-ttu-id="ebb20-138">如何：创建联合客户端</span><span class="sxs-lookup"><span data-stu-id="ebb20-138">How to: Create a Federated Client</span></span>](how-to-create-a-federated-client.md)
- [<span data-ttu-id="ebb20-139">如何：在联合身份验证服务上配置凭据</span><span class="sxs-lookup"><span data-stu-id="ebb20-139">How to: Configure Credentials on a Federation Service</span></span>](how-to-configure-credentials-on-a-federation-service.md)
- [<span data-ttu-id="ebb20-140">如何：创建 WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="ebb20-140">How to: Create a WSFederationHttpBinding</span></span>](how-to-create-a-wsfederationhttpbinding.md)
